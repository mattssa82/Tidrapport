<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Sök & filtrera – Tidrapport</title>
<style>
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:#f5f7f8;margin:0;padding:1rem;color:#222;}
h1{font-size:1.1rem;color:#0e6677;margin-bottom:1rem;}
input,select{font-size:.9rem;padding:.4rem .6rem;border:1px solid #aaa;border-radius:.4rem;}
button{display:inline-flex;align-items:center;gap:.4rem;background:#0e6677;color:#fff;border:0;border-radius:.4rem;padding:.5rem .8rem;cursor:pointer;}
table{width:100%;border-collapse:collapse;margin-top:1rem;font-size:.85rem;}
th,td{border:1px solid #ccc;padding:.4rem .6rem;text-align:left;}
th{background:#ececec;}
.result-count{margin-top:.5rem;font-size:.9rem;color:#333;}
</style>
<script src="lucide.min.js"></script>
</head>
<body>
<h1><i data-lucide="search"></i> Sök och filtrera</h1>

<div class="filters">
  <label>År:
    <select id="yearFilter"></select>
  </label>
  <label>Projekt:
    <input type="text" id="projectFilter" placeholder="Projekt..." />
  </label>
  <label>Text:
    <input type="text" id="textFilter" placeholder="Sök text..." />
  </label>
  <button id="searchBtn"><i data-lucide="search"></i><span>Sök</span></button>
  <button id="exportBtn"><i data-lucide="file-spreadsheet"></i><span>Exportera CSV</span></button>
</div>

<div class="result-count" id="resultCount"></div>

<table id="resultTable">
  <thead>
    <tr>
      <th>Datum</th>
      <th>Projekt</th>
      <th>Kategori(er)</th>
      <th>Tid (h)</th>
      <th>Körtid (h)</th>
      <th>Dagboksanteckning</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const DATA_KEY="tidrapport_data_v10";
let allData=[];
document.addEventListener("DOMContentLoaded",()=>{
  lucide.createIcons();
  loadData();
  fillYearFilter();
  document.getElementById("searchBtn").addEventListener("click",runSearch);
  document.getElementById("exportBtn").addEventListener("click",exportResults);
});

function loadData(){
  try{allData=JSON.parse(localStorage.getItem(DATA_KEY)||"[]");}catch{allData=[];}
}
function fillYearFilter(){
  const ysel=document.getElementById("yearFilter");
  const years=new Set();
  const curY=new Date().getFullYear();
  years.add(curY);
  allData.forEach(r=>{
    if(!r.datum)return;
    years.add(new Date(r.datum).getFullYear());
  });
  ysel.innerHTML=[...years].sort((a,b)=>a-b).map(y=>`<option value="${y}" ${y===curY?"selected":""}>${y}</option>`).join("");
}

function runSearch(){
  const year=parseInt(document.getElementById("yearFilter").value,10);
  const proj=(document.getElementById("projectFilter").value||"").toLowerCase();
  const txt=(document.getElementById("textFilter").value||"").toLowerCase();
  const tbody=document.querySelector("#resultTable tbody");
  tbody.innerHTML="";
  const res=allData.filter(r=>{
    if(!r.datum)return false;
    const d=new Date(r.datum);
    if(d.getFullYear()!==year)return false;
    if(proj && !(r.projekt||"").toLowerCase().includes(proj))return false;
    const fullTxt=(r.kategori+" "+(r.beskrivning||"")).toLowerCase();
    if(txt && !fullTxt.includes(txt))return false;
    return true;
  });
  res.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.datum}</td>
      <td>${r.projekt||""}</td>
      <td>${r.kategori||""}</td>
      <td>${r.tid||""}</td>
      <td>${r.kortid||""}</td>
      <td>${(r.beskrivning||"").replace(/\r?\n/g," ")}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("resultCount").textContent=`${res.length} träffar.`;
  window.searchResults=res;
}

function exportResults(){
  const rows=window.searchResults||[];
  if(rows.length===0){alert("Inga träffar att exportera.");return;}
  const header=["Datum","Projekt","Kategori(er)","Tid (h)","Körtid (h)","Dagboksanteckning"];
  const csv=[header.join(";")];
  rows.forEach(r=>{
    const row=[r.datum||"",r.projekt||"",r.kategori||"",r.tid||"",r.kortid||"",(r.beskrivning||"").replace(/\r?\n/g," ")];
    csv.push(row.join(";"));
  });
  const csvContent="\uFEFF"+csv.join("\r\n");
  const blob=new Blob([csvContent],{type:"text/csv;charset=utf-16le;"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  const stamp=new Date().toISOString().replace(/[:.]/g,"-");
  a.download=`Tidrapport_sokresultat_${stamp}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}
</script>
</body>
</html>