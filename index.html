<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tidrapport</title>

  <meta name="theme-color" content="#0e6677" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-512.png" />

  <!-- Ikoner -->
  <script src="lucide.min.js"></script>

  <!-- jsPDF för PDF-export (samma som tidigare) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --brand:#0e6677;
      --accent:#0a515f;
      --bg:#f6f7f9;
      --card:#fff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;
      --danger:#b91c1c;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header {
      background:var(--brand);
      color:#fff;
      display:flex;
      align-items:center;
      gap:.6rem;
      padding:.8rem 1rem;
      position:sticky;
      top:0;
      z-index:10;
    }

    .iconbtn {
      width:40px;
      height:40px;
      border:none;
      border-radius:.5rem;
      background:var(--accent);
      color:#fff;
      display:grid;
      place-items:center;
      cursor:pointer;
    }

    h1 {
      margin:0;
      font-size:1.2rem;
      flex:1;
    }

    main {
      max-width:1100px;
      margin:auto;
      padding:1rem;
      display:grid;
      gap:1rem;
    }

    .card {
      background:var(--card);
      border:1px solid var(--line);
      padding:1rem;
      border-radius:.5rem;
    }

    label {
      font-size:.8rem;
      color:var(--muted);
      display:block;
      margin-top:.5rem;
    }

    input,select {
      width:100%;
      padding:.5rem;
      border:1px solid #cbd5e1;
      border-radius:.5rem;
      font-size:.95rem;
    }

    .form-inline-2col {
      display:flex;
      flex-wrap:wrap;
      gap:1rem;
    }
    .form-inline-2col > div {
      flex:1 1 200px;
      min-width:200px;
    }

    .actions-row {
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
      margin-top:1rem;
    }

    .btn {
      border:0;
      border-radius:.6rem;
      padding:.55rem .9rem;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.4rem;
      cursor:pointer;
      transition:all .15s ease-in-out;
      font-size:.9rem;
    }
    .btn i { width:1.1rem; height:1.1rem; }
    .btn.primary { background:var(--brand); color:#fff; }
    .btn.ghost   { background:#eef2f7; color:var(--text); }
    .btn.danger  { background:var(--danger); color:#fff; }
    .btn:hover   { transform:translateY(-1px); opacity:.95; }

    .table-container {
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }
    table {
      width:100%;
      border-collapse:collapse;
      font-size:.95rem;
      min-width:820px;
    }
    th, td {
      padding:.5rem;
      border-bottom:1px solid var(--line);
      text-align:left;
      vertical-align:top;
    }
    th {
      font-size:.7rem;
      color:var(--muted);
      text-transform:uppercase;
    }

    /* dynamiska kategori-rader */
    .catrow {
      display:flex;
      flex-wrap:wrap;
      gap:.5rem;
      align-items:flex-end;
      border:1px solid var(--line);
      border-radius:.5rem;
      padding:.6rem .6rem .75rem;
      margin-top:.6rem;
      background:#fff;
    }
    .catrow-col {
      flex:1 1 140px;
      min-width:140px;
    }
    .catrow-inline {
      display:flex;
      align-items:flex-end;
      gap:.5rem;
      flex-wrap:wrap;
    }
    .addBtn {
      border:none;
      background:var(--accent);
      color:#fff;
      border-radius:.5rem;
      width:2rem;
      height:2rem;
      font-size:1.2rem;
      line-height:2rem;
      text-align:center;
      cursor:pointer;
    }
    .removeBtn {
      border:none;
      background:var(--danger);
      color:#fff;
      border-radius:.5rem;
      width:2rem;
      height:2rem;
      font-size:1.2rem;
      line-height:2rem;
      text-align:center;
      cursor:pointer;
    }

    /* sidmeny */
    aside#menu {
      position:fixed;
      top:0;
      left:0;
      width:min(420px,90%);
      height:100%;
      background:var(--card);
      border-right:1px solid var(--line);
      transform:translateX(-100%);
      transition:.25s;
      z-index:200;
      overflow:auto;
    }
    aside#menu.open {
      transform:translateX(0);
    }

    details {
      border-top:1px solid var(--line);
      padding:.5rem 1rem;
    }
    details summary {
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:.4rem;
    }
    .sub {
      padding-left:1.5rem;
      display:grid;
      gap:.4rem;
      margin-top:.5rem;
    }

    @media(min-width:600px){
      /* lite mer luft desktop */
    }
  </style>
</head>
<body>
<header>
  <button id="menuBtn" class="iconbtn" onclick="toggleMenu(true)">
    <i data-lucide="menu"></i>
  </button>
  <h1>Tidrapport</h1>
  <button class="iconbtn" onclick="location.href='help.html'">
    <i data-lucide="help-circle"></i>
  </button>
</header>

<main>
  <!-- INMATNING -->
  <div class="card">
    <label>Datum
      <input type="date" id="datum" />
    </label>

    <!-- Dynamiska kategori-block (Kategori + Tid + (+)) -->
    <div id="categoryBlocks"></div>

    <div class="form-inline-2col">
      <div>
        <label>Projekt nr
          <input id="projekt" placeholder="t.ex. Y2506" />
        </label>
      </div>
      <div>
        <label>Körtid
          <input id="kortid" type="number" step="0.25" min="0" value="" />
        </label>
      </div>
    </div>

    <label>Beskrivning
      <input id="beskrivning" placeholder="Valfri text / anteckning" />
    </label>

    <div class="actions-row">
      <button class="btn primary" id="btnAdd">
        <i data-lucide="plus-circle"></i>
        <span id="btnAddText">Lägg till</span>
      </button>

      <button class="btn ghost" id="btnBackup" onclick="exportJSON()" title="Gör backup">
        <i data-lucide="database"></i>
        Backup
      </button>

      <button class="btn ghost" id="btnCancel" style="display:none">
        <i data-lucide="x-circle"></i>
        Avbryt
      </button>
    </div>
  </div>

  <!-- TABELL -->
  <div class="card">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Datum</th>
            <th>Projekt</th>
            <th>Kategori / Tid</th>
            <th>Totaltid</th>
            <th>Körtid</th>
            <th>Beskrivning</th>
            <th>Åtgärd</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
        <tfoot>
          <tr>
            <td colspan="7" id="totalsCell">Summering visas här…</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</main>

<!-- SIDMENY -->
<aside id="menu" aria-hidden="true">
  <details open>
    <summary>
      <i data-lucide="calendar"></i>
      Månad
    </summary>
    <div class="sub">
      <select id="menuMonth" onchange="changeMonth()"></select>
    </div>
  </details>

  <details>
    <summary>
      <i data-lucide="database"></i>
      Import / Backup / Export
    </summary>
    <div class="sub">
      <label>
        <input id="jsonFile" type="file" accept=".json" onchange="importJSON(event)" />
        Läs in backup (JSON)
      </label>

      <button class="btn ghost" onclick="exportJSON()">
        <i data-lucide="cloud-upload"></i>
        Backup
      </button>

      <button class="btn ghost" onclick="exportCSV()">
        <i data-lucide="file-down"></i>
        CSV
      </button>

      <button class="btn ghost" onclick="exportPDF()">
        <i data-lucide="file-text"></i>
        PDF
      </button>
    </div>
  </details>

  <details>
    <summary>
      <i data-lucide="search"></i>
      Sök
    </summary>
    <div class="sub">
      <a class="btn ghost" href="search.html">
        <i data-lucide="search"></i>
        Öppna sök
      </a>
    </div>
  </details>

  <details>
    <summary>
      <i data-lucide="settings"></i>
      Inställningar
    </summary>
    <div class="sub">
      <label>Företag
        <input id="cfgCompany" />
      </label>
      <label>Namn
        <input id="cfgName" />
      </label>
      <label>Anst.nr
        <input id="cfgEmp" />
      </label>
      <label>Ägar-ID
        <input id="cfgOwner" />
      </label>
      <label>År
        <input id="cfgYear" type="number" />
      </label>

      <label title="När aktiv: skapa backup automatiskt bara vid ändring (COV).">
        <input id="cfgAutoBackup" type="checkbox" />
        Auto-backup (COV)
      </label>

      <label>
        <input id="cfgHolidays" type="checkbox" checked />
        Visa röda dagar
      </label>

      <button class="btn primary" onclick="saveSettings()">
        <i data-lucide="save"></i>
        Spara
      </button>

      <button class="btn danger" onclick="resetAll()">
        <i data-lucide="trash-2"></i>
        Rensa allt
      </button>
    </div>
  </details>
</aside>

<!-- SCRIPT-FILER -->
<script src="export.js"></script>
<script src="backup.js"></script>
<script src="app.js"></script>

<script>
  // öppna/stäng meny
  function toggleMenu(open){
    const m = document.getElementById("menu");
    if(open){
      m.classList.add("open");
      m.setAttribute("aria-hidden","false");
    }else{
      m.classList.remove("open");
      m.setAttribute("aria-hidden","true");
    }
  }

  // klick utanför stänger menyn
  document.addEventListener("click",(e)=>{
    const menu=document.getElementById("menu");
    const btn=document.getElementById("menuBtn");
    if(!menu)return;
    const inside=menu.contains(e.target)||btn.contains(e.target);
    if(menu.classList.contains("open") && !inside){
      menu.classList.remove("open");
      menu.setAttribute("aria-hidden","true");
    }
  });

  // PWA service worker
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("sw.js");
  }

  // Ikoner
  if(window.lucide) lucide.createIcons();
</script>
</body>
</html>