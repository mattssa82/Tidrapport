<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>Tidrapport</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0e6677" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icons/icon-192.png" />

  <!-- lucide icons -->
  <script src="lucide.min.js"></script>

  <!--
    Tidrapport v10.22
    i samarbete med ChatGPT & Martin Mattsson
  -->

  <style>
    :root{
      --bg-main:#f5f7f8; --bg-header:#0e6677; --bg-card:#ffffff;
      --text-main:#1a1a1a; --border-col:#cfcfcf; --danger:#c0392b;
      --muted:#6b7280;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:var(--bg-main); color:var(--text-main);
    }

    /* Header (låst, konsekvent i alla sidor) */
    header.app-header{
      position:sticky; top:0; z-index:50;
      background:var(--bg-header); color:#fff; display:flex; align-items:center; justify-content:space-between;
      padding:.75rem 1rem; box-shadow:0 2px 6px rgb(0 0 0 / .15);
    }
    header .header-left{display:flex; align-items:center; gap:.75rem}
    header h1{margin:0; font-size:1.1rem; font-weight:600}
    .icon-btn{background:transparent;border:0;color:inherit;display:flex;align-items:center;cursor:pointer;padding:.25rem}
    .header-actions{display:flex;align-items:center;gap:.5rem}
    .header-actions a{color:#fff;text-decoration:none;display:inline-flex;align-items:center;gap:.35rem;font-size:.9rem}

    .layout{display:flex; min-height:calc(100vh - 56px)}

    /* Side menu (mobil: off-canvas, desktop: kolumn men ej låst öppet) */
    aside#sidePanel{
      background:#0e6677; color:#fff; width:280px; max-width:85vw; padding:1rem; display:flex; flex-direction:column; gap:.75rem;
      position:fixed; inset:56px auto 0 0; transform:translateX(-100%); transition:transform .2s ease; z-index:60;
    }
    aside#sidePanel.open{transform:translateX(0)}
    aside#sidePanel h2{font-size:.9rem;margin:.5rem 0 .25rem 0}
    aside#sidePanel label{font-size:.8rem;display:flex;flex-direction:column;gap:.35rem}
    aside#sidePanel input[type="text"],
    aside#sidePanel select,
    aside#sidePanel textarea{
      background:rgba(255,255,255,.15); color:#fff; border:1px solid rgba(255,255,255,.35);
      border-radius:.5rem; padding:.45rem .6rem; font-size:.9rem;
    }
    aside#sidePanel textarea{min-height:3rem}
    aside#sidePanel .side-buttons{display:grid; gap:.5rem; margin-top:.25rem}
    .side-action{
      background:#fff;border:0;color:#0e6677;border-radius:.55rem;padding:.55rem .7rem;font-size:.85rem;display:flex;align-items:center;gap:.45rem;cursor:pointer
    }
    .side-action.danger{background:var(--danger);color:#fff}

    /* input_boolean (ersätter checkbox) */
    .bool{
      appearance:none; width:42px; height:24px; border-radius:999px; position:relative;
      background:#98a2b3; outline:none; cursor:pointer; transition:background .15s ease;
    }
    .bool:after{
      content:""; position:absolute; top:2px; left:2px; width:20px; height:20px; border-radius:50%; background:#fff; transition:left .15s ease;
      box-shadow:0 1px 2px rgba(0,0,0,.25);
    }
    .bool:checked{background:#22c55e}
    .bool:checked:after{left:20px}
    .inline-flex-row{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}

    main#mainArea{flex:1; min-width:0; padding:1rem}

    /* Inmatningskort */
    .entry-card{background:var(--bg-card);border:1px solid var(--border-col);border-radius:.75rem;padding:1rem;box-shadow:0 2px 4px rgb(0 0 0 / .06);margin-bottom:1rem}
    .entry-grid{display:grid;gap:.75rem;grid-template-columns:repeat(12,1fr)}
    .entry-grid .col-12{grid-column:1/-1}
    .entry-grid .col-6{grid-column:span 6}
    .entry-grid .col-4{grid-column:span 4}
    .entry-grid .col-3{grid-column:span 3}
    label.fld{font-size:.82rem;color:#444;display:flex;flex-direction:column;gap:.35rem}
    .text, .num{
      width:100%;border:1px solid #9aa1aa;border-radius:.5rem;padding:.55rem .65rem;font-size:.95rem;background:#fff;color:#000
    }
    /* tillåt minus via text, men valideras i JS */
    .num{font-variant-numeric:tabular-nums}
    textarea.text{min-height:3.25rem;resize:vertical}

    .cat-row{display:grid;grid-template-columns:2fr 1fr auto; gap:.5rem; align-items:center}
    .cat-row select, .cat-row input{width:100%}
    .cat-row .rem{background:none;border:0;color:var(--danger);display:inline-flex;padding:.35rem;cursor:pointer}

    .button-row{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem}
    .button-row button{display:inline-flex;align-items:center;gap:.4rem;border:0;border-radius:.6rem;padding:.6rem .85rem;font-size:.9rem;background:var(--bg-header);color:#fff;cursor:pointer}
    .cancel-btn{background:#9aa1aa}

    /* Tabell & paneler */
    .table-wrap{background:var(--bg-card);border:1px solid var(--border-col);border-radius:.75rem;box-shadow:0 2px 4px rgb(0 0 0 / .06);overflow-x:auto}
    table{width:100%;border-collapse:collapse;min-width:860px;font-size:.82rem}
    thead th{background:#ececec;text-align:left;font-weight:600;padding:.55rem .6rem;border-bottom:1px solid var(--border-col);white-space:nowrap}
    tbody td{border-top:1px solid var(--border-col);padding:.55rem .6rem;vertical-align:top;word-break:break-word}
    tfoot td{border-top:2px solid var(--border-col);padding:.6rem .6rem;font-weight:600;background:#fafafa}
    .icon-table-btn{background:none;border:0;padding:.25rem .4rem;border-radius:.4rem;cursor:pointer;display:inline-flex;align-items:center;color:#0e6677}

    /* Balansfärger */
    .dagstatus--grön{background:#dff8dd !important}
    .dagstatus--orange_under,.dagstatus--orange_absence{background:#fff2cc !important}
    .dagstatus--saknas{background:#ffd6d6 !important}
    .dagstatus--helg{background:#eef3ff !important}
    .dagstatus--röddag{background:#ffe6e6 !important}

    /* Larm/Obalans-panel */
    .alarms-card{margin-top:1rem;background:var(--bg-card);border:1px solid var(--border-col);border-radius:.75rem;box-shadow:0 2px 4px rgb(0 0 0 / .06);padding:1rem}
    .alarms-card h3{margin:0 0 .5rem 0;font-size:.95rem}
    .alarms-wrap{max-height:280px;overflow:auto;border:1px solid var(--border-col);border-radius:.5rem}
    .alarms{width:100%;border-collapse:collapse;min-width:600px;font-size:.8rem}
    .alarms th,.alarms td{padding:.5rem .6rem;border-bottom:1px solid #e6e6e6}
    .alarms thead th{position:sticky;top:0;background:#f3f4f6;border-bottom:1px solid #dcdcdc;z-index:1}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.1rem .45rem;border:1px solid #d1d5db;border-radius:999px;font-size:.75rem;background:#fff}
    .ok{color:#16a34a;border-color:#86efac}
    .warn{color:#d97706;border-color:#fde68a}
    .err{color:#b91c1c;border-color:#fecaca}

    /* Mobil */
    @media(max-width:900px){
      .entry-grid{grid-template-columns:repeat(6,1fr)}
      .entry-grid .col-6{grid-column:1/-1}
      .entry-grid .col-4{grid-column:1/-1}
      .entry-grid .col-3{grid-column:span 3}
      .cat-row{grid-template-columns:1fr 120px auto}
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="app-header">
    <div class="header-left">
      <button class="icon-btn" id="menuToggleBtn" aria-label="Meny" aria-expanded="false"><i data-lucide="menu"></i></button>
      <h1>Tidrapport</h1>
    </div>
    <div class="header-actions">
      <a class="help-link" href="#" id="openSearchLink"><i data-lucide="search"></i><span>Sök</span></a>
      <a class="help-link" href="#" id="openHelpLink"><i data-lucide="info"></i><span>Hjälp</span></a>
    </div>
  </header>

  <aside id="sidePanel" aria-hidden="true">
    <h2>Period</h2>
    <label>År
      <select id="yearSelect"></select>
    </label>
    <label>Månad
      <select id="monthSelect"></select>
    </label>

    <h2>Backup / Import / Export</h2>
    <div class="side-buttons">
      <input type="file" id="importFileInput" accept=".json" />
      <button class="side-action" id="manualBackupBtn"><i data-lucide="upload-cloud"></i><span>Gör backup nu</span></button>
      <button class="side-action" id="exportCsvBtn"><i data-lucide="file-spreadsheet"></i><span>Exportera CSV</span></button>
      <button class="side-action" id="exportPdfBtn"><i data-lucide="file-text"></i><span>Exportera PDF</span></button>
      <button class="side-action" id="exportYearBtn"><i data-lucide="calendar"></i><span>Exportera Årsöversikt</span></button>
      <button class="side-action" id="openSearchBtn"><i data-lucide="search"></i><span>Sök & filtrera</span></button>
      <button class="side-action danger" id="clearAllBtn"><i data-lucide="trash-2"></i><span>RENSA ALLT</span></button>
    </div>

    <h2>Inställningar</h2>
    <label>Företag
      <input id="companyInput" type="text" />
    </label>
    <label>Namn
      <input id="nameInput" type="text" />
    </label>
    <label>Anst.nr
      <input id="anstnrInput" type="text" />
    </label>

    <label class="inline-flex-row">
      <span>Visa röda dagar</span>
      <input id="showRedDaysChk" type="checkbox" class="bool" />
    </label>

    <label class="inline-flex-row" title="Auto-backup (vid ändring)">
      <span>Auto-backup (vid ändring)</span>
      <input id="autoBackupChk" type="checkbox" class="bool" />
    </label>

    <label class="inline-flex-row" title="Standard timmar som räknas på röda dagar (påverkar balans)">
      <span>Röddag standard (h)</span>
      <input id="redDayStdHours" class="text" inputmode="numeric" placeholder="8">
    </label>

    <button class="side-action" id="saveSettingsBtn"><i data-lucide="save"></i><span>Spara inställningar</span></button>

    <p style="font-size:.7rem;opacity:.8;margin-top:.75rem;line-height:1.4;">
      Tidrapport v10.22<br/>
      i samarbete med ChatGPT &amp; Martin Mattsson
    </p>
  </aside>

  <!-- HUVUD -->
  <div class="layout">
    <main id="mainArea">

      <!-- INMATNING -->
      <section class="entry-card">
        <div class="entry-grid">
          <!-- Rad 1 -->
          <label class="fld col-6">Datum
            <input id="dateInput" class="text" type="text" placeholder="YYYY-MM-DD" autocomplete="off" />
          </label>

          <!-- Rad 2 -->
          <label class="fld col-6">Projekt nr
            <input id="projektInput" class="text" type="text" autocomplete="off" />
          </label>

          <!-- Rad 2 (körtid) -->
          <label class="fld col-3">Körtid (h) <!-- text för att möjliggöra '-' -->
            <input id="driveHoursInput" class="num" type="text" inputmode="decimal" autocomplete="off" />
          </label>

          <!-- Rad 3: Kategori(er) dynamiskt -->
          <div class="col-12" id="catsWrap">
            <!-- första raden (huvud) är låst (alltid synlig) -->
          </div>

          <!-- Rad 5: Dagbok -->
          <label class="fld col-12">Dagboksanteckning
            <textarea id="noteInput" class="text" rows="2"></textarea>
          </label>
        </div>

        <div class="button-row">
          <button id="addCatBtn"><i data-lucide="plus"></i><span>Ny kategori-rad</span></button>
          <button id="saveEntryBtn"><i data-lucide="plus-circle"></i><span id="saveEntryLabel">Lägg till</span></button>
          <button class="cancel-btn" id="cancelEditBtn" style="display:none;"><i data-lucide="x-circle"></i><span>Avbryt</span></button>
          <button id="manualBackupBtn2"><i data-lucide="upload-cloud"></i><span>Backup nu</span></button>
        </div>
      </section>

      <!-- MÅNADSVY -->
      <section class="table-wrap">
        <table id="monthTable">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Projekt</th>
              <th>Kategori(er)</th>
              <th>Totaltid</th>
              <th>Körtid</th>
              <th>Dagboksanteckning</th>
              <th>Åtgärd</th>
            </tr>
          </thead>
          <tbody id="monthTableBody"></tbody>
          <tfoot>
            <tr><td colspan="7" id="monthSummaryCell"></td></tr>
          </tfoot>
        </table>
      </section>

      <!-- LARM/OBALANS (över årsöversikt) -->
      <section class="alarms-card">
        <h3>Larm / Obalans denna månad</h3>
        <div class="alarms-wrap">
          <table class="alarms" id="alarmsTable">
            <thead>
              <tr>
                <th>Datum</th>
                <th>Status</th>
                <th>Tid (h)</th>
              </tr>
            </thead>
            <tbody id="alarmsTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- ÅRSÖVERSIKT -->
      <section class="table-wrap" style="margin-top:1rem;">
        <table id="yearTable">
          <thead>
            <tr>
              <th>Månad</th>
              <th>Ordinarie</th>
              <th>Körtid</th>
              <th>Flex</th>
              <th>ÖT &lt;2</th>
              <th>ÖT &gt;2</th>
              <th>ÖT-Helg</th>
              <th>Semester</th>
              <th>ATF</th>
              <th>VAB</th>
              <th>Sjuk</th>
              <th>FL</th>
              <th>Trakt</th>
            </tr>
          </thead>
          <tbody id="yearTableBody"></tbody>
        </table>
      </section>

    </main>
  </div>

  <!-- ORDNING VIKTIG -->
  <script src="balansregler.js"></script>
  <script src="backup.js"></script>
  <script src="export.js"></script>
  <script src="search.js"></script>
  <script src="app.js"></script>
  <script>
    if (window.lucide) { lucide.createIcons(); }
  </script>
</body>
</html>