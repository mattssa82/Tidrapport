<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tidrapport</title>

<!-- PWA / App-ikon -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0e6677">
<link rel="icon" href="ikon-512.png">

<!-- jsPDF f√∂r PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" referrerpolicy="no-referrer"></script>

<style>
:root{--brand:#0e6677;--bg:#f6f7f9;--card:#fff;--text:#1f2937;--muted:#6b7280;--danger:#b91c1c;--line:#e5e7eb;--accent:#0a515f;}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{position:sticky;top:0;z-index:30;background:var(--brand);color:#fff;display:flex;align-items:center;gap:.75rem;padding:.85rem 1rem}
.hamb{width:40px;height:40px;border-radius:.6rem;background:var(--accent);border:none;color:#fff;font-size:1.25rem;display:grid;place-items:center;cursor:pointer}
h1{margin:0;font-size:1.25rem;letter-spacing:.2px}
main{max-width:1100px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
.card{background:var(--card);border:1px solid var(--line);border-radius:.9rem;box-shadow:0 1px 2px rgba(0,0,0,.03);padding:1rem}
.grid{display:grid;gap:.75rem}
@media(min-width:760px){.grid{grid-template-columns:repeat(6,1fr)}}
label{font-size:.85rem;color:var(--muted);display:block;margin-bottom:.2rem}
input,select,textarea,button{font-size:1rem}
input,select,textarea{width:100%;padding:.6rem .7rem;border:1px solid #cbd5e1;border-radius:.6rem;background:#fff}
.actions{display:flex;gap:.5rem;flex-wrap:wrap}
.btn{border:0;border-radius:.6rem;padding:.55rem .8rem;font-weight:600;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.ghost{background:#eef2f7}
.btn.danger{background:var(--danger);color:#fff}
table{width:100%;border-collapse:collapse;font-size:.95rem}
th,td{padding:.55rem;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
th{font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
tfoot td{background:#f0f9ff;font-weight:700}
.small{font-size:.85rem;color:var(--muted)}
/* V√§nster-meny + overlay */
#menuOverlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:40;display:none}
#menuOverlay.show{display:block}
#menu{position:fixed;inset:0 auto 0 0;width:min(420px,92%);background:var(--card);border-right:1px solid var(--line);
      transform:translateX(-100%);transition:.25s ease;z-index:50;display:flex;flex-direction:column}
#menu.open{transform:translateX(0)}
.menu-head{padding:1rem;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
.menu-body{padding:1rem;overflow:auto;display:grid;gap:1rem}
.group{border:1px solid var(--line);border-radius:.8rem}
.group summary{list-style:none;cursor:pointer;padding:.8rem 1rem;font-weight:700;background:#f8fafc;border-radius:.8rem .8rem 0 0}
.group summary::-webkit-details-marker{display:none}
.group .content{padding:.75rem 1rem 1rem;display:grid;gap:.65rem}
.select{padding:.6rem .7rem;border:1px solid #cbd5e1;border-radius:.6rem;background:#fff;width:100%}
.menu-btn{width:100%;text-align:left}
hr.sep{border:0;border-top:1px dashed var(--line);margin:.4rem 0}
/* Banner */
.banner{background:#fff3cd;color:#856404;border:1px solid #ffeeba;border-radius:.5rem;padding:.75rem 1rem;margin:1rem;font-size:.95rem;display:none;justify-content:space-between;align-items:center}
.banner button{background:transparent;border:none;font-size:1rem;cursor:pointer;color:#856404}
</style>
</head>
<body>
<header>
  <button class="hamb" aria-label="Meny" onclick="toggleMenu(true)">‚ò∞</button>
  <h1>Tidrapport</h1>
</header>

<!-- Eng√•ngsbanner -->
<div id="startupBanner" class="banner">
  <span>üí° Tips: L√§s in senaste backup om du byter enhet.</span>
  <button onclick="dismissBanner()">‚úï</button>
</div>

<main>
  <div class="card"><strong id="monthTitle">Tidrapport</strong></div>

  <!-- Inmatning -->
  <div class="card">
    <div class="grid">
      <div><label for="datum">Datum</label><input type="date" id="datum"></div>
      <div><label for="kategori">Kategori</label>
        <select id="kategori">
          <option>Ordinarie tid</option><option>Semester-tim</option><option>ATF-tim</option><option>Sjuk-tim</option>
          <option>F√∂r√§ldraledig</option><option>VAB</option><option>Flextid</option><option>√ñvertid &lt;2</option>
          <option>√ñvertid 2&gt;</option><option>√ñvertid-Helg</option><option>Traktamente</option>
        </select>
      </div>
      <div><label for="tid">Tid</label><input id="tid" type="text" inputmode="numeric" placeholder="0,25-steg ‚Äì minus till√•tet"></div>
      <div><label for="projekt">Projekt nr</label><input id="projekt" placeholder="Bokst√§ver/siffror"></div>
      <div><label for="kortid">K√∂rtid</label><input id="kortid" type="text" inputmode="numeric"></div>
      <div><label for="beskrivning">Beskrivning</label><input id="beskrivning" placeholder="Fritext (valfritt)"></div>
    </div>
    <div class="actions" style="margin-top:.6rem">
      <button class="btn primary" id="btnAdd">L√§gg till</button>
      <button class="btn ghost" id="btnBackup">G√∂r backup</button>
      <button class="btn ghost" id="btnCancel" style="display:none">Avbryt</button>
    </div>
  </div>

  <!-- Tabell -->
  <div class="card">
    <table>
      <thead><tr><th>Datum</th><th>Projekt</th><th>Kategori</th><th>Tid</th><th>K√∂rtid</th><th>Beskrivning</th><th>√Ötg√§rd</th></tr></thead>
      <tbody id="rows"></tbody>
      <tfoot><tr><td colspan="7" id="totalsCell">Summering visas h√§r‚Ä¶</td></tr></tfoot>
    </table>
  </div>

  <!-- Larm -->
  <div class="card">
    <strong>Larm & kontroller</strong>
    <div id="alarms" class="small">Inga varningar.</div>
  </div>

  <!-- √Örs√∂versikt -->
  <div class="card">
    <strong>√Örs√∂versikt</strong>
    <div id="yearLinks"></div>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>M√•nad</th><th>Ordinarie</th><th>Semester</th><th>ATF</th><th>Sjuk</th><th>F√∂r√§ldraledig</th>
            <th>VAB</th><th>Flextid</th><th>√ñT&lt;2</th><th>√ñT2&gt;</th><th>√ñT-Helg</th><th>Trakt</th><th>K√∂rtid</th>
          </tr>
        </thead>
        <tbody id="yearBody"></tbody>
      </table>
    </div>
  </div>
</main>

<!-- Meny (v√§nster) + overlay som st√§nger vid klick utanf√∂r -->
<div id="menuOverlay" onclick="toggleMenu(false)"></div>
<aside id="menu" aria-hidden="true">
  <div class="menu-head">
    <strong>Meny</strong>
    <button class="hamb" onclick="toggleMenu(false)" aria-label="St√§ng">‚úï</button>
  </div>
  <div class="menu-body">
    <details class="group" open>
      <summary>M√•nad</summary>
      <div class="content">
        <select id="menuMonth" class="select"></select>
        <button class="btn ghost menu-btn" onclick="changeMonth()">Byt m√•nad</button>
      </div>
    </details>

    <details class="group">
      <summary>Inst√§llningar</summary>
      <div class="content">
        <label>F√∂retag<input id="cfgCompany"></label>
        <label>Namn<input id="cfgName" placeholder="F√∂r- och efternamn"></label>
        <label>Anst-Nr<input id="cfgEmp"></label>
        <label>√Ñgar-ID<input id="cfgOwner" placeholder="t.ex. martin"></label>
        <label>√Ör<input id="cfgYear" inputmode="numeric" placeholder="t.ex. 2025"></label>
        <label>Extra notering<textarea id="cfgNote"></textarea></label>
        <label style="display:flex;gap:.5rem;align-items:center">
          <input type="checkbox" id="cfgAutoBackup" checked> Automatisk lokal backup
        </label>
        <div class="actions">
          <button class="btn ghost" onclick="quickBackup()">G√∂r backup</button>
          <button class="btn ghost" onclick="saveSettings()">Spara</button>
          <button class="btn danger" onclick="resetSettings()">Rensa inst√§llningar</button>
          <button class="btn danger" onclick="resetAll()">Rensa all data</button>
        </div>
      </div>
    </details>

    <details class="group">
      <summary>Exportera</summary>
      <div class="content">
        <button class="btn ghost menu-btn" onclick="exportMonthReport()">Export M√•nadsrapport (CSV)</button>
        <button class="btn ghost menu-btn" onclick="exportYearReportCombined()">Export √Örsrapport (CSV)</button>
        <button class="btn ghost menu-btn" onclick="shareMonthPdfEmail()">Dela som PDF ‚Äì M√•nadsrapport</button>
        <button class="btn ghost menu-btn" onclick="shareYearPdfEmail()">Dela som PDF ‚Äì √Örsrapport</button>
      </div>
    </details>

    <div class="small" style="text-align:center">
      <hr class="sep">
      üî® I samarbete med <strong>ChatGPT & Martin Mattsson</strong>
    </div>
  </div>
</aside>

<script>
(()=>{
// ===== Utils & konstanter =====
const monthsSv=["januari","februari","mars","april","maj","juni","juli","augusti","september","oktober","november","december"];
const csvCols=["Datum","Ordinarie tid","K√∂rtid","Projekt nr","Semester-tim","ATF-tim","Sjuk-tim","F√∂r√§ldraledig","VAB","Flextid","√ñvertid <2","√ñvertid 2>","√ñvertid-Helg","Traktamente","Beskrivning"];
const STORAGE="tidrapport_data_v10";
const SETTINGS="tidrapport_settings_v10";
const $=id=>document.getElementById(id);
const cap=s=>s.charAt(0).toUpperCase()+s.slice(1);

// Format: visa tomt ist√§llet f√∂r exakt 0, men visa minus n√§r < 0
const fmt=(n)=>{ const v=Math.round(Number(n||0)*100)/100; return v.toLocaleString("sv-SE",{minimumFractionDigits:0,maximumFractionDigits:2}); };
const fmtBlankZero=(n)=>{ const v=Number(n)||0; return v===0?"":fmt(v); };

// Eng√•ngsbanner
window.dismissBanner=()=>{ $("startupBanner").style.display="none"; localStorage.setItem("bannerDismissed","1"); };
window.addEventListener("DOMContentLoaded",()=>{ if(!localStorage.getItem("bannerDismissed")){ $("startupBanner").style.display="flex"; } });

// ===== State =====
let state={month:(new Date().getMonth()+1), data:load(STORAGE,{}), settings:load(SETTINGS,defSettings())};
function defSettings(){return{company:"",name:"",emp:"",owner:"",year:new Date().getFullYear(),note:"",autoBackup:true}}
function load(k,def){try{const v=JSON.parse(localStorage.getItem(k));return v??def}catch(_){return def}}
function save(){ localStorage.setItem(STORAGE,JSON.stringify(state.data)); if($("cfgAutoBackup").checked) quickBackup(true); }
function saveCfg(){ localStorage.setItem(SETTINGS,JSON.stringify(state.settings)); }

// ===== Meny (v√§nster + overlay) =====
window.toggleMenu=(open)=>{ const el=$("menu"); const ov=$("menuOverlay"); el.classList.toggle("open",open); ov.classList.toggle("show",open); if(open) initMenu(); };
function initMenu(){
  const sel=$("menuMonth"); if(sel){ sel.innerHTML=""; monthsSv.forEach((n,i)=>{ const o=document.createElement("option"); o.value=i+1;o.textContent=cap(n); if(i+1===state.month)o.selected=true; sel.appendChild(o); }); }
  $("cfgCompany").value=state.settings.company||"";
  $("cfgName").value=state.settings.name||"";
  $("cfgEmp").value=state.settings.emp||"";
  $("cfgOwner").value=state.settings.owner||"";
  $("cfgYear").value=state.settings.year||"";
  $("cfgNote").value=state.settings.note||"";
  $("cfgAutoBackup").checked = state.settings.autoBackup!==false;
}
window.changeMonth=()=>{state.month=Number($("menuMonth").value); renderAll(); toggleMenu(false)}

// ===== Settings =====
window.saveSettings=()=>{
  state.settings.company=$("cfgCompany").value;
  state.settings.name=$("cfgName").value;
  state.settings.emp=$("cfgEmp").value;
  state.settings.owner=$("cfgOwner").value.trim();
  state.settings.year=Number($("cfgYear").value)||new Date().getFullYear();
  state.settings.note=$("cfgNote").value;
  state.settings.autoBackup=$("cfgAutoBackup").checked;
  saveCfg(); renderAll();
};
window.resetSettings=()=>{
  if(!confirm("Rensa inst√§llningar?"))return;
  state.settings=defSettings(); saveCfg(); initMenu(); renderAll();
};
window.resetAll=()=>{
  if(!confirm("‚ö†Ô∏è RADERA ALL DATA?"))return;
  state.data={}; for(let m=1;m<=12;m++) ensureMonth(m); save(); renderAll();
};

// ===== Input helpers (minus till√•tet) =====
function normMinus(s){return (s||"").replace(/[‚Äì‚Äî‚àí]/g,"-")}
function toNumRaw(s){ if(s==null) return NaN; s=normMinus((""+s).replace(/\s+/g,"")).replace(",","."); if(!/^[-]?\d*(\.\d+)?$/.test(s)) return NaN; return s===""?NaN:parseFloat(s); }
function roundQuarter(n){return Math.round(n*4)/4}
function parseHourInput(v,allowEmpty=false){ if(allowEmpty && (v===""||v==null)) return 0; const n=toNumRaw(v); if(isNaN(n)) return NaN; return roundQuarter(n); }
function sanitizeProject(s){ s=(s||"").normalize("NFC").replace(/\s+/g,""); s=s.replace(/[^0-9A-Za-z√Ö√Ñ√ñ√•√§√∂]/g,""); return s; }
const escapeHtml=s=>(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

// ===== Add/Edit/Delete =====
const btnAdd=$("btnAdd"); const btnCancel=$("btnCancel"); const btnBackup=$("btnBackup");
btnAdd.addEventListener("click", () => {
  const d=$("datum").value; if(!d){ alert("V√§lj datum."); return; }
  const k=$("kategori").value;
  const t=parseHourInput($("tid").value); if(isNaN(t)){ alert("Ogiltig Tid."); return; }
  const p=sanitizeProject($("projekt").value);
  const kt=parseHourInput($("kortid").value,true); if(isNaN(kt)){ alert("Ogiltig K√∂rtid."); return; }
  const b=$("beskrivning").value||"";
  const m=(new Date(d)).getMonth()+1; ensureMonth(m);

  if (editing){
    const list=state.data[editing.month]||[]; const idx=list.findIndex(r=>r._id===editing.id);
    if(idx!==-1){
      list[idx]={...list[idx], datum:d,kategori:k,tid:t,projekt:p,kortid:kt,beskrivning:b};
      if (editing.month!==m){ const row=list.splice(idx,1)[0]; ensureMonth(m); state.data[m].push(row); state.month=m; }
      save();
    }else{ state.data[m].push({_id:uid(), datum:d,kategori:k,tid:t,projekt:p,kortid:kt,beskrivning:b}); save(); }
    exitEditMode(); renderAll();
  } else {
    state.data[m].push({_id:uid(), datum:d,kategori:k,tid:t,projekt:p,kortid:kt,beskrivning:b});
    save(); clearInputs(); state.month=m; renderAll();
  }
});
btnCancel.addEventListener("click", ()=>{ exitEditMode(); clearInputs(); });
btnBackup.addEventListener("click", ()=>{ quickBackup(); });

function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
let editing=null;
function enterEditMode(row, month){ editing={id:row._id, month}; btnAdd.textContent="Spara"; btnCancel.style.display=""; $("datum").value=row.datum; $("kategori").value=row.kategori; $("tid").value=row.tid; $("projekt").value=row.projekt||""; $("kortid").value=row.kortid||""; $("beskrivning").value=row.beskrivning||""; }
function exitEditMode(){ editing=null; btnAdd.textContent="L√§gg till"; btnCancel.style.display="none"; }
function clearInputs(){["datum","tid","projekt","kortid","beskrivning"].forEach(id=>$(id).value=""); $("kategori").selectedIndex=0;}

// G√∂r √•tkomst i onClick i tabell
window.APP={editRow:(id,m)=>{ const row=(state.data[m]||[]).find(r=>r._id===id); if(!row)return; enterEditMode(row,m); },
            delRow:(id,m)=>{ if(!confirm("Ta bort raden?"))return; const list=state.data[m]||[]; const i=list.findIndex(r=>r._id===id); if(i!==-1){list.splice(i,1); save(); renderAll();}}};

// ===== Data helpers =====
function ensureMonth(m){if(!state.data[m]) state.data[m]=[]}
function yearFilter(r){ return (new Date(r.datum)).getFullYear() === (Number(state.settings.year)||new Date().getFullYear()); }

// ===== Render =====
function calcMonthTotals(m){
  ensureMonth(m); const res={_kortid:0,"Traktamente":0};
  (state.data[m]||[]).filter(yearFilter).forEach(r=>{
    res[r.kategori]=(res[r.kategori]||0)+Number(r.tid||0);
    res._kortid+=Number(r.kortid||0);
  });
  return res;
}
function renderTable(){
  const m=state.month; ensureMonth(m); const y=state.settings.year;
  $("monthTitle").textContent=`Tidrapport f√∂r ${cap(monthsSv[m-1])} ${y}`;
  const tb=$("rows"); tb.innerHTML="";
  const rows=[...(state.data[m]||[]).filter(yearFilter)].sort((a,b)=>a.datum.localeCompare(b.datum));

  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.datum}</td><td>${escapeHtml(r.projekt||"")}</td><td>${r.kategori}</td>
      <td>${fmtBlankZero(r.tid)}</td><td>${fmtBlankZero(r.kortid)}</td><td>${escapeHtml(r.beskrivning||"")}</td>
      <td class="actions">
        <button class="btn ghost" onclick="APP.editRow('${r._id}',${m})">√Ñndra</button>
        <button class="btn danger" onclick="APP.delRow('${r._id}',${m})">Ta bort</button>
      </td>`;
    tb.appendChild(tr);
  });

  const t=calcMonthTotals(m);
  $("totalsCell").textContent=
    `Summering ‚Äî Ordinarie: ${fmtBlankZero(t["Ordinarie tid"]||0)} | Semester: ${fmtBlankZero(t["Semester-tim"]||0)} | ATF: ${fmtBlankZero(t["ATF-tim"]||0)} | `+
    `Sjuk: ${fmtBlankZero(t["Sjuk-tim"]||0)} | F√∂r√§ldraledig: ${fmtBlankZero(t["F√∂r√§ldraledig"]||0)} | VAB: ${fmtBlankZero(t["VAB"]||0)} | Flextid: ${fmtBlankZero(t["Flextid"]||0)} | `+
    `√ñT<2: ${fmtBlankZero(t["√ñvertid <2"]||0)} | √ñT2>: ${fmtBlankZero(t["√ñvertid 2>"]||0)} | √ñT-Helg: ${fmtBlankZero(t["√ñvertid-Helg"]||0)} | Traktamente: ${fmtBlankZero(t["Traktamente"]||0)} | `+
    `K√∂rtid: ${fmtBlankZero(t._kortid||0)}`;

  renderYear(); renderAlarms(); initMenu();
}
function renderYear(){
  const tb=$("yearBody"); tb.innerHTML="";
  for(let m=1;m<=12;m++){
    const t=calcMonthTotals(m);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${cap(monthsSv[m-1])}</td>
      <td>${fmtBlankZero(t["Ordinarie tid"]||0)}</td><td>${fmtBlankZero(t["Semester-tim"]||0)}</td><td>${fmtBlankZero(t["ATF-tim"]||0)}</td>
      <td>${fmtBlankZero(t["Sjuk-tim"]||0)}</td><td>${fmtBlankZero(t["F√∂r√§ldraledig"]||0)}</td><td>${fmtBlankZero(t["VAB"]||0)}</td><td>${fmtBlankZero(t["Flextid"]||0)}</td>
      <td>${fmtBlankZero(t["√ñvertid <2"]||0)}</td><td>${fmtBlankZero(t["√ñvertid 2>"]||0)}</td><td>${fmtBlankZero(t["√ñvertid-Helg"]||0)}</td>
      <td>${fmtBlankZero(t["Traktamente"]||0)}</td><td>${fmtBlankZero(t._kortid||0)}</td>`;
    tb.appendChild(tr);
  }
}
function renderAlarms(){
  const m=state.month; ensureMonth(m); const y=state.settings.year||new Date().getFullYear();
  const map={}; (state.data[m]||[]).filter(yearFilter).forEach(r=>{ map[r.datum]=(map[r.datum]||0)+Number(r.tid||0); });
  const last=new Date(y,m,0).getDate(); const lines=[];
  for(let d=1; d<=last; d++){
    const iso=`${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const sum=map[iso]; let cls="",label="";
    if(sum==null){ cls=""; label=""; } // visa inget chip om ingen rad ‚Äì h√•ll den ren
    else if(sum<8){ cls=""; label=`${iso}: ${fmt(sum)}h (<8h)`; }
    else { cls=""; label=`${iso}: ${fmt(sum)}h`; }
    if(label) lines.push(`<div class="small">${label}</div>`);
  }
  $("alarms").innerHTML=lines.join("") || "Inga varningar.";
}
function renderAll(){renderTable()}

// ===== Backup (snabb) =====
function ownerPrefix(){ const o=(state.settings.owner||"").trim(); return o? (o.replace(/\s+/g,"_")+"_"):""; }
function dl(name,blob){const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500)}
window.quickBackup=()=>{
  const ts=new Date(); const stamp=ts.toISOString().replace(/[-:T.Z]/g,"").slice(0,14);
  const blob=new Blob([JSON.stringify({version:"v10",updatedAt:Date.now(),settings:state.settings,data:state.data},null,2)],{type:"application/json"});
  dl(`${ownerPrefix()}tidrapport_backup_${stamp}.json`, blob);
};

// ===== CSV / Share =====
const FILL_ZERO=false;
const csvEscape=s=>{s=s==null?"":String(s).replace(/\r?\n/g," "); if(/[";]/.test(s)) s='"'+s.replace(/"/g,'""')+'"'; return s;}
function csvHeaderRow(){return csvCols.join(";")}
function sortedRows(months){
  const out=[]; months.forEach(m=>{ensureMonth(m); (state.data[m]||[]).filter(yearFilter).forEach(r=>out.push({...r,_m:m}))});
  out.sort((a,b)=>{const c=a.datum.localeCompare(b.datum); if(c) return c; const p=(a.projekt||"").localeCompare(b.projekt||""); if(p) return p; return (a.kategori||"").localeCompare(b.kategori||"");});
  return out;
}
function headerInfo(scope){
  const y=state.settings.year, m=state.month;
  const parts=["sep=;","Tidrapport;;;;",`F√∂retag;${state.settings.company||""};;;;`,`Namn;${state.settings.name||""};;;;`,`Anst-Nr;${state.settings.emp||""};;;;`];
  if(state.settings.owner) parts.push(`√Ñgar-ID;${state.settings.owner};;;;`);
  parts.push(`√Ör;${y};;;;`);
  if(scope==="month") parts.push(`M√•nad;${cap(monthsSv[m-1])};;;;`);
  if(state.settings.note && state.settings.note.trim()) parts.push(`Notering;${state.settings.note.replace(/\r?\n/g," ")}`);
  parts.push(""); return parts.join("\r\n");
}
function buildRowsSection(scope){
  const months = scope==="year" ? Array.from({length:12},(_,i)=>i+1) : [state.month];
  const lines=[`### RADER (${scope==="year"?"√•r":"m√•nad"})`, csvHeaderRow()];
  sortedRows(months).forEach(r=>{
    const cat=r.kategori||"";
    const val=want=> (cat===want ? fmtBlankZero(r.tid) : (FILL_ZERO ? "0" : ""));
    const row=[r.datum,val("Ordinarie tid"),fmtBlankZero(r.kortid||0),csvEscape(r.projekt||""),val("Semester-tim"),val("ATF-tim"),val("Sjuk-tim"),val("F√∂r√§ldraledig"),val("VAB"),val("Flextid"),val("√ñvertid <2"),val("√ñvertid 2>"),val("√ñvertid-Helg"),val("Traktamente"),csvEscape(r.beskrivning||"")];
    lines.push(row.join(";"));
  });

  // Summeringsrad(er) ‚Äî precis f√∂re "per projekt"
  const sum={};
  const srcRows = scope==="year" ? sortedRows(Array.from({length:12},(_,i)=>i+1)) : sortedRows([state.month]);
  srcRows.forEach(r=>{
    const add=(k,v)=> sum[k]=(sum[k]||0)+(Number(v)||0);
    const cat=r.kategori||"";
    if(cat==="Ordinarie tid") add("Ordinarie tid",r.tid);
    if(r.kortid) add("K√∂rtid",r.kortid);
    if(cat==="Semester-tim") add("Semester-tim",r.tid);
    if(cat==="ATF-tim") add("ATF-tim",r.tid);
    if(cat==="Sjuk-tim") add("Sjuk-tim",r.tid);
    if(cat==="F√∂r√§ldraledig") add("F√∂r√§ldraledig",r.tid);
    if(cat==="VAB") add("VAB",r.tid);
    if(cat==="Flextid") add("Flextid",r.tid);
    if(cat==="√ñvertid <2") add("√ñvertid <2",r.tid);
    if(cat==="√ñvertid 2>") add("√ñvertid 2>",r.tid);
    if(cat==="√ñvertid-Helg") add("√ñvertid-Helg",r.tid);
    if(cat==="Traktamente") add("Traktamente",r.tid);
  });
  const label = scope==="year" ? `SUMMA (${state.settings.year})` : `SUMMA (${monthsSv[state.month-1].slice(0,3)})`;
  const sumRow=[
    label,
    fmtBlankZero(sum["Ordinarie tid"]||0),
    fmtBlankZero(sum["K√∂rtid"]||0),
    "",
    fmtBlankZero(sum["Semester-tim"]||0),
    fmtBlankZero(sum["ATF-tim"]||0),
    fmtBlankZero(sum["Sjuk-tim"]||0),
    fmtBlankZero(sum["F√∂r√§ldraledig"]||0),
    fmtBlankZero(sum["VAB"]||0),
    fmtBlankZero(sum["Flextid"]||0),
    fmtBlankZero(sum["√ñvertid <2"]||0),
    fmtBlankZero(sum["√ñvertid 2>"]||0),
    fmtBlankZero(sum["√ñvertid-Helg"]||0),
    fmtBlankZero(sum["Traktamente"]||0),
    ""
  ];
  lines.push(sumRow.join(";"));

  lines.push(""); 
  return lines.join("\r\n");
}
function groupByProject(months){
  const map={};
  months.forEach(m=>{
    ensureMonth(m);
    (state.data[m]||[]).filter(yearFilter).forEach(r=>{
      const raw=(r.projekt||"(tomt)").trim();
      const keyUpper=raw.toUpperCase();
      const cat=r.kategori||"";
      map[keyUpper]??={_kortid:0};
      map[keyUpper]._kortid+=Number(r.kortid||0);
      map[keyUpper][cat]=(map[keyUpper][cat]||0)+Number(r.tid||0);
    });
  });
  return map;
}
function buildProjectSection(scope){
  const months = scope==="year" ? Array.from({length:12},(_,i)=>i+1) : [state.month];
  const y=state.settings.year, m=String(state.month).padStart(2,"0");
  const lines=[`### SUMMERING PER PROJEKT (${scope==="year"?"√•r":"m√•nad"})`, csvHeaderRow()];
  const g=groupByProject(months);
  Object.keys(g).sort().forEach(pUpper=>{
    const o=g[pUpper]; const datum=scope==="year" ? `${y}-01-01` : `${y}-${m}-01`;
    const row=[datum,
      fmtBlankZero(o["Ordinarie tid"]||0),
      fmtBlankZero(o._kortid||0),
      csvEscape(pUpper),
      fmtBlankZero(o["Semester-tim"]||0),
      fmtBlankZero(o["ATF-tim"]||0),
      fmtBlankZero(o["Sjuk-tim"]||0),
      fmtBlankZero(o["F√∂r√§ldraledig"]||0),
      fmtBlankZero(o["VAB"]||0),
      fmtBlankZero(o["Flextid"]||0),
      fmtBlankZero(o["√ñvertid <2"]||0),
      fmtBlankZero(o["√ñvertid 2>"]||0),
      fmtBlankZero(o["√ñvertid-Helg"]||0),
      fmtBlankZero(o["Traktamente"]||0),
      "Summerat per projekt"
    ];
    lines.push(row.join(";"));
  });
  return lines.join("\r\n");
}
function buildCombinedCsv(scope){ return headerInfo(scope) + buildRowsSection(scope) + buildProjectSection(scope); }

// ----- Blob helpers -----
function makeBlobCSV(text){
  // CSV som UTF-16LE + BOM (Excel-kompatibelt)
  const s=(text||"").normalize("NFC"); const bom=new Uint8Array([0xFF,0xFE]); const buf=new Uint8Array(bom.length + s.length*2);
  bom.forEach((b,i)=>buf[i]=b); for(let i=0;i<s.length;i++){const code=s.charCodeAt(i); buf[bom.length+i*2]=code&0xFF; buf[bom.length+i*2+1]=(code>>8)&0xFF;}
  return new Blob([buf],{type:"text/csv;charset=utf-16le"});
}
function tryShareOrDownload(filename, blob, title){
  if (navigator.canShare && navigator.canShare({files:[new File([blob], filename, {type: blob.type})]})) {
    return navigator.share({title, files:[new File([blob], filename, {type: blob.type})]})
      .catch(()=>{ dl(filename, blob); alert("Delning avbr√∂ts ‚Äì filen laddades ner ist√§llet."); });
  }
  dl(filename, blob);
  return Promise.resolve();
}

// ===== Export / Dela (CSV) =====
window.exportMonthReport=()=>{ const text=buildCombinedCsv("month"); const y=state.settings.year, m=String(state.month).padStart(2,"0"); dl(`${ownerPrefix()}tidrapport_${y}_${m}_manadsrapport.csv`, makeBlobCSV(text)); };
window.exportYearReportCombined=()=>{ const text=buildCombinedCsv("year"); const y=state.settings.year; dl(`${ownerPrefix()}tidrapport_${y}_arsrapport.csv`, makeBlobCSV(text)); };
window.shareMonthReport=async()=>{ const text=buildCombinedCsv("month"); const y=state.settings.year, m=String(state.month).padStart(2,"0"); await tryShareOrDownload(`${ownerPrefix()}Tidrapport_${y}_${m}_manadsrapport.csv`, makeBlobCSV(text), "Tidrapport ‚Äì M√•nadsrapport"); };
window.shareYearReport=async()=>{ const text=buildCombinedCsv("year"); const y=state.settings.year; await tryShareOrDownload(`${ownerPrefix()}Tidrapport_${y}_arsrapport.csv`, makeBlobCSV(text), "Tidrapport ‚Äì √Örsrapport"); };

// ===== PDF (enkel, rubrik + metadata) =====
function makePdfReport(scope){ // -> Blob
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"a4", orientation:"landscape"});
  const ySel = state.settings.year;
  const mIdx = state.month-1;
  const title = scope==="year" ? `√Örsrapport ${ySel}` : `M√•nadsrapport ${cap(monthsSv[mIdx])} ${ySel}`;
  doc.setFont("helvetica","bold");doc.setFontSize(14);doc.text(`Tidrapport ‚Äî ${title}`,40,40);
  return doc.output("blob");
}
async function shareMonthPdfEmail(){
  const blob=makePdfReport("month");
  await tryShareOrDownload(`Tidrapport_${state.settings.year}_${String(state.month).padStart(2,"0")}.pdf`, blob, "Tidrapport ‚Äì M√•nadsrapport PDF");
}
async function shareYearPdfEmail(){
  const blob=makePdfReport("year");
  await tryShareOrDownload(`Tidrapport_${state.settings.year}_arsrapport.pdf`, blob, "Tidrapport ‚Äì √Örsrapport PDF");
}

// ===== Init =====
function ownerPrefix(){ const o=(state.settings.owner||"").trim(); return o? (o.replace(/\s+/g,"_")+"_"):""; }
function bootstrap(){
  for(let m=1;m<=12;m++) ensureMonth(m);
  renderAll();
}
bootstrap();

})();</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("sw.js")
      .then(reg => console.log("Service worker registrerad:", reg.scope))
      .catch(err => console.error("SW-fel:", err));
  });
}
</script>
</body>
</html>