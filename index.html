<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tidrapport</title>
<meta name="theme-color" content="#0e6677" />
<link rel="icon" href="icon-512.png" />
<link rel="manifest" href="manifest.json" />
<!-- jsPDF för PDF-export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" referrerpolicy="no-referrer"></script>
<style>
:root{
  --brand:#0e6677;--bg:#f6f7f9;--card:#fff;--text:#1f2937;--muted:#6b7280;--danger:#b91c1c;--line:#e5e7eb;--accent:#0a515f;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

/* Header */
header{position:sticky;top:0;z-index:30;background:var(--brand);color:#fff;display:flex;align-items:center;gap:.75rem;padding:.85rem 1rem}
.hamb,.helpbtn{width:40px;height:40px;border-radius:.6rem;background:var(--accent);border:none;color:#fff;font-size:1.1rem;display:grid;place-items:center;cursor:pointer}
header h1{margin:0;font-size:1.2rem;letter-spacing:.2px;flex:1}

/* Layout & Cards */
main{max-width:1100px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
.card{background:var(--card);border:1px solid var(--line);border-radius:.9rem;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:1rem}
.grid{display:grid;gap:.75rem}
@media(min-width:760px){.grid{grid-template-columns:repeat(6,1fr)}}
label{font-size:.85rem;color:var(--muted);display:block;margin-bottom:.2rem}
input,select,textarea,button{font-size:1rem}
input,select,textarea{width:100%;padding:.6rem .7rem;border:1px solid #cbd5e1;border-radius:.6rem;background:#fff}
textarea{min-height:42px;resize:vertical}
.actions{display:flex;gap:.5rem;flex-wrap:wrap}
.btn{border:0;border-radius:.6rem;padding:.55rem .8rem;font-weight:600;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.ghost{background:#eef2f7}
.btn.danger{background:var(--danger);color:#fff}

/* Tabell */
table{width:100%;border-collapse:collapse;font-size:.95rem}
th,td{padding:.55rem;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
th{font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
tr.warn td{background:#fff7ed}
tr.weekend td{background:#f3f4f6}
tr.holiday td{background:#ffeef0}
tfoot td{background:#f0f9ff;font-weight:700}
.small{font-size:.85rem;color:var(--muted)}

/* Larm-pillars */
.pill{display:inline-flex;align-items:center;gap:.4rem;font-size:.85rem;border-radius:.5rem;padding:.15rem .5rem;font-weight:600;width:max-content}
.pill .dot{width:.55rem;height:.55rem;border-radius:999px;display:inline-block}
.pill.red{background:#fee2e2;color:#7f1d1d}
.pill.orange{background:#ffedd5;color:#7c2d12}
.pill.green{background:#dcfce7;color:#065f46}
.pill.blue{background:#dbeafe;color:#1e3a8a}
.pill.rose{background:#ffe4e6;color:#9f1239}
#alarms .pills{display:grid;gap:.25rem}

/* Meny */
aside#menu{
  position:fixed;top:0;left:0;width:min(420px,92%);height:100%;
  background:var(--card);border-right:1px solid var(--line);
  transform:translateX(-100%);transition:.25s ease;z-index:200;overflow:auto
}
aside#menu.open{transform:translateX(0)}
details summary{cursor:pointer;padding:.6rem .9rem}
details > .content{padding:.4rem .9rem .9rem}

/* Hjälp-overlay (ej använd här – hjälp är egen sida) */
#helpOverlay{display:none}

/* Sökvy */
#searchView{display:none}
.search-head{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:.6rem}
.search-head input{flex:1}
.search-actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}

@media print{ header,aside{display:none!important} }
</style>
</head>
<body>
<header>
  <button class="hamb" aria-label="Meny" onclick="toggleMenu(true)">☰</button>
  <h1>Tidrapport</h1>
  <a class="helpbtn" aria-label="Hjälp" href="help.html" title="Hjälp">ℹ️</a>
</header>

<aside id="menu" onclick="if(event.target.id==='menu')toggleMenu(false)">
  <div style="padding:.6rem .9rem;display:flex;align-items:center;gap:.6rem;border-bottom:1px solid var(--line)">
    <strong>☰ Meny</strong>
    <span style="margin-left:auto"></span>
    <button class="btn ghost" onclick="toggleMenu(false)">Stäng</button>
  </div>

  <!-- Månad -->
  <details open>
    <summary>📅 Månad</summary>
    <div class="content">
      <div style="display:flex;gap:.5rem;align-items:center">
        <label for="menuMonth" style="margin:0;color:var(--muted)">Välj månad</label>
        <select id="menuMonth" onchange="changeMonth()"></select>
      </div>
      <div class="actions" style="margin-top:.6rem">
        <button class="btn ghost" onclick="scrollToMain()">Visa aktuell månad</button>
      </div>
    </div>
  </details>

  <!-- År -->
  <details>
    <summary>📆 År</summary>
    <div class="content">
      <div class="actions">
        <button class="btn ghost" onclick="scrollToYear()">Hoppa till årsöversikt</button>
        <button class="btn ghost" onclick="createYear()">Skapa nytt år</button>
        <button class="btn ghost" onclick="deleteYear()">Återställ till innevarande år</button>
      </div>
    </div>
  </details>

  <!-- Sök -->
  <details>
    <summary>🔍 Sök</summary>
    <div class="content">
      <button class="btn ghost" onclick="openSearch()">Öppna sök</button>
    </div>
  </details>

  <!-- Export -->
  <details>
    <summary>📤 Export</summary>
    <div class="content">
      <div class="actions">
        <button class="btn ghost" onclick="exportMonthReport()">📑 Månadsrapport (CSV)</button>
        <button class="btn ghost" onclick="exportYearReportCombined()">🗓️ Årsrapport (CSV)</button>
        <button class="btn ghost" onclick="shareMonthPdfEmail()">📝 PDF Månadsrapport</button>
        <button class="btn ghost" onclick="shareYearPdfEmail()">📝 PDF Årsrapport</button>
      </div>
    </div>
  </details>

  <!-- Import -->
  <details>
    <summary>📥 Import</summary>
    <div class="content">
      <div class="actions">
        <label class="btn ghost">
          📑 Importera CSV
          <input id="fileCsv" type="file" accept=".csv,text/csv" onchange="importCSV(event)" style="display:none">
        </label>
        <label class="btn ghost">
          ☁️ Importera JSON (backup)
          <input id="fileJson" type="file" accept=".json,application/json" onchange="importJSON(event)" style="display:none">
        </label>
      </div>
    </div>
  </details>

  <!-- Inställningar -->
  <details>
    <summary>⚙️ Inställningar</summary>
    <div class="content">
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div><label>🏢 Företag</label><input id="cfgCompany"></div>
        <div><label>👤 Namn</label><input id="cfgName"></div>
        <div><label>🆔 Anst-Nr</label><input id="cfgEmp"></div>
        <div><label>🔑 Ägar-ID</label><input id="cfgOwner"></div>
        <div><label>📅 År</label><input id="cfgYear" type="number" inputmode="numeric"></div>
        <div style="display:flex;align-items:center;gap:.5rem;margin-top:1.6rem">
          <input id="cfgAutoBackup" type="checkbox"><label for="cfgAutoBackup" style="margin:0">🔄 Auto-backup</label>
        </div>
        <div style="grid-column:1/-1"><label>📝 Notering</label><textarea id="cfgNote"></textarea></div>
      </div>
      <div class="actions" style="margin-top:.6rem">
        <button class="btn primary" onclick="saveSettings()">Spara</button>
        <button class="btn ghost" onclick="resetSettings()">Rensa inställningar</button>
      </div>
    </div>
  </details>

  <!-- Backup -->
  <details>
    <summary>☁️ Backup</summary>
    <div class="content">
      <div class="actions">
        <button class="btn ghost" onclick="quickBackup()">Snabbbackup (JSON)</button>
        <button class="btn ghost" onclick="shareJSON()">Dela backup</button>
      </div>
    </div>
  </details>

  <!-- Hjälp -->
  <details>
    <summary>ℹ️ Hjälp</summary>
    <div class="content">
      <a class="btn ghost" href="help.html">Öppna manual</a>
    </div>
  </details>

  <div style="height:2rem"></div>
</aside>

<main>
  <!-- Inmatning -->
  <section class="card" id="mainView">
    <div class="grid">
      <div><label for="datum">Datum</label><input type="date" id="datum" /></div>
      <div><label for="kategori">Kategori</label>
        <select id="kategori">
          <option>Ordinarie tid</option><option>Semester-tim</option><option>ATF-tim</option>
          <option>Sjuk-tim</option><option>Föräldraledig</option><option>VAB</option>
          <option>Flextid</option><option>Övertid <2</option><option>Övertid 2></option>
          <option>Övertid-Helg</option><option>Traktamente</option>
        </select>
      </div>
      <div><label for="tid">Tid</label><input id="tid" type="text" inputmode="numeric" /></div>
      <div><label for="projekt">Projekt nr</label><input id="projekt" /></div>
      <div><label for="kortid">Körtid</label><input id="kortid" type="text" inputmode="numeric" /></div>
      <div><label for="beskrivning">Beskrivning</label><input id="beskrivning" /></div>
    </div>
    <div class="actions" style="margin-top:.6rem">
      <button class="btn primary" id="btnAdd">Lägg till</button>
      <button class="btn ghost" id="btnBackup">Gör backup</button>
      <button class="btn ghost" id="btnCancel" style="display:none">Avbryt</button>
    </div>
  </section>

  <!-- Tabell -->
  <section class="card">
    <table>
      <thead><tr><th>Datum</th><th>Projekt</th><th>Kategori</th><th>Tid</th><th>Körtid</th><th>Beskrivning</th><th>Åtgärd</th></tr></thead>
      <tbody id="rows"></tbody>
      <tfoot><tr><td colspan="7" id="totalsCell">Summering visas här…</td></tr></tfoot>
    </table>
  </section>

  <!-- Larm & kontroller -->
  <section class="card">
    <strong>Larm & kontroller</strong>
    <div id="alarms" class="small">Inga varningar.</div>
  </section>

  <!-- Årsöversikt -->
  <section class="card" id="yearView">
    <strong>Årsöversikt</strong>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Månad</th><th>Ordinarie</th><th>Semester</th><th>ATF</th><th>Sjuk</th><th>Föräldraledig</th>
            <th>VAB</th><th>Flextid</th><th>ÖT&lt;2</th><th>ÖT2&gt;</th><th>ÖT-Helg</th><th>Trakt (st)</th><th>Körtid</th>
          </tr>
        </thead>
        <tbody id="yearBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Sökvy -->
  <section class="card" id="searchView">
    <div class="search-head">
      <input id="searchQuery" placeholder="Sök i alla månader/år (datum, projekt, kategori, beskrivning)..." />
      <button class="btn primary" onclick="performSearch()">Sök</button>
      <button class="btn ghost" onclick="closeSearch()">Stäng</button>
    </div>
    <div class="search-actions">
      <button class="btn ghost" onclick="exportSearchCsv()">Exportera träffar (CSV)</button>
      <button class="btn ghost" onclick="shareSearchCsv()">Dela träffar</button>
    </div>
    <div style="margin-top:.6rem;overflow:auto">
      <table>
        <thead><tr><th>Datum</th><th>Projekt</th><th>Kategori</th><th>Tid</th><th>Körtid</th><th>Beskrivning</th></tr></thead>
        <tbody id="searchRows"></tbody>
        <tfoot><tr><td colspan="6" id="searchTotals">0 rader</td></tr></tfoot>
      </table>
    </div>
  </section>
</main>

<script src="app.js"></script>
<script src="export.js"></script>
<script src="backup.js"></script>
<script>
  const scrollToMain=()=>document.getElementById('mainView')?.scrollIntoView({behavior:'smooth'});
  const scrollToYear=()=>document.getElementById('yearView')?.scrollIntoView({behavior:'smooth'});
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js").catch(err=>console.error("SW fail:", err));
  }
</script>
</body>
</html>