<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tidrapport</title>

<!-- PWA / App-ikon -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0e6677">
<link rel="icon" href="icon-512.png">

<!-- jsPDF för PDF-export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" referrerpolicy="no-referrer"></script>

<style>
:root{
  --brand:#0e6677;--bg:#f6f7f9;--card:#fff;--text:#1f2937;
  --muted:#6b7280;--danger:#b91c1c;--line:#e5e7eb;--accent:#0a515f;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{position:sticky;top:0;z-index:30;background:var(--brand);color:#fff;display:flex;align-items:center;gap:.75rem;padding:.85rem 1rem}
.hamb{width:40px;height:40px;border-radius:.6rem;background:var(--accent);border:none;color:#fff;font-size:1.25rem;display:grid;place-items:center}
h1{margin:0;font-size:1.25rem;letter-spacing:.2px}
main{max-width:1100px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
.card{background:var(--card);border:1px solid var(--line);border-radius:.9rem;box-shadow:0 1px 2px rgba(0,0,0,.03);padding:1rem}
.grid{display:grid;gap:.75rem}
@media(min-width:760px){.grid{grid-template-columns:repeat(6,1fr)}}
label{font-size:.85rem;color:var(--muted);display:block;margin-bottom:.2rem}
input,select,textarea,button{font-size:1rem}
input,select,textarea{width:100%;padding:.6rem .7rem;border:1px solid #cbd5e1;border-radius:.6rem;background:#fff}
textarea{min-height:42px;resize:vertical}
.actions{display:flex;gap:.5rem;flex-wrap:wrap}
.btn{border:0;border-radius:.6rem;padding:.55rem .8rem;font-weight:600;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.ghost{background:#eef2f7}
.btn.danger{background:var(--danger);color:#fff}
table{width:100%;border-collapse:collapse;font-size:.95rem}
th,td{padding:.55rem;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
th{font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
tr.warn td{background:#fff7ed}
tr.weekend td{background:#f3f4f6}
tr.holiday td{background:#ffeef0}
tfoot td{background:#f0f9ff;font-weight:700}
.small{font-size:.85rem;color:var(--muted)}

.pill{display:inline-flex;align-items:center;gap:.4rem;font-size:.85rem;border-radius:.5rem;padding:.15rem .5rem;font-weight:600;width:max-content}
.pill .dot{width:.55rem;height:.55rem;border-radius:999px;display:inline-block}
.pill.red{background:#fee2e2;color:#7f1d1d}
.pill.orange{background:#ffedd5;color:#7c2d12}
.pill.green{background:#dcfce7;color:#065f46}
.pill.blue{background:#dbeafe;color:#1e3a8a}
.pill.rose{background:#ffe4e6;color:#9f1239}
#alarms .pills{display:grid;gap:.25rem}

aside#menu{
  position:fixed;top:0;left:0;width:min(420px,92%);height:100%;
  background:var(--card);border-right:1px solid var(--line);
  transform:translateX(-100%);transition:.25s ease;z-index:200;overflow:auto
}
aside#menu.open{transform:translateX(0)}
/* Overlay för att stänga menyn vid klick utanför */
#overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.35);
  backdrop-filter:blur(1px);
  opacity:0; pointer-events:none; transition:.2s ease;
  z-index:150;
}
#overlay.show{ opacity:1; pointer-events:auto; }

@media print{ header,aside,#overlay{display:none!important} }
</style>
</head>
<body>
<header>
  <button class="hamb" aria-label="Meny" onclick="toggleMenu(true)">☰</button>
  <h1>Tidrapport</h1>
</header>

<main>
  <!-- Inmatning -->
  <div class="card">
    <div class="grid">
      <div><label for="datum">Datum</label><input type="date" id="datum"></div>
      <div><label for="kategori">Kategori</label>
        <select id="kategori">
          <option>Ordinarie tid</option><option>Semester-tim</option><option>ATF-tim</option>
          <option>Sjuk-tim</option><option>Föräldraledig</option><option>VAB</option>
          <option>Flextid</option><option>Övertid &lt;2</option><option>Övertid 2&gt;</option>
          <option>Övertid-Helg</option><option>Traktamente</option>
        </select>
      </div>
      <div><label for="tid">Tid</label><input id="tid" type="text" inputmode="numeric" placeholder="0,25-steg – minus tillåtet"></div>
      <div><label for="projekt">Projekt nr</label><input id="projekt" placeholder="Bokstäver/siffror (inga mellanslag)"></div>
      <div><label for="kortid">Körtid</label><input id="kortid" type="text" inputmode="numeric" placeholder="0,25-steg – minus tillåtet"></div>
      <div><label for="beskrivning">Beskrivning</label><input id="beskrivning" placeholder="Fritext"></div>
    </div>
    <div class="actions" style="margin-top:.6rem">
      <button class="btn primary" id="btnAdd">Lägg till</button>
      <button class="btn ghost" id="btnBackup">Gör backup</button>
      <button class="btn ghost" id="btnCancel" style="display:none">Avbryt</button>
    </div>
  </div>

  <!-- Tabell -->
  <div class="card">
    <table>
      <thead><tr><th>Datum</th><th>Projekt</th><th>Kategori</th><th>Tid</th><th>Körtid</th><th>Beskrivning</th><th>Åtgärd</th></tr></thead>
      <tbody id="rows"></tbody>
      <tfoot><tr><td colspan="7" id="totalsCell">Summering visas här…</td></tr></tfoot>
    </table>
  </div>

  <!-- Larm & kontroller -->
  <div class="card">
    <strong>Larm & kontroller</strong>
    <div id="alarms" class="small">Inga varningar.</div>
    <div class="small" style="margin-top:.5rem">
      <span class="pill blue"><span class="dot"></span>Helg</span>
      <span class="pill rose"><span class="dot"></span>Röd dag</span>
      <span class="pill orange"><span class="dot"></span>Vardag &lt; 8h</span>
      <span class="pill red"><span class="dot"></span>Saknas</span>
      <span class="pill green"><span class="dot"></span>OK</span>
    </div>
  </div>

  <!-- Årsöversikt -->
  <div class="card">
    <strong>Årsöversikt</strong>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Månad</th><th>Ordinarie</th><th>Semester</th><th>ATF</th><th>Sjuk</th><th>Föräldraledig</th>
            <th>VAB</th><th>Flextid</th><th>ÖT&lt;2</th><th>ÖT2&gt;</th><th>ÖT-Helg</th><th>Trakt (st)</th><th>Körtid</th>
          </tr>
        </thead>
        <tbody id="yearBody"></tbody>
      </table>
    </div>
  </div>
</main>

<!-- Meny (vänster) -->
<aside id="menu">
  <div style="padding:1rem;border-bottom:1px solid #ddd;display:flex;justify-content:space-between">
    <strong>Meny</strong>
    <button class="hamb" onclick="toggleMenu(false)">✕</button>
  </div>
  <div style="padding:1rem;display:grid;gap:1rem">

    <details open>
      <summary>Månad</summary>
      <div class="content">
        <select id="menuMonth" class="select"></select>
        <button class="btn ghost menu-btn" onclick="changeMonth()">Byt månad</button>
      </div>
    </details>

    <details>
      <summary>Inställningar</summary>
      <div class="content">
        <label>Företag<input id="cfgCompany"></label>
        <label>Namn<input id="cfgName" placeholder="För- och efternamn"></label>
        <label>Anst-Nr<input id="cfgEmp"></label>
        <label>Ägar-ID<input id="cfgOwner" placeholder="t.ex. martin, mm, anna-l"></label>
        <label>År<input id="cfgYear" inputmode="numeric" placeholder="t.ex. 2025"></label>
        <label>Extra notering<textarea id="cfgNote"></textarea></label>

        <label style="display:flex;gap:.5rem;align-items:center">
          <input type="checkbox" id="cfgAutoBackup" checked> Automatisk lokal backup
        </label>

        <div class="actions">
          <button class="btn ghost" onclick="quickBackup()">Gör backup</button>
          <button class="btn ghost" onclick="saveSettings()">Spara</button>
          <button class="btn danger" onclick="resetSettings()">Rensa inställningar</button>
          <button class="btn danger" onclick="resetAll()">Rensa all data</button>
        </div>

        <div class="actions">
          <button class="btn ghost" onclick="createYear()">Skapa nytt år</button>
          <button class="btn danger" onclick="deleteYear()">Ta bort år</button>
        </div>
      </div>
    </details>

    <details>
      <summary>Exportera</summary>
      <div class="content">
        <button class="btn ghost menu-btn" onclick="exportMonthReport()">Export Månadsrapport (CSV)</button>
        <button class="btn ghost menu-btn" onclick="exportYearReportCombined()">Export Årsrapport (CSV)</button>
        <button class="btn ghost menu-btn" onclick="exportExcelStyleMonth()">Export Excel-stil – månad</button>
      </div>
    </details>

    <details>
      <summary>Dela</summary>
      <div class="content">
        <button class="btn ghost menu-btn" onclick="shareMonthReport()">Dela – Månadsrapport (CSV)</button>
        <button class="btn ghost menu-btn" onclick="shareYearReport()">Dela – Årsrapport (CSV)</button>
        <hr class="sep" style="border:0;border-top:1px dashed #e5e7eb">
        <button class="btn ghost menu-btn" onclick="shareMonthPdfEmail()">Dela som PDF – Månadsrapport (mail)</button>
        <button class="btn ghost menu-btn" onclick="shareYearPdfEmail()">Dela som PDF – Årsrapport (mail)</button>
        <hr class="sep" style="border:0;border-top:1px dashed #e5e7eb">
        <button class="btn ghost menu-btn" onclick="createEmlDraft()">Skapa e-postutkast (.eml)</button>
      </div>
    </details>

    <details>
      <summary>Import/Backup</summary>
      <div class="content">
        <div class="small">CSV: första rad <code>sep=;</code> + rubriker.</div>
        <input type="file" id="fileImport" accept=".csv" onchange="importCSV(event)">
        <div class="small" style="margin-top:.5rem">Backup JSON:</div>
        <button class="btn ghost menu-btn" onclick="exportJSON()">Exportera backup (JSON)</button>
        <input type="file" id="fileJson" accept="application/json" onchange="importJSON(event)">
        <button class="btn ghost menu-btn" onclick="shareJSON()">Dela (mobil) – JSON</button>
      </div>
    </details>

    <details>
      <summary>Manual / Hjälp</summary>
      <div class="content">
        <p class="small">📘 Kort instruktion: fyll rader ovan, exportera via menyn. Delning funkar bäst i mobil (Web Share API). Offline funkar via service worker.</p>
      </div>
    </details>

    <div class="small" style="text-align:center">
      <hr class="sep" style="border:0;border-top:1px dashed #e5e7eb">
      🔨 Tillverkad i samarbete med <strong>ChatGPT & Martin Mattsson</strong>
    </div>
  </div>
</aside>

<!-- Overlay för att stänga menyn vid klick utanför -->
<div id="overlay" onclick="toggleMenu(false)"></div>

<script>
(()=>{
// ===== Utils & konstanter =====
const monthsSv=["januari","februari","mars","april","maj","juni","juli","augusti","september","oktober","november","december"];
const CSV_COLS=["Datum","Ordinarie tid","Körtid","Projekt","Semester-tim","ATF-tim","Sjuk-tim","Föräldraledig","VAB","Flextid","Övertid <2","Övertid 2>","Övertid-Helg","Traktamente","Beskrivning"];
const STORAGE="tidrapport_data_v10";
const SETTINGS="tidrapport_settings_v10";
const $=id=>document.getElementById(id);
const cap=s=>s.charAt(0).toUpperCase()+s.slice(1);

// Format (UI) — 0 visas tomt, minus bevaras
const fmtBlankZero = n => {
  const v = Number(n) || 0;
  if (v === 0) return "";
  return (Math.round(v*100)/100).toLocaleString("sv-SE",{minimumFractionDigits:0, maximumFractionDigits:2});
};
// Format (CSV) — 0 blir tomt, minus bevaras, punkt→komma
const fmtExport = n => {
  if (n==null || n==="") return "";
  const v = Number(String(n).replace(",", "."));
  if (!Number.isFinite(v) || v===0) return "";
  return v.toString().replace(".", ",");
};
const csvEscape=s=>{s=s==null?"":String(s).replace(/\r?\n/g," "); if(/[";]/.test(s)) s='"'+s.replace(/"/g,'""')+'"'; return s;};

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }

// ===== State =====
let state={month:(new Date().getMonth()+1), data:load(STORAGE,{}), settings:load(SETTINGS,defSettings())};
function defSettings(){return{company:"",name:"",emp:"",owner:"",year:new Date().getFullYear(),note:"",autoBackup:true,holidays:true}}
function load(k,def){try{const v=JSON.parse(localStorage.getItem(k));return v??def}catch(_){return def}}
function saveData(){ localStorage.setItem(STORAGE,JSON.stringify(state.data)); if(state.settings.autoBackup) localStorage.setItem("tidrapport_last_update",Date.now()); }
function saveCfg(){ localStorage.setItem(SETTINGS,JSON.stringify(state.settings)); if(state.settings.autoBackup) localStorage.setItem("tidrapport_last_update",Date.now()); }
function ensureMonth(m){ if(!state.data[m]) state.data[m]=[] }

// ===== Meny =====
window.toggleMenu=(open)=>{
  const el=$("menu"); if(!el) return;
  el.classList.toggle("open",open);
  const ov=$("overlay"); if(ov) ov.classList.toggle("show",open);
  if(open) initMenu();
};
function initMenu(){
  const sel=$("menuMonth");
  if(sel){
    sel.innerHTML="";
    monthsSv.forEach((n,i)=>{
      const o=document.createElement("option");
      o.value=i+1; o.textContent=cap(n); if(i+1===state.month) o.selected=true;
      sel.appendChild(o);
    });
  }
  $("cfgCompany").value=state.settings.company||"";
  $("cfgName").value=state.settings.name||"";
  $("cfgEmp").value=state.settings.emp||"";
  $("cfgOwner").value=state.settings.owner||"";
  $("cfgYear").value=state.settings.year||"";
  $("cfgNote").value=state.settings.note||"";
  $("cfgAutoBackup").checked = state.settings.autoBackup!==false;
}
window.changeMonth=()=>{ state.month=Number($("menuMonth").value)||state.month; renderAll(); toggleMenu(false); }

// ===== Settings =====
window.saveSettings=()=>{
  state.settings.company=$("cfgCompany").value.trim();
  state.settings.name=$("cfgName").value.trim();
  state.settings.emp=$("cfgEmp").value.trim();
  state.settings.owner=$("cfgOwner").value.trim();
  state.settings.year=Number($("cfgYear").value)||new Date().getFullYear();
  state.settings.note=$("cfgNote").value;
  state.settings.autoBackup=$("cfgAutoBackup").checked;
  saveCfg(); renderAll();
};
window.resetSettings=()=>{
  if(!confirm("Rensa inställningar?\nDina inmatade rader påverkas inte.")) return;
  state.settings = defSettings(); saveCfg(); initMenu(); renderAll();
  alert("Inställningarna rensade.");
};
window.resetAll=async()=>{
  const input=prompt("⚠️ RADERA ALL DATA.\nSkriv: RADERA ALLT");
  if(input!=="RADERA ALLT") return;
  try{
    const pre=new Blob([JSON.stringify({settings:state.settings,data:state.data},null,2)],{type:"application/json"});
    download(`tidrapport_pre_reset_${Date.now()}.json`, pre);
  }catch(_){}
  state.data={}; for(let m=1;m<=12;m++) ensureMonth(m);
  saveData(); renderAll(); alert("All data rensad.");
};
window.createYear=()=>{ const y=Number(prompt("Skapa nytt år:", (state.settings.year||new Date().getFullYear())+1)); if(!y) return; state.settings.year=y; saveCfg(); renderAll(); };
window.deleteYear=()=>{ if(!confirm("År återställs till innevarande år (data ligger kvar)."))return; state.settings.year=new Date().getFullYear(); saveCfg(); renderAll(); };
window.quickBackup=()=>exportJSON();

// ===== Input helpers =====
function normMinus(s){return (s||"").replace(/[–—−]/g,"-")}
function toNumRaw(s){ if(s==null) return NaN; s=normMinus((""+s).replace(/\s+/g,"")).replace(",","."); if(!/^[-]?\d*(\.\d+)?$/.test(s)) return NaN; return s===""?NaN:parseFloat(s); }
function roundQuarter(n){return Math.round(n*4)/4}
function parseHourInput(v,allowEmpty=false){ if(allowEmpty && (v===""||v==null)) return 0; const n=toNumRaw(v); if(isNaN(n)) return NaN; return roundQuarter(n); }
function sanitizeProject(s){ s=(s||"").normalize("NFC").replace(/\s+/g,""); s=s.replace(/[^0-9A-Za-zÅÄÖåäö]/g,""); return s; }

// ===== Add/Edit/Delete =====
const btnAdd=$("btnAdd"); const btnCancel=$("btnCancel"); const btnBackup=$("btnBackup");
btnAdd.addEventListener("click", () => {
  const d=$("datum").value; if(!d){ alert("Välj datum."); return; }
  const k=$("kategori").value;
  const t=parseHourInput($("tid").value); if(isNaN(t)){ alert("Ogiltig Tid."); return; }
  const p=sanitizeProject($("projekt").value);
  const kt=parseHourInput($("kortid").value,true); if(isNaN(kt)){ alert("Ogiltig Körtid."); return; }
  const b=$("beskrivning").value||"";
  const m=(new Date(d)).getMonth()+1; ensureMonth(m);

  if (editing){
    const list=state.data[editing.month]||[]; const idx=list.findIndex(r=>r._id===editing.id);
    if(idx!==-1){
      list[idx]={...list[idx], datum:d,kategori:k,tid:t,projekt:p,kortid:kt,beskrivning:b};
      if (editing.month!==m){ const row=list.splice(idx,1)[0]; ensureMonth(m); state.data[m].push(row); state.month=m; }
      saveData();
    }else{
      state.data[m].push({_id:uid(), datum:d,kategori:k,tid:t,projekt:p,kortid:kt,beskrivning:b}); saveData();
    }
    exitEditMode(); renderAll();
  } else {
    state.data[m].push({_id:uid(), datum:d,kategori:k,tid:t,projekt:p,kortid:kt,beskrivning:b});
    saveData(); clearInputs(); state.month=m; renderAll();
  }
});
btnCancel.addEventListener("click", ()=>{ exitEditMode(); clearInputs(); });
btnBackup.addEventListener("click", ()=>{ quickBackup(); });

function enterEditMode(row, month){ editing={id:row._id, month}; btnAdd.textContent="Spara"; btnCancel.style.display=""; }
function exitEditMode(){ editing=null; btnAdd.textContent="Lägg till"; btnCancel.style.display="none"; }
function clearInputs(){["datum","tid","projekt","kortid","beskrivning"].forEach(id=>$(id).value=""); $("kategori").selectedIndex=0;}
let editing=null;

// ===== Helg & röda dagar (SE) =====
function easterSunday(y){const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),n=h+l-7*m+114;return new Date(y,Math.floor(n/31)-1,(n%31)+1)}
function addDays(date,days){const d=new Date(date); d.setDate(d.getDate()+days); return d}
function swedishHolidays(y){
  const H=new Map(); const add=(d, name)=>H.set(d.toISOString().slice(0,10),name);
  add(new Date(y,0,1),"Nyårsdagen"); add(new Date(y,0,6),"Trettondedag jul"); add(new Date(y,4,1),"Första maj");
  add(new Date(y,5,6),"Sveriges nationaldag"); add(new Date(y,11,25),"Juldagen"); add(new Date(y,11,26),"Annandag jul");
  const eas=easterSunday(y); add(addDays(eas,-2),"Långfredagen"); add(addDays(eas,1),"Annandag påsk"); add(addDays(eas,39),"Kristi himmelsfärdsdag");
  let mid=new Date(y,5,20); while(mid.getDay()!=6) mid=addDays(mid,1); add(mid,"Midsommardagen");
  let saints=new Date(y,9,31); while(saints.getDay()!=6) saints=addDays(saints,1); add(saints,"Alla helgons dag");
  return H;
}

// ===== Render =====
function yearFilter(r){ return (new Date(r.datum)).getFullYear() === (Number(state.settings.year)||new Date().getFullYear()); }
function calcMonthTotals(m){
  ensureMonth(m); const res={_kortid:0,"Traktamente":0};
  (state.data[m]||[]).filter(yearFilter).forEach(r=>{
    res[r.kategori]=(res[r.kategori]||0)+Number(r.tid||0);
    res._kortid+=Number(r.kortid||0);
  });
  return res;
}
function renderTable(){
  const m=state.month; ensureMonth(m); const y=state.settings.year;
  const tb=$("rows"); tb.innerHTML="";
  const rows=[...(state.data[m]||[]).filter(yearFilter)].sort((a,b)=>a.datum.localeCompare(b.datum));

  const daySum={}; rows.forEach(r=>{daySum[r.datum]=(daySum[r.datum]||0)+Number(r.tid||0)});
  const H= state.settings.holidays!==false ? swedishHolidays(y) : new Map();

  rows.forEach((r)=>{
    const tr=document.createElement("tr");
    const d=new Date(r.datum); const dow=d.getDay(); const iso=r.datum;
    const isWeekend=(dow===0||dow===6); const isHoliday= H.has(iso);
    if(isWeekend) tr.classList.add("weekend");
    if(isHoliday) tr.classList.add("holiday");
    if(!isWeekend && !isHoliday && (daySum[r.datum]||0)<8) tr.classList.add("warn");
    const hname=isHoliday?` <span class="pill rose"><span class="dot"></span>${H.get(iso)}</span>`:"";
    tr.innerHTML=`<td>${r.datum}${hname}</td><td>${escapeHtml(r.projekt||"")}</td><td>${r.kategori}</td>
      <td>${fmtBlankZero(r.tid)}</td><td>${fmtBlankZero(r.kortid)}</td><td>${escapeHtml(r.beskrivning||"")}</td>
      <td class="actions">
        <button class="btn ghost" onclick="APP.editRow('${r._id}', ${m})">Ändra</button>
        <button class="btn danger" onclick="APP.delRow('${r._id}', ${m})">Ta bort</button>
      </td>`;
    tb.appendChild(tr);
  });

  const t=calcMonthTotals(m);
  document.getElementById("totalsCell").textContent=
    `Summering — Ordinarie: ${fmtBlankZero(t["Ordinarie tid"])} | Semester: ${fmtBlankZero(t["Semester-tim"])} | ATF: ${fmtBlankZero(t["ATF-tim"])} | `+
    `Sjuk: ${fmtBlankZero(t["Sjuk-tim"])} | Föräldraledig: ${fmtBlankZero(t["Föräldraledig"])} | VAB: ${fmtBlankZero(t["VAB"])} | Flextid: ${fmtBlankZero(t["Flextid"])} | `+
    `ÖT<2: ${fmtBlankZero(t["Övertid <2"])} | ÖT2>: ${fmtBlankZero(t["Övertid 2>"])} | ÖT-Helg: ${fmtBlankZero(t["Övertid-Helg"])} | Trakt (st): ${fmtBlankZero(t["Traktamente"])} | `+
    `Körtid: ${fmtBlankZero(t._kortid)}`;

  renderYear(); renderAlarms(); initMenu();
}
function renderYear(){
  const tb=$("yearBody"); tb.innerHTML="";
  for(let m=1;m<=12;m++){
    const t=calcMonthTotals(m);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${cap(monthsSv[m-1])}</td>
      <td>${fmtBlankZero(t["Ordinarie tid"])}</td><td>${fmtBlankZero(t["Semester-tim"])}</td><td>${fmtBlankZero(t["ATF-tim"])}</td>
      <td>${fmtBlankZero(t["Sjuk-tim"])}</td><td>${fmtBlankZero(t["Föräldraledig"])}</td><td>${fmtBlankZero(t["VAB"])}</td><td>${fmtBlankZero(t["Flextid"])}</td>
      <td>${fmtBlankZero(t["Övertid <2"])}</td><td>${fmtBlankZero(t["Övertid 2>"])}</td><td>${fmtBlankZero(t["Övertid-Helg"])}</td>
      <td>${fmtBlankZero(t["Traktamente"])}</td><td>${fmtBlankZero(t._kortid)}</td>`;
    tb.appendChild(tr);
  }
}
function renderAlarms(){
  const m=state.month; ensureMonth(m);
  const y=state.settings.year||new Date().getFullYear();
  const H = state.settings.holidays!==false ? swedishHolidays(y) : new Map();

  const map={};
  (state.data[m]||[]).filter(yearFilter).forEach(r=>{ const d=r.datum; map[d]=(map[d]||0)+Number(r.tid||0); });

  const last=new Date(y,m,0).getDate();
  const lines=[];
  for(let d=1; d<=last; d++){
    const iso=`${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const dow=new Date(iso).getDay();
    const isWeekend=(dow===0||dow===6);
    const isHoliday=H.has(iso);
    const sum=map[iso]||0;

    let cls="", label="";
    if (isHoliday){ cls="rose"; label=`Röd dag (${H.get(iso)})`; }
    else if (isWeekend){ cls="blue"; label="Helg"; }
    else if(map[iso]==null){ cls="red"; label="Saknas"; }
    else if(sum<8){ cls="orange"; label=`Under 8h (${fmtBlankZero(sum)}h)`; }
    else {
      cls="green";
      const extra = sum>8 ? ` — +${fmtBlankZero(sum-8)}h` : "";
      label=`OK (8h)${extra}`;
    }

    const extra = (isWeekend||isHoliday) ? (sum>0 ? ` — ${fmtBlankZero(sum)}h registrerat` : "") : "";
    lines.push(`<div class="pill ${cls}"><span class="dot"></span><span>${iso} — ${label}${extra}</span></div>`);
  }

  $("alarms").innerHTML = lines.length ? `<div class="pills">${lines.join("")}</div>` : "Inga varningar för denna månad.";
}
function renderAll(){renderTable()}

// ===== CSV helpers =====
function sortedRows(months){
  const out=[]; months.forEach(m=>{ensureMonth(m); (state.data[m]||[]).filter(yearFilter).forEach(r=>out.push({...r,_m:m}))});
  out.sort((a,b)=>{const c=a.datum.localeCompare(b.datum); if(c) return c; const p=(a.projekt||"").localeCompare(b.projekt||""); if(p) return p; return (a.kategori||"").localeCompare(b.kategori||"");});
  return out;
}
function buildCsv(scope){
  const months = scope==="year" ? Array.from({length:12},(_,i)=>i+1) : [state.month];
  const lines=[CSV_COLS.join(";")];

  // Rader
  sortedRows(months).forEach(r=>{
    const cat=r.kategori||"";
    const V = want => fmtExport(cat===want ? r.tid : "");
    const row=[
      r.datum,
      V("Ordinarie tid"),
      fmtExport(r.kortid),
      csvEscape(r.projekt||""),
      V("Semester-tim"),V("ATF-tim"),V("Sjuk-tim"),V("Föräldraledig"),
      V("VAB"),V("Flextid"),V("Övertid <2"),V("Övertid 2>"),
      V("Övertid-Helg"),V("Traktamente"),
      csvEscape(r.beskrivning||"")
    ];
    lines.push(row.join(";"));
  });

  // SUMMA-rad (månad/år)
  const sum={};
  sortedRows(months).forEach(r=>{
    const add=(k,v)=> sum[k]=(sum[k]||0)+(Number(v)||0);
    if(r.kategori==="Ordinarie tid") add("Ordinarie tid",r.tid);
    if(r.kortid) add("Körtid",r.kortid);
    if(r.kategori==="Semester-tim") add("Semester-tim",r.tid);
    if(r.kategori==="ATF-tim") add("ATF-tim",r.tid);
    if(r.kategori==="Sjuk-tim") add("Sjuk-tim",r.tid);
    if(r.kategori==="Föräldraledig") add("Föräldraledig",r.tid);
    if(r.kategori==="VAB") add("VAB",r.tid);
    if(r.kategori==="Flextid") add("Flextid",r.tid);
    if(r.kategori==="Övertid <2") add("Övertid <2",r.tid);
    if(r.kategori==="Övertid 2>") add("Övertid 2>",r.tid);
    if(r.kategori==="Övertid-Helg") add("Övertid-Helg",r.tid);
    if(r.kategori==="Traktamente") add("Traktamente",r.tid);
  });
  const short=["jan","feb","mar","apr","maj","jun","jul","aug","sep","okt","nov","dec"];
  const label = scope==="year" ? `SUMMA (${state.settings.year})` : `SUMMA (${short[state.month-1]})`;
  lines.push([
    label,
    fmtExport(sum["Ordinarie tid"]), fmtExport(sum["Körtid"]), "",
    fmtExport(sum["Semester-tim"]), fmtExport(sum["ATF-tim"]), fmtExport(sum["Sjuk-tim"]), fmtExport(sum["Föräldraledig"]),
    fmtExport(sum["VAB"]), fmtExport(sum["Flextid"]), fmtExport(sum["Övertid <2"]), fmtExport(sum["Övertid 2>"]),
    fmtExport(sum["Övertid-Helg"]), fmtExport(sum["Traktamente"]), ""
  ].join(";"));

  return lines.join("\r\n");
}
function makeBlobCSV(text){
  // UTF-16LE + BOM (Excel-vänligt)
  const s=(text||"").normalize("NFC");
  const bom=new Uint8Array([0xFF,0xFE]);
  const buf=new Uint8Array(bom.length + s.length*2);
  bom.forEach((b,i)=>buf[i]=b);
  for(let i=0;i<s.length;i++){const code=s.charCodeAt(i); buf[bom.length+i*2]=code&0xFF; buf[bom.length+i*2+1]=(code>>8)&0xFF;}
  return new Blob([buf],{type:"text/csv;charset=utf-16le"});
}
function download(name,blob){const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500);}

// ===== Export/Dela knappar =====
window.exportMonthReport=()=>{ const text=buildCsv("month"); const y=state.settings.year, m=String(state.month).padStart(2,"0"); download(`tidrapport_${y}_${m}_manadsrapport.csv`, makeBlobCSV(text)); };
window.exportYearReportCombined=()=>{ const text=buildCsv("year"); const y=state.settings.year; download(`tidrapport_${y}_arsrapport.csv`, makeBlobCSV(text)); };
window.exportExcelStyleMonth=()=>{ const text=buildCsv("month"); const y=state.settings.year, m=String(state.month).padStart(2,"0"); download(`tidrapport_${y}_${m}_excelstil.csv`, makeBlobCSV(text)); };

async function tryShareOrDownload(filename, blob, title){
  if (navigator.canShare && navigator.canShare({files:[new File([blob], filename, {type: blob.type})]})) {
    try { const file = new File([blob], filename, {type: blob.type}); await navigator.share({title, files:[file]}); return true; } catch (e) {}
  }
  download(filename, blob); // tyst fallback på desktop
  return false;
}
window.shareMonthReport=async()=>{ const text=buildCsv("month"); const y=state.settings.year, m=String(state.month).padStart(2,"0"); await tryShareOrDownload(`tidrapport_${y}_${m}_manadsrapport.csv`, makeBlobCSV(text), "Tidrapport – Månadsrapport"); };
window.shareYearReport=async()=>{ const text=buildCsv("year"); const y=state.settings.year; await tryShareOrDownload(`tidrapport_${y}_arsrapport.csv`, makeBlobCSV(text), "Tidrapport – Årsrapport"); };

// ===== PDF (jsPDF) =====
function makePdf(scope){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"a4"});
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 40;
  const lineH = 14;
  const mono = "courier";
  let y = margin + 8;

  const write = (txt, bold=false)=>{
    if(y > pageH - margin){ doc.addPage(); y = margin + 8; }
    doc.setFont(mono, bold?"bold":"normal");
    doc.text(txt, margin, y);
    y += lineH;
  };
  const wrap = txt => doc.splitTextToSize(txt, pageW - margin*2);

  write(`Tidrapport — ${scope==="year" ? `Årsrapport ${state.settings.year}` : `Månadsrapport ${monthsSv[state.month-1]} ${state.settings.year}`}`, true);
  doc.setFont(mono,"normal"); doc.setFontSize(10);

  buildCsv(scope).split("\r\n").forEach(row=>{
    wrap(row).forEach(line=>write(line));
  });

  return doc.output("blob");
}
window.shareMonthPdfEmail=async()=>{ const blob=makePdf("month"); await tryShareOrDownload(`Tidrapport_${state.settings.year}_${String(state.month).padStart(2,"0")}.pdf`, blob, "Tidrapport – Månadsrapport (PDF)"); };
window.shareYearPdfEmail=async()=>{ const blob=makePdf("year"); await tryShareOrDownload(`Tidrapport_${state.settings.year}.pdf`, blob, "Tidrapport – Årsrapport (PDF)"); };

// Dummy .eml (enkelt utkast)
window.createEmlDraft=()=>{
  const subject = encodeURIComponent(`Tidrapport ${state.settings.year} – ${monthsSv[state.month-1]}`);
  const body = encodeURIComponent("Hej!\n\nSe bifogad tidrapport.\n\n// Skapad i Tidrapport");
  location.href = `mailto:?subject=${subject}&body=${body}`;
};

// ===== JSON Export/Import =====
window.exportJSON=()=>{ const blob=new Blob([JSON.stringify({settings:state.settings,data:state.data},null,2)],{type:"application/json"}); download(`tidrapport_backup_${state.settings.year}.json`, blob); };
window.shareJSON=async()=>{ const blob=new Blob([JSON.stringify({settings:state.settings,data:state.data},null,2)],{type:"application/json"}); await tryShareOrDownload(`tidrapport_backup_${state.settings.year}.json`, blob, "Tidrapport – Backup JSON"); };
window.importJSON=async(ev)=>{
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const obj = JSON.parse(txt);
    if(obj.settings) state.settings = {...state.settings, ...obj.settings};
    if(obj.data)     state.data     = obj.data;
    saveCfg(); saveData(); renderAll();
    alert("JSON backup importerad.");
  }catch(e){ alert("Kunde inte importera JSON: "+(e.message||e)); }
  finally{ ev.target.value=""; }
};

// ===== CSV Import =====
window.importCSV=async(ev)=>{
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const rows = txt.replace(/\r\n/g,"\n").split("\n").map(l=>l.trim()).filter(Boolean);
    let idx = 0;
    if (rows[idx] && /^sep\s*=\s*;$/i.test(rows[idx])) idx++;
    if (rows[idx] && /(^|;)datum(;|$)/i.test(rows[idx])) idx++;

    for(; idx<rows.length; idx++){
      const cols = rows[idx].split(";");
      if(cols.length < 5) continue;
      const [datum, ord, kort, projekt, sem, atf, sjuk, forald, vab, flex, otlt2, ot2gt, othel, trakt, bes] = cols;

      const base = {
        datum:(datum||"").trim(),
        projekt:(projekt||"").trim(),
        kortid:Number((kort||"").replace(",", "."))||0,
        beskrivning:(bes||"").trim()
      };
      const month = base.datum && !Number.isNaN(new Date(base.datum).getTime())
        ? (new Date(base.datum).getMonth()+1)
        : state.month;
      ensureMonth(month);

      const pushCat = (kat, val)=>{
        const v = Number((val||"").replace(",", "."));
        if(!Number.isFinite(v) || v===0) return;
        state.data[month].push({_id:uid(), datum:base.datum, kategori:kat, tid:v, projekt:base.projekt, kortid:base.kortid, beskrivning:base.beskrivning});
      };

      pushCat("Ordinarie tid", ord);
      pushCat("Semester-tim", sem);
      pushCat("ATF-tim", atf);
      pushCat("Sjuk-tim", sjuk);
      pushCat("Föräldraledig", forald);
      pushCat("VAB", vab);
      pushCat("Flextid", flex);
      pushCat("Övertid <2", otlt2);
      pushCat("Övertid 2>", ot2gt);
      pushCat("Övertid-Helg", othel);
      pushCat("Traktamente", trakt);
    }
    saveData(); renderAll();
    alert("CSV import klar.");
  }catch(e){
    alert("Kunde inte importera CSV: "+(e.message||e));
  }finally{ ev.target.value=""; }
};

// ===== App-actions för Ändra/Ta bort =====
window.APP={
  editRow:(id,m)=>{
    const row=(state.data[m]||[]).find(r=>r._id===id); if(!row) return;
    enterEditMode(row,m);
    $("datum").value=row.datum; $("kategori").value=row.kategori; $("tid").value=row.tid;
    $("projekt").value=row.projekt; $("kortid").value=row.kortid; $("beskrivning").value=row.beskrivning;
  },
  delRow:(id,m)=>{
    if(!confirm("Radera raden?")) return;
    const list=state.data[m]||[]; const idx=list.findIndex(r=>r._id===id);
    if(idx>-1){ list.splice(idx,1); saveData(); renderAll(); }
  }
};

// ===== Init =====
function onReady(){
  for(let m=1;m<=12;m++) ensureMonth(m);
  initMenu();
  renderAll();
}
document.addEventListener("DOMContentLoaded", onReady);

})();
</script>

<!-- Service Worker registrering -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js").catch(err=>{
    console.error("SW fail:", err);
  });
}
</script>
</body>
</html>