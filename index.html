<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tidrapport</title>

<!-- PWA / App-ikon -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0e6677">
<link rel="icon" href="icon-512.png">

<!-- jsPDF f√∂r PDF-export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" referrerpolicy="no-referrer"></script>

<style>
:root{
  --brand:#0e6677;--bg:#f6f7f9;--card:#fff;--text:#1f2937;
  --muted:#6b7280;--danger:#b91c1c;--line:#e5e7eb;--accent:#0a515f;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{position:sticky;top:0;z-index:30;background:var(--brand);color:#fff;display:flex;align-items:center;gap:.75rem;padding:.85rem 1rem}
.hamb{width:40px;height:40px;border-radius:.6rem;background:var(--accent);border:none;color:#fff;font-size:1.25rem;display:grid;place-items:center}
h1{margin:0;font-size:1.25rem;letter-spacing:.2px}
main{max-width:1100px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
.card{background:var(--card);border:1px solid var(--line);border-radius:.9rem;box-shadow:0 1px 2px rgba(0,0,0,.03);padding:1rem}
.grid{display:grid;gap:.75rem}
@media(min-width:760px){.grid{grid-template-columns:repeat(6,1fr)}}
label{font-size:.85rem;color:var(--muted);display:block;margin-bottom:.2rem}
input,select,textarea,button{font-size:1rem}
input,select,textarea{width:100%;padding:.6rem .7rem;border:1px solid #cbd5e1;border-radius:.6rem;background:#fff}
textarea{min-height:42px;resize:vertical}
.actions{display:flex;gap:.5rem;flex-wrap:wrap}
.btn{border:0;border-radius:.6rem;padding:.55rem .8rem;font-weight:600;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.ghost{background:#eef2f7}
.btn.danger{background:var(--danger);color:#fff}
table{width:100%;border-collapse:collapse;font-size:.95rem}
th,td{padding:.55rem;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
th{font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
tr.warn td{background:#fff7ed}
tr.weekend td{background:#f3f4f6}
tr.holiday td{background:#ffeef0}
tfoot td{background:#f0f9ff;font-weight:700}
.small{font-size:.85rem;color:var(--muted)}

.pill{display:inline-flex;align-items:center;gap:.4rem;font-size:.85rem;border-radius:.5rem;padding:.15rem .5rem;font-weight:600;width:max-content}
.pill .dot{width:.55rem;height:.55rem;border-radius:999px;display:inline-block}
.pill.red{background:#fee2e2;color:#7f1d1d}
.pill.orange{background:#ffedd5;color:#7c2d12}
.pill.green{background:#dcfce7;color:#065f46}
.pill.blue{background:#dbeafe;color:#1e3a8a}
.pill.rose{background:#ffe4e6;color:#9f1239}
#alarms .pills{display:grid;gap:.25rem}

aside#menu{
  position:fixed;top:0;left:0;width:min(420px,92%);height:100%;
  background:var(--card);border-right:1px solid var(--line);
  transform:translateX(-100%);transition:.25s ease;z-index:200;overflow:auto
}
aside#menu.open{transform:translateX(0)}
details summary{cursor:pointer}
@media print{ header,aside{display:none!important} }
</style>
</head>
<body>
<header>
  <button class="hamb" aria-label="Meny" onclick="toggleMenu(true)">‚ò∞</button>
  <h1>Tidrapport</h1>
</header>

<main>
  <!-- Inmatning -->
  <div class="card">
    <div class="grid">
      <div><label for="datum">Datum</label><input type="date" id="datum"></div>
      <div><label for="kategori">Kategori</label>
        <select id="kategori">
          <option>Ordinarie tid</option><option>Semester-tim</option><option>ATF-tim</option>
          <option>Sjuk-tim</option><option>F√∂r√§ldraledig</option><option>VAB</option>
          <option>Flextid</option><option>√ñvertid <2</option><option>√ñvertid 2></option>
          <option>√ñvertid-Helg</option><option>Traktamente</option>
        </select>
      </div>
      <div><label for="tid">Tid</label><input id="tid" type="text" inputmode="numeric" placeholder="0,25-steg ‚Äì minus till√•tet"></div>
      <div><label for="projekt">Projekt nr</label><input id="projekt" placeholder="Bokst√§ver/siffror (inga mellanslag)"></div>
      <div><label for="kortid">K√∂rtid</label><input id="kortid" type="text" inputmode="numeric" placeholder="0,25-steg ‚Äì minus till√•tet"></div>
      <div><label for="beskrivning">Beskrivning</label><input id="beskrivning" placeholder="Fritext"></div>
    </div>
    <div class="actions" style="margin-top:.6rem">
      <button class="btn primary" id="btnAdd">L√§gg till</button>
      <button class="btn ghost" id="btnBackup">G√∂r backup</button>
      <button class="btn ghost" id="btnCancel" style="display:none">Avbryt</button>
    </div>
  </div>

  <!-- Tabell -->
  <div class="card">
    <table>
      <thead><tr><th>Datum</th><th>Projekt</th><th>Kategori</th><th>Tid</th><th>K√∂rtid</th><th>Beskrivning</th><th>√Ötg√§rd</th></tr></thead>
      <tbody id="rows"></tbody>
      <tfoot><tr><td colspan="7" id="totalsCell">Summering visas h√§r‚Ä¶</td></tr></tfoot>
    </table>
  </div>

  <!-- Larm & kontroller -->
  <div class="card">
    <strong>Larm & kontroller</strong>
    <div id="alarms" class="small">Inga varningar.</div>
    <div class="small" style="margin-top:.5rem">
      <span class="pill blue"><span class="dot"></span>Helg</span>
      <span class="pill rose"><span class="dot"></span>R√∂d dag</span>
      <span class="pill orange"><span class="dot"></span>Vardag &lt; 8h (Ord)</span>
      <span class="pill red"><span class="dot"></span>Saknas</span>
      <span class="pill green"><span class="dot"></span>OK</span>
    </div>
  </div>

  <!-- √Örs√∂versikt -->
  <div class="card">
    <strong>√Örs√∂versikt</strong>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>M√•nad</th><th>Ordinarie</th><th>Semester</th><th>ATF</th><th>Sjuk</th><th>F√∂r√§ldraledig</th>
            <th>VAB</th><th>Flextid</th><th>√ñT&lt;2</th><th>√ñT2&gt;</th><th>√ñT-Helg</th><th>Trakt (st)</th><th>K√∂rtid</th>
          </tr>
        </thead>
        <tbody id="yearBody"></tbody>
      </table>
    </div>
  </div>
</main>

<!-- Meny (v√§nster, st√§ngs vid klick utanf√∂r) -->
<aside id="menu" onclick="if(event.target.id==='menu')toggleMenu(false)">
  <div style="padding:1rem;border-bottom:1px solid #ddd;display:flex;justify-content:space-between">
    <strong>Meny</strong>
    <button class="hamb" onclick="toggleMenu(false)">‚úï</button>
  </div>
  <div style="padding:1rem;display:grid;gap:1rem">

    <details open>
      <summary>üìÖ M√•nad</summary>
      <div class="content" style="margin-top:.5rem;display:grid;gap:.5rem">
        <select id="menuMonth" class="select"></select>
        <button class="btn ghost menu-btn" onclick="changeMonth()">Byt m√•nad</button>
      </div>
    </details>

    <details>
      <summary>‚öôÔ∏è Inst√§llningar</summary>
      <div class="content" style="margin-top:.5rem;display:grid;gap:.5rem">
        <label>F√∂retag<input id="cfgCompany"></label>
        <label>Namn<input id="cfgName" placeholder="F√∂r- och efternamn"></label>
        <label>Anst-Nr<input id="cfgEmp"></label>
        <label>√Ñgar-ID<input id="cfgOwner" placeholder="t.ex. martin, mm, anna-l"></label>
        <label>√Ör<input id="cfgYear" inputmode="numeric" placeholder="t.ex. 2025"></label>
        <label>Extra notering<textarea id="cfgNote"></textarea></label>

        <label style="display:flex;gap:.5rem;align-items:center">
          <input type="checkbox" id="cfgAutoBackup" checked> Automatisk lokal backup
        </label>

        <div class="actions">
          <button class="btn ghost" onclick="quickBackup()">G√∂r backup</button>
          <button class="btn ghost" onclick="saveSettings()">Spara</button>
          <button class="btn danger" onclick="resetSettings()">Rensa inst√§llningar</button>
          <button class="btn danger" onclick="resetAll()">Rensa all data</button>
        </div>

        <div class="actions">
          <button class="btn ghost" onclick="createYear()">Skapa nytt √•r</button>
          <button class="btn danger" onclick="deleteYear()">Ta bort √•r</button>
        </div>
      </div>
    </details>

    <details>
      <summary>üì§ Exportera</summary>
      <div class="content" style="margin-top:.5rem;display:grid;gap:.5rem">
        <button class="btn ghost menu-btn" onclick="exportMonthReport()">Export M√•nadsrapport (CSV)</button>
        <button class="btn ghost menu-btn" onclick="exportYearReportCombined()">Export √Örsrapport (CSV)</button>
        <button class="btn ghost menu-btn" onclick="exportExcelStyleMonth()">Export Excel-stil ‚Äì m√•nad</button>
      </div>
    </details>

    <details>
      <summary>üîó Dela</summary>
      <div class="content" style="margin-top:.5rem;display:grid;gap:.5rem">
        <button class="btn ghost menu-btn" onclick="shareMonthReport()">Dela ‚Äì M√•nadsrapport (CSV)</button>
        <button class="btn ghost menu-btn" onclick="shareYearReport()">Dela ‚Äì √Örsrapport (CSV)</button>
        <hr class="sep" style="border:0;border-top:1px dashed #e5e7eb">
        <button class="btn ghost menu-btn" onclick="shareMonthPdfEmail()">Dela som PDF ‚Äì M√•nadsrapport (mail)</button>
        <button class="btn ghost menu-btn" onclick="shareYearPdfEmail()">Dela som PDF ‚Äì √Örsrapport (mail)</button>
        <hr class="sep" style="border:0;border-top:1px dashed #e5e7eb">
        <button class="btn ghost menu-btn" onclick="createEmlDraft()">Skapa e-postutkast (.eml)</button>
      </div>
    </details>

    <details>
      <summary>‚¨ÜÔ∏è Import/Backup</summary>
      <div class="content" style="margin-top:.5rem;display:grid;gap:.5rem">
        <div class="small">CSV: f√∂rsta rad <code>sep=;</code> + rubriker.</div>
        <input type="file" id="fileImport" accept=".csv" onchange="importCSV(event)">
        <div class="small" style="margin-top:.5rem">Backup JSON:</div>
        <button class="btn ghost menu-btn" onclick="exportJSON()">Exportera backup (JSON)</button>
        <input type="file" id="fileJson" accept="application/json" onchange="importJSON(event)">
        <button class="btn ghost menu-btn" onclick="shareJSON()">Dela (mobil) ‚Äì JSON</button>
      </div>
    </details>

    <details>
      <summary>üìò Manual / Hj√§lp</summary>
      <div class="content" style="margin-top:.5rem">
        <div class="list" style="display:grid;gap:.5rem">
          <div class="row" style="display:grid;grid-template-columns:28px 1fr;gap:.6rem"><div class="ico">üìÖ</div><div><strong>V√§lj datum</strong><br><span class="small">V√§lj r√§tt dag i datumf√§ltet.</span></div></div>
          <div class="row" style="display:grid;grid-template-columns:28px 1fr;gap:.6rem"><div class="ico">üè∑Ô∏è</div><div><strong>V√§lj kategori</strong><br><span class="small">Ordinarie, Flextid, √ñvertid, Traktamente m.fl.</span></div></div>
          <div class="row" style="display:grid;grid-template-columns:28px 1fr;gap:.6rem"><div class="ico">‚è±Ô∏è</div><div><strong>Fyll i tid</strong><br><span class="small">0,25-steg. Minus till√•tet (r√§knas som negativt).</span></div></div>
          <div class="row" style="display:grid;grid-template-columns:28px 1fr;gap:.6rem"><div class="ico">üöó</div><div><strong>K√∂rtid</strong><br><span class="small">Valfritt. Ocks√• 0,25-steg.</span></div></div>
          <div class="row" style="display:grid;grid-template-columns:28px 1fr;gap:.6rem"><div class="ico">üì¶</div><div><strong>Projekt</strong><br><span class="small">Bokst√§ver/siffror (inga mellanslag). Anv√§nds f√∂r summering per projekt.</span></div></div>
          <div class="row" style="display:grid;grid-template-columns:28px 1fr;gap:.6rem"><div class="ico">‚ö†Ô∏è</div><div><strong>Larm & kontroller</strong><br><span class="small"><em>Endast Ordinarie tid</em> r√§knas mot 8h. Flex/√ñT p√•verkar inte OK/Under 8h.</span></div></div>
          <div class="row" style="display:grid;grid-template-columns:28px 1fr;gap:.6rem"><div class="ico">üì§</div><div><strong>Export</strong><br><span class="small">CSV (m√•nad/√•r) med SUMMA + PER PROJEKT. PDF inneh√•ller samma data.</span></div></div>
          <div class="row" style="display:grid;grid-template-columns:28px 1fr;gap:.6rem"><div class="ico">‚òÅÔ∏è</div><div><strong>Backup</strong><br><span class="small">Exportera/importera JSON. CSV-import st√∂ds.</span></div></div>
          <div class="row" style="display:grid;grid-template-columns:28px 1fr;gap:.6rem"><div class="ico">üì∂</div><div><strong>Offline</strong><br><span class="small">Fungerar offline via Service Worker (PWA).</span></div></div>
        </div>
      </div>
    </details>

    <div class="small" style="text-align:center">
      <hr class="sep" style="border:0;border-top:1px dashed #e5e7eb">
      üî® Tillverkad i samarbete med <strong>ChatGPT & Martin Mattsson</strong>
    </div>
  </div>
</aside>

<script>
(()=>{
// ===== Utils & konstanter =====
const monthsSv=["januari","februari","mars","april","maj","juni","juli","augusti","september","oktober","november","december"];
const CSV_COLS=["Datum","Ordinarie tid","K√∂rtid","Projekt","Semester-tim","ATF-tim","Sjuk-tim","F√∂r√§ldraledig","VAB","Flextid","√ñvertid <2","√ñvertid 2>","√ñvertid-Helg","Traktamente","Beskrivning"];
const STORAGE="tidrapport_data_v10";
const SETTINGS="tidrapport_settings_v10";
const $=id=>document.getElementById(id);
const cap=s=>s.charAt(0).toUpperCase()+s.slice(1);

// Format (UI) ‚Äî 0 visas tomt, minus bevaras
const fmtBlankZero = n => {
  const v = Number(n) || 0;
  if (v === 0) return "";
  return (Math.round(v*100)/100).toLocaleString("sv-SE",{minimumFractionDigits:0, maximumFractionDigits:2});
};
// Format (CSV) ‚Äî 0 blir tomt, minus bevaras, punkt‚Üíkomma
const fmtExport = n => {
  if (n==null || n==="") return "";
  const v = Number(String(n).replace(",", "."));
  if (!Number.isFinite(v) || v===0) return "";
  return v.toString().replace(".", ",");
};
const csvEscape=s=>{s=s==null?"":String(s).replace(/\r?\n/g," "); if(/[";]/.test(s)) s='"'+s.replace(/"/g,'""')+'"'; return s;};
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }

// ===== State =====
let state={month:(new Date().getMonth()+1), data:load(STORAGE,{}), settings:load(SETTINGS,defSettings())};
function defSettings(){return{company:"",name:"",emp:"",owner:"",year:new Date().getFullYear(),note:"",autoBackup:true,holidays:true}}
function load(k,def){try{const v=JSON.parse(localStorage.getItem(k));return v??def}catch(_){return def}}
function saveData(){ localStorage.setItem(STORAGE,JSON.stringify(state.data)); if(state.settings.autoBackup) localStorage.setItem("tidrapport_last_update",Date.now()); }
function saveCfg(){ localStorage.setItem(SETTINGS,JSON.stringify(state.settings)); if(state.settings.autoBackup) localStorage.setItem("tidrapport_last_update",Date.now()); }
function ensureMonth(m){ if(!state.data[m]) state.data[m]=[] }

// ===== Meny =====
window.toggleMenu=(open)=>{const el=$("menu"); if(!el) return; el.classList.toggle("open",open); if(open) initMenu();}
function initMenu(){
  const sel=$("menuMonth");
  if(sel){
    sel.innerHTML="";
    monthsSv.forEach((n,i)=>{
      const o=document.createElement("option");
      o.value=i+1; o.textContent=cap(n); if(i+1===state.month) o.selected=true;
      sel.appendChild(o);
    });
  }
  $("cfgCompany").value=state.settings.company||"";
  $("cfgName").value=state.settings.name||"";
  $("cfgEmp").value=state.settings.emp||"";
  $("cfgOwner").value=state.settings.owner||"";
  $("cfgYear").value=state.settings.year||"";
  $("cfgNote").value=state.settings.note||"";
  $("cfgAutoBackup").checked = state.settings.autoBackup!==false;
}
window.changeMonth=()=>{ state.month=Number($("menuMonth").value)||state.month; renderAll(); toggleMenu(false); }

// ===== Settings =====
window.saveSettings=()=>{
  state.settings.company=$("cfgCompany").value.trim();
  state.settings.name=$("cfgName").value.trim();
  state.settings.emp=$("cfgEmp").value.trim();
  state.settings.owner=$("cfgOwner").value.trim();
  state.settings.year=Number($("cfgYear").value)||new Date().getFullYear();
  state.settings.note=$("cfgNote").value;
  state.settings.autoBackup=$("cfgAutoBackup").checked;
  saveCfg(); renderAll();
};
window.resetSettings=()=>{
  if(!confirm("Rensa inst√§llningar?\nDina inmatade rader p√•verkas inte.")) return;
  state.settings = defSettings(); saveCfg(); initMenu(); renderAll();
  alert("Inst√§llningarna rensade.");
};
window.resetAll=async()=>{
  const input=prompt("‚ö†Ô∏è RADERA ALL DATA.\nSkriv: RADERA ALLT");
  if(input!=="RADERA ALLT") return;
  try{
    const pre=new Blob([JSON.stringify({settings:state.settings,data:state.data},null,2)],{type:"application/json"});
    download(`tidrapport_pre_reset_${Date.now()}.json`, pre);
  }catch(_){}
  state.data={}; for(let m=1;m<=12;m++) ensureMonth(m);
  saveData(); renderAll(); alert("All data rensad.");
};
window.createYear=()=>{ const y=Number(prompt("Skapa nytt √•r:", (state.settings.year||new Date().getFullYear())+1)); if(!y) return; state.settings.year=y; saveCfg(); renderAll(); };
window.deleteYear=()=>{ if(!confirm("√Ör √•terst√§lls till innevarande √•r (data ligger kvar)."))return; state.settings.year=new Date().getFullYear(); saveCfg(); renderAll(); };
window.quickBackup=()=>exportJSON();

// ===== Input helpers =====
function normMinus(s){return (s||"").replace(/[‚Äì‚Äî‚àí]/g,"-")}
function toNumRaw(s){ if(s==null) return NaN; s=normMinus((""+s).replace(/\s+/g,"")).replace(",","."); if(!/^[-]?\d*(\.\d+)?$/.test(s)) return NaN; return s===""?NaN:parseFloat(s); }
function roundQuarter(n){return Math.round(n*4)/4}
function parseHourInput(v,allowEmpty=false){ if(allowEmpty && (v===""||v==null)) return 0; const n=toNumRaw(v); if(isNaN(n)) return NaN; return roundQuarter(n); }
function sanitizeProject(s){ s=(s||"").normalize("NFC").replace(/\s+/g,""); s=s.replace(/[^0-9A-Za-z√Ö√Ñ√ñ√•√§√∂]/g,""); return s; }

// ===== Add/Edit/Delete =====
const btnAdd=$("btnAdd"); const btnCancel=$("btnCancel"); const btnBackup=$("btnBackup");
btnAdd.addEventListener("click", () => {
  const d=$("datum").value; if(!d){ alert("V√§lj datum."); return; }
  const k=$("kategori").value;
  const t=parseHourInput($("tid").value); if(isNaN(t)){ alert("Ogiltig Tid."); return; }
  const p=sanitizeProject($("projekt").value);
  const kt=parseHourInput($("kortid").value,true); if(isNaN(kt)){ alert("Ogiltig K√∂rtid."); return; }
  const b=$("beskrivning").value||"";
  const m=(new Date(d)).getMonth()+1; ensureMonth(m);

  if (editing){
    const list=state.data[editing.month]||[]; const idx=list.findIndex(r=>r._id===editing.id);
    if(idx!==-1){
      list[idx]={...list[idx], datum:d,kategori:k,tid:t,projekt:p,kortid:kt,beskrivning:b};
      if (editing.month!==m){ const row=list.splice(idx,1)[0]; ensureMonth(m); state.data[m].push(row); state.month=m; }
      saveData();
    }else{
      state.data[m].push({_id:uid(), datum:d,kategori:k,tid:t,projekt:p,kortid:kt,beskrivning:b}); saveData();
    }
    exitEditMode(); renderAll();
  } else {
    state.data[m].push({_id:uid(), datum:d,kategori:k,tid:t,projekt:p,kortid:kt,beskrivning:b});
    saveData(); clearInputs(); state.month=m; renderAll();
  }
});
btnCancel.addEventListener("click", ()=>{ exitEditMode(); clearInputs(); });
btnBackup.addEventListener("click", ()=>{ quickBackup(); });

function enterEditMode(row, month){ editing={id:row._id, month}; btnAdd.textContent="Spara"; btnCancel.style.display=""; }
function exitEditMode(){ editing=null; btnAdd.textContent="L√§gg till"; btnCancel.style.display="none"; }
function clearInputs(){["datum","tid","projekt","kortid","beskrivning"].forEach(id=>$(id).value=""); $("kategori").selectedIndex=0;}
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
let editing=null;

// ===== Helg & r√∂da dagar (SE) =====
function easterSunday(y){const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),n=h+l-7*m+114;return new Date(y,Math.floor(n/31)-1,(n%31)+1)}
function addDays(date,days){const d=new Date(date); d.setDate(d.getDate()+days); return d}
function swedishHolidays(y){
  const H=new Map(); const add=(d, name)=>H.set(d.toISOString().slice(0,10),name);
  add(new Date(y,0,1),"Ny√•rsdagen"); add(new Date(y,0,6),"Trettondedag jul"); add(new Date(y,4,1),"F√∂rsta maj");
  add(new Date(y,5,6),"Sveriges nationaldag"); add(new Date(y,11,25),"Juldagen"); add(new Date(y,11,26),"Annandag jul");
  const eas=easterSunday(y); add(addDays(eas,-2),"L√•ngfredagen"); add(addDays(eas,1),"Annandag p√•sk"); add(addDays(eas,39),"Kristi himmelsf√§rdsdag");
  let mid=new Date(y,5,20); while(mid.getDay()!=6) mid=addDays(mid,1); add(mid,"Midsommardagen");
  let saints=new Date(y,9,31); while(saints.getDay()!=6) saints=addDays(saints,1); add(saints,"Alla helgons dag");
  return H;
}

// ===== Render =====
function yearFilter(r){ return (new Date(r.datum)).getFullYear() === (Number(state.settings.year)||new Date().getFullYear()); }
function calcMonthTotals(m){
  ensureMonth(m); const res={_kortid:0,"Traktamente":0};
  (state.data[m]||[]).filter(yearFilter).forEach(r=>{
    res[r.kategori]=(res[r.kategori]||0)+Number(r.tid||0);
    res._kortid+=Number(r.kortid||0);
  });
  return res;
}
function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);}

function renderTable(){
  const m=state.month; ensureMonth(m); const y=state.settings.year;
  const tb=$("rows"); tb.innerHTML="";
  const rows=[...(state.data[m]||[]).filter(yearFilter)].sort((a,b)=>a.datum.localeCompare(b.datum));

  const dayOrdSum={}; // endast ORD
  rows.forEach(r=>{
    if(r.kategori==="Ordinarie tid"){
      dayOrdSum[r.datum]=(dayOrdSum[r.datum]||0)+Number(r.tid||0);
    }
  });
  const H= state.settings.holidays!==false ? swedishHolidays(y) : new Map();

  rows.forEach((r)=>{
    const tr=document.createElement("tr");
    const d=new Date(r.datum); const dow=d.getDay(); const iso=r.datum;
    const isWeekend=(dow===0||dow===6); const isHoliday= H.has(iso);
    if(isWeekend) tr.classList.add("weekend");
    if(isHoliday) tr.classList.add("holiday");
    if(!isWeekend && !isHoliday && (dayOrdSum[r.datum]||0)<8) tr.classList.add("warn");
    const hname=isHoliday?` <span class="pill rose"><span class="dot"></span>${H.get(iso)}</span>`:"";
    tr.innerHTML=`<td>${r.datum}${hname}</td><td>${escapeHtml(r.projekt||"")}</td><td>${r.kategori}</td>
      <td>${fmtBlankZero(r.tid)}</td><td>${fmtBlankZero(r.kortid)}</td><td>${escapeHtml(r.beskrivning||"")}</td>
      <td class="actions">
        <button class="btn ghost" onclick="APP.editRow('${r._id}', ${m})">√Ñndra</button>
        <button class="btn danger" onclick="APP.delRow('${r._id}', ${m})">Ta bort</button>
      </td>`;
    tb.appendChild(tr);
  });

  const t=calcMonthTotals(m);
  $("totalsCell").textContent=
    `Summering ‚Äî Ordinarie: ${fmtBlankZero(t["Ordinarie tid"]||0)} | Semester: ${fmtBlankZero(t["Semester-tim"]||0)} | ATF: ${fmtBlankZero(t["ATF-tim"]||0)} | `+
    `Sjuk: ${fmtBlankZero(t["Sjuk-tim"]||0)} | F√∂r√§ldraledig: ${fmtBlankZero(t["F√∂r√§ldraledig"]||0)} | VAB: ${fmtBlankZero(t["VAB"]||0)} | Flextid: ${fmtBlankZero(t["Flextid"]||0)} | `+
    `√ñT<2: ${fmtBlankZero(t["√ñvertid <2"]||0)} | √ñT2>: ${fmtBlankZero(t["√ñvertid 2>"]||0)} | √ñT-Helg: ${fmtBlankZero(t["√ñvertid-Helg"]||0)} | Trakt (st): ${fmtBlankZero(t["Traktamente"]||0)} | `+
    `K√∂rtid: ${fmtBlankZero(t._kortid||0)}`;

  renderYear(); renderAlarms(); initMenu();
}
function renderYear(){
  const tb=$("yearBody"); tb.innerHTML="";
  for(let m=1;m<=12;m++){
    const t=calcMonthTotals(m);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${cap(monthsSv[m-1])}</td>
      <td>${fmtBlankZero(t["Ordinarie tid"]||0)}</td><td>${fmtBlankZero(t["Semester-tim"]||0)}</td><td>${fmtBlankZero(t["ATF-tim"]||0)}</td>
      <td>${fmtBlankZero(t["Sjuk-tim"]||0)}</td><td>${fmtBlankZero(t["F√∂r√§ldraledig"]||0)}</td><td>${fmtBlankZero(t["VAB"]||0)}</td><td>${fmtBlankZero(t["Flextid"]||0)}</td>
      <td>${fmtBlankZero(t["√ñvertid <2"]||0)}</td><td>${fmtBlankZero(t["√ñvertid 2>"]||0)}</td><td>${fmtBlankZero(t["√ñvertid-Helg"]||0)}</td>
      <td>${fmtBlankZero(t["Traktamente"]||0)}</td><td>${fmtBlankZero(t._kortid||0)}</td>`;
    tb.appendChild(tr);
  }
}
function renderAlarms(){
  const m=state.month; ensureMonth(m);
  const y=state.settings.year||new Date().getFullYear();
  const H = state.settings.holidays!==false ? swedishHolidays(y) : new Map();

  const mapOrd={}; // endast ordinarie
  (state.data[m]||[]).filter(yearFilter).forEach(r=>{
    if(r.kategori==="Ordinarie tid"){
      const d=r.datum; mapOrd[d]=(mapOrd[d]||0)+Number(r.tid||0);
    }
  });

  const last=new Date(y,m,0).getDate();
  const lines=[];
  for(let d=1; d<=last; d++){
    const iso=`${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const dow=new Date(iso).getDay();
    const isWeekend=(dow===0||dow===6);
    const isHoliday=H.has(iso);
    const sumOrd=mapOrd[iso]||0;

    let cls="", label="";
    if (isHoliday){ cls="rose"; label=`R√∂d dag (${H.get(iso)})`; }
    else if (isWeekend){ cls="blue"; label="Helg"; }
    else if(mapOrd[iso]==null){ cls="red"; label="Saknas"; }
    else if(sumOrd<8){ cls="orange"; label=`Under 8h (Ord: ${fmtBlankZero(sumOrd)}h)`; }
    else {
      cls="green";
      const extra = sumOrd>8 ? ` ‚Äî +${fmtBlankZero(sumOrd-8)}h` : "";
      label=`OK (8h Ord)${extra}`;
    }

    const extra = (isWeekend||isHoliday) ? "" : "";
    lines.push(`<div class="pill ${cls}"><span class="dot"></span><span>${iso} ‚Äî ${label}${extra}</span></div>`);
  }

  $("alarms").innerHTML = lines.length ? `<div class="pills">${lines.join("")}</div>` : "Inga varningar f√∂r denna m√•nad.";
}
function renderAll(){renderTable()}

// ===== CSV helpers (RADER + SUMMA + PER PROJEKT + metadata) =====
function sortedRows(months){
  const out=[]; months.forEach(m=>{ensureMonth(m); (state.data[m]||[]).filter(yearFilter).forEach(r=>out.push({...r,_m:m}))});
  out.sort((a,b)=>{const c=a.datum.localeCompare(b.datum); if(c) return c; const p=(a.projekt||"").localeCompare(b.projekt||""); if(p) return p; return (a.kategori||"").localeCompare(b.kategori||"");});
  return out;
}
function groupByProject(months){
  const map={};
  months.forEach(m=>{
    ensureMonth(m);
    (state.data[m]||[]).filter(yearFilter).forEach(r=>{
      const key=(r.projekt||"(TOMT)").trim().toUpperCase();
      const cat=r.kategori||"";
      map[key] ??={_kortid:0};
      map[key]._kortid+=Number(r.kortid||0);
      map[key][cat]=(map[key][cat]||0)+Number(r.tid||0);
    });
  });
  return map;
}
function headerInfo(scope){
  const y=state.settings.year, m=state.month;
  const parts=[
    "sep=;",
    "Tidrapport;;;;",
    `F√∂retag;${state.settings.company||""};;;;`,
    `Namn;${state.settings.name||""};;;;`,
    `Anst-Nr;${state.settings.emp||""};;;;`
  ];
  if(state.settings.owner) parts.push(`√Ñgar-ID;${state.settings.owner};;;;`);
  parts.push(`√Ör;${y};;;;`);
  if(scope==="month") parts.push(`M√•nad;${cap(monthsSv[m-1])};;;;`);
  if(state.settings.note && state.settings.note.trim()) parts.push(`Notering;${state.settings.note.replace(/\r?\n/g," ")}`);
  parts.push("");
  return parts.join("\r\n");
}
function buildRowsSection(scope){
  const months = scope==="year" ? Array.from({length:12},(_,i)=>i+1) : [state.month];
  const lines=[`### RADER (${scope==="year"?"√•r":"m√•nad"})`, CSV_COLS.join(";")];

  // RADER
  sortedRows(months).forEach(r=>{
    const cat=r.kategori||"";
    const V = want => fmtExport(cat===want ? r.tid : "");
    const row=[
      r.datum,
      V("Ordinarie tid"),
      fmtExport(r.kortid),
      csvEscape(r.projekt||""),
      V("Semester-tim"),V("ATF-tim"),V("Sjuk-tim"),V("F√∂r√§ldraledig"),
      V("VAB"),V("Flextid"),V("√ñvertid <2"),V("√ñvertid 2>"),
      V("√ñvertid-Helg"),V("Traktamente"),
      csvEscape(r.beskrivning||"")
    ];
    lines.push(row.join(";"));
  });

  // SUMMA-rad
  const sum={};
  sortedRows(months).forEach(r=>{
    const add=(k,v)=> sum[k]=(sum[k]||0)+(Number(v)||0);
    if(r.kategori==="Ordinarie tid") add("Ordinarie tid",r.tid);
    if(r.kortid) add("K√∂rtid",r.kortid);
    if(r.kategori==="Semester-tim") add("Semester-tim",r.tid);
    if(r.kategori==="ATF-tim") add("ATF-tim",r.tid);
    if(r.kategori==="Sjuk-tim") add("Sjuk-tim",r.tid);
    if(r.kategori==="F√∂r√§ldraledig") add("F√∂r√§ldraledig",r.tid);
    if(r.kategori==="VAB") add("VAB",r.tid);
    if(r.kategori==="Flextid") add("Flextid",r.tid);
    if(r.kategori==="√ñvertid <2") add("√ñvertid <2",r.tid);
    if(r.kategori==="√ñvertid 2>") add("√ñvertid 2>",r.tid);
    if(r.kategori==="√ñvertid-Helg") add("√ñvertid-Helg",r.tid);
    if(r.kategori==="Traktamente") add("Traktamente",r.tid);
  });
  const short=["jan","feb","mar","apr","maj","jun","jul","aug","sep","okt","nov","dec"];
  const label = scope==="year" ? `SUMMA (${state.settings.year})` : `SUMMA (${short[state.month-1]})`;
  lines.push([
    label,
    fmtExport(sum["Ordinarie tid"]), fmtExport(sum["K√∂rtid"]), "",
    fmtExport(sum["Semester-tim"]), fmtExport(sum["ATF-tim"]), fmtExport(sum["Sjuk-tim"]), fmtExport(sum["F√∂r√§ldraledig"]),
    fmtExport(sum["VAB"]), fmtExport(sum["Flextid"]), fmtExport(sum["√ñvertid <2"]), fmtExport(sum["√ñvertid 2>"]),
    fmtExport(sum["√ñvertid-Helg"]), fmtExport(sum["Traktamente"]), ""
  ].join(";"));

  lines.push("");
  return lines.join("\r\n");
}
function buildProjectSection(scope){
  const months = scope==="year" ? Array.from({length:12},(_,i)=>i+1) : [state.month];
  const y=state.settings.year, m=String(state.month).padStart(2,"0");
  const lines=[`### SUMMERING PER PROJEKT (${scope==="year"?"√•r":"m√•nad"})`, CSV_COLS.join(";")];
  const g=groupByProject(months);
  Object.keys(g).sort().forEach(p=>{
    const o=g[p]; const datum=scope==="year" ? `${y}-01-01` : `${y}-${m}-01`;
    const row=[datum,
      fmtExport(o["Ordinarie tid"]||0),
      fmtExport(o._kortid||0),
      csvEscape(p),
      fmtExport(o["Semester-tim"]||0),
      fmtExport(o["ATF-tim"]||0),
      fmtExport(o["Sjuk-tim"]||0),
      fmtExport(o["F√∂r√§ldraledig"]||0),
      fmtExport(o["VAB"]||0),
      fmtExport(o["Flextid"]||0),
      fmtExport(o["√ñvertid <2"]||0),
      fmtExport(o["√ñvertid 2>"]||0),
      fmtExport(o["√ñvertid-Helg"]||0),
      fmtExport(o["Traktamente"]||0),
      "Summerat per projekt"
    ];
    lines.push(row.join(";"));
  });
  return lines.join("\r\n");
}
function buildCombinedCsv(scope){
  return headerInfo(scope) + buildRowsSection(scope) + buildProjectSection(scope);
}
function makeBlobCSV(text){
  // UTF-16LE + BOM (Excel-v√§nligt)
  const s=(text||"").normalize("NFC");
  const bom=new Uint8Array([0xFF,0xFE]);
  const buf=new Uint8Array(bom.length + s.length*2);
  bom.forEach((b,i)=>buf[i]=b);
  for(let i=0;i<s.length;i++){const code=s.charCodeAt(i); buf[bom.length+i*2]=code&0xFF; buf[bom.length+i*2+1]=(code>>8)&0xFF;}
  return new Blob([buf],{type:"text/csv;charset=utf-16le"});
}
function download(name,blob){const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500);}

// ===== Export/Dela knappar =====
window.exportMonthReport=()=>{ const text=buildCombinedCsv("month"); const y=state.settings.year, m=String(state.month).padStart(2,"0"); download(`tidrapport_${y}_${m}_manadsrapport.csv`, makeBlobCSV(text)); };
window.exportYearReportCombined=()=>{ const text=buildCombinedCsv("year"); const y=state.settings.year; download(`tidrapport_${y}_arsrapport.csv`, makeBlobCSV(text)); };
window.exportExcelStyleMonth=()=>{ const text=buildCombinedCsv("month"); const y=state.settings.year, m=String(state.month).padStart(2,"0"); download(`tidrapport_${y}_${m}_excelstil.csv`, makeBlobCSV(text)); };

async function tryShareOrDownload(filename, blob, title){
  if (navigator.canShare && navigator.canShare({files:[new File([blob], filename, {type: blob.type})]})) {
    try { const file = new File([blob], filename, {type: blob.type}); await navigator.share({title, files:[file]}); return true; } catch (e) {}
  }
  download(filename, blob);
  alert("Delning st√∂ds inte h√§r ‚Äì filen laddades ner ist√§llet.");
  return false;
}
window.shareMonthReport=async()=>{ const text=buildCombinedCsv("month"); const y=state.settings.year, m=String(state.month).padStart(2,"0"); await tryShareOrDownload(`tidrapport_${y}_${m}_manadsrapport.csv`, makeBlobCSV(text), "Tidrapport ‚Äì M√•nadsrapport"); };
window.shareYearReport=async()=>{ const text=buildCombinedCsv("year"); const y=state.settings.year; await tryShareOrDownload(`tidrapport_${y}_arsrapport.csv`, makeBlobCSV(text), "Tidrapport ‚Äì √Örsrapport"); };

// ===== PDF (jsPDF) ‚Äî samma struktur som CSV (metadata + RADER + PROJEKT) =====
function makePdf(scope){ // -> Blob
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"a4"});
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 40;
  const lineH = 14;
  const mono = "courier";

  let y = margin + 8;
  const wrap = (txt)=> doc.splitTextToSize(txt, pageW - margin*2);
  const writeLine = (txt, opts={})=>{
    if(y > pageH - margin){ doc.addPage(); y = margin + 8; }
    doc.setFont(mono, opts.bold ? "bold" : "normal");
    doc.text(txt, margin, y);
    y += lineH;
  };

  // Titel
  const title = scope==="year"
    ? `√Örsrapport ${state.settings.year}`
    : `M√•nadsrapport ${monthsSv[state.month-1]} ${state.settings.year}`;
  doc.setFont(mono,"bold"); doc.setFontSize(14);
  writeLine(`Tidrapport ‚Äî ${title}`);
  doc.setFont(mono,"normal"); doc.setFontSize(10);

  // Metadata (samma som CSV headerInfo)
  const metaLines = headerInfo(scope).split("\r\n").filter(Boolean);
  metaLines.forEach(line=>writeLine(line));
  y += 6;

  // RADER
  writeLine(`### RADER (${scope==="year"?"√•r":"m√•nad"})`,{bold:true});
  buildRowsSection(scope).split("\r\n").forEach(row=>{
    if(!row) return;
    wrap(row).forEach(line=>writeLine(line));
  });
  y += 10;

  // PER PROJEKT
  writeLine(`### SUMMERING PER PROJEKT (${scope==="year"?"√•r":"m√•nad"})`,{bold:true});
  buildProjectSection(scope).split("\r\n").forEach(row=>{
    if(!row) return;
    wrap(row).forEach(line=>writeLine(line));
  });

  return doc.output("blob");
}
window.shareMonthPdfEmail=async()=>{ const blob=makePdf("month"); await tryShareOrDownload(`Tidrapport_${state.settings.year}_${String(state.month).padStart(2,"0")}.pdf`, blob, "Tidrapport ‚Äì M√•nadsrapport (PDF)"); };
window.shareYearPdfEmail=async()=>{ const blob=makePdf("year"); await tryShareOrDownload(`Tidrapport_${state.settings.year}.pdf`, blob, "Tidrapport ‚Äì √Örsrapport (PDF)"); };

// Dummy .eml (enkelt utkast)
window.createEmlDraft=()=>{
  const subject = encodeURIComponent(`Tidrapport ${state.settings.year} ‚Äì ${monthsSv[state.month-1]}`);
  const body = encodeURIComponent("Hej!\n\nSe bifogad tidrapport.\n\n// Skapad i Tidrapport");
  location.href = `mailto:?subject=${subject}&body=${body}`;
};

// ===== JSON Export/Import =====
window.exportJSON=()=>{ const blob=new Blob([JSON.stringify({settings:state.settings,data:state.data},null,2)],{type:"application/json"}); download(`tidrapport_backup_${state.settings.year}.json`, blob); };
window.shareJSON=async()=>{ const blob=new Blob([JSON.stringify({settings:state.settings,data:state.data},null,2)],{type:"application/json"}); await tryShareOrDownload(`tidrapport_backup_${state.settings.year}.json`, blob, "Tidrapport ‚Äì Backup JSON"); };
window.importJSON=async(ev)=>{
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const obj = JSON.parse(txt);
    if(obj.settings) state.settings = {...state.settings, ...obj.settings};
    if(obj.data)     state.data     = obj.data;
    saveCfg(); saveData(); renderAll();
    alert("JSON backup importerad.");
  }catch(e){ alert("Kunde inte importera JSON: "+(e.message||e)); }
  finally{ ev.target.value=""; }
};

// ===== CSV Import =====
// F√∂rv√§ntad header: Datum;Ordinarie tid;K√∂rtid;Projekt;Semester-tim;ATF-tim;Sjuk-tim;F√∂r√§ldraledig;VAB;Flextid;√ñvertid <2;√ñvertid 2>;√ñvertid-Helg;Traktamente;Beskrivning
window.importCSV=async(ev)=>{
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const rows = txt.replace(/\r\n/g,"\n").split("\n").filter(l=>l.trim()!=="");
    let idx = rows[0] && rows[0].toLowerCase().startsWith("sep=") ? 1 : 0;
    if(rows[idx] && /datum;.*ordinarie/i.test(rows[idx])) idx++;

    for(; idx<rows.length; idx++){
      const cols = rows[idx].split(";");
      if(cols.length < 5) continue;
      const [datum, ord, kort, projekt, sem, atf, sjuk, forald, vab, flex, otlt2, ot2gt, othel, trakt, bes] = cols;

      const base = {
        datum:(datum||"").trim(),
        projekt:(projekt||"").trim(),
        kortid:Number((kort||"").replace(",", "."))||0,
        beskrivning:(bes||"").trim()
      };
      const month = base.datum && !Number.isNaN(new Date(base.datum).getTime())
        ? (new Date(base.datum).getMonth()+1)
        : state.month;
      ensureMonth(month);

      const pushCat = (kat, val)=>{
        const v = Number((val||"").replace(",", "."));
        if(!Number.isFinite(v) || v===0) return;
        state.data[month].push({_id:uid(), datum:base.datum, kategori:kat, tid:v, projekt:base.projekt, kortid:base.kortid, beskrivning:base.beskrivning});
      };

      pushCat("Ordinarie tid", ord);
      pushCat("Semester-tim", sem);
      pushCat("ATF-tim", atf);
      pushCat("Sjuk-tim", sjuk);
      pushCat("F√∂r√§ldraledig", forald);
      pushCat("VAB", vab);
      pushCat("Flextid", flex);
      pushCat("√ñvertid <2", otlt2);
      pushCat("√ñvertid 2>", ot2gt);
      pushCat("√ñvertid-Helg", othel);
      pushCat("Traktamente", trakt);
    }
    saveData(); renderAll();
    alert("CSV import klar.");
  }catch(e){
    alert("Kunde inte importera CSV: "+(e.message||e));
  }finally{ ev.target.value=""; }
};

// ===== App-actions f√∂r √Ñndra/Ta bort =====
window.APP={
  editRow:(id,m)=>{
    const row=(state.data[m]||[]).find(r=>r._id===id); if(!row) return;
    enterEditMode(row,m);
    $("datum").value=row.datum; $("kategori").value=row.kategori; $("tid").value=row.tid;
    $("projekt").value=row.projekt; $("kortid").value=row.kortid; $("beskrivning").value=row.beskrivning;
  },
  delRow:(id,m)=>{
    if(!confirm("Radera raden?")) return;
    const list=state.data[m]||[]; const idx=list.findIndex(r=>r._id===id);
    if(idx>-1){ list.splice(idx,1); saveData(); renderAll(); }
  }
};

// ===== Init =====
function onReady(){
  for(let m=1;m<=12;m++) ensureMonth(m);
  renderAll();
}
document.addEventListener("DOMContentLoaded", onReady);

})();
</script>

<!-- Service Worker registrering -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js").catch(err=>{
    console.error("SW fail:", err);
  });
}
</script>
</body>
</html>