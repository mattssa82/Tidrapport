<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tidrapport</title>

<!-- PWA / App-ikon -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0e6677">
<link rel="icon" href="icon-512.png">

<!-- jsPDF f√∂r PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" referrerpolicy="no-referrer"></script>

<style>
/* CSS kommer i n√§sta del */
</style>
</head>
<body>
<header>
  <button class="hamb" aria-label="Meny" onclick="toggleMenu(true)">‚ò∞</button>
  <h1>Tidrapport</h1>
</header>

<!-- Eng√•ngsbanner -->
<div id="startupBanner" class="banner">
  <span>üí° Tips: Kom ih√•g att l√§sa in din senaste backup om du byter enhet.</span>
  <button onclick="dismissBanner()">‚úï</button>
</div>

<main>
  <div class="card"><strong id="monthTitle">Tidrapport</strong></div>

  <!-- Inmatning -->
  <div class="card">
    <div class="grid">
      <div><label for="datum">Datum</label><input type="date" id="datum"></div>
      <div><label for="kategori">Kategori</label>
        <select id="kategori">
          <option>Ordinarie tid</option>
          <option>Semester-tim</option>
          <option>ATF-tim</option>
          <option>Sjuk-tim</option>
          <option>F√∂r√§ldraledig</option>
          <option>VAB</option>
          <option>Flextid</option>
          <option>√ñvertid &lt;2</option>
          <option>√ñvertid 2&gt;</option>
          <option>√ñvertid-Helg</option>
          <option>Traktamente</option>
        </select>
      </div>
      <div>
        <label for="tid">Tid</label>
        <input id="tid" type="text" inputmode="numeric" placeholder="0,25-steg ‚Äì minus till√•tet">
      </div>
      <div><label for="projekt">Projekt nr</label><input id="projekt"></div>
      <div><label for="kortid">K√∂rtid</label><input id="kortid" type="text" inputmode="numeric"></div>
      <div><label for="beskrivning">Beskrivning</label><input id="beskrivning"></div>
    </div>
    <div class="actions" style="margin-top:.6rem">
      <button class="btn primary" id="btnAdd">L√§gg till</button>
      <button class="btn ghost" id="btnBackup">G√∂r backup</button>
      <button class="btn ghost" id="btnCancel" style="display:none">Avbryt</button>
    </div>
  </div>

  <!-- Tabell -->
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Datum</th><th>Projekt</th><th>Kategori</th>
          <th>Tid</th><th>K√∂rtid</th><th>Beskrivning</th><th>√Ötg√§rd</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
      <tfoot><tr><td colspan="7" id="totalsCell">Summering visas h√§r‚Ä¶</td></tr></tfoot>
    </table>
  </div>

  <!-- Larm -->
  <div class="card">
    <strong>Larm & kontroller</strong>
    <div id="alarms" class="small">Inga varningar.</div>
    <div id="alarmsLegend" class="small"></div>
  </div>

  <!-- √Örs√∂versikt -->
  <div class="card">
    <strong>√Örs√∂versikt</strong>
    <div id="yearLinks"></div>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>M√•nad</th><th>Ordinarie</th><th>Semester</th><th>ATF</th><th>Sjuk</th>
            <th>F√∂r√§ldraledig</th><th>VAB</th><th>Flextid</th>
            <th>√ñT&lt;2</th><th>√ñT2&gt;</th><th>√ñT-Helg</th><th>Trakt</th><th>K√∂rtid</th>
          </tr>
        </thead>
        <tbody id="yearBody"></tbody>
      </table>
    </div>
  </div>
</main>

<!-- Meny till v√§nster -->
<div id="menuOverlay" onclick="toggleMenu(false)"></div>
<aside id="menu" aria-hidden="true">
  <div class="menu-head">
    <strong>Meny</strong>
    <button class="hamb" onclick="toggleMenu(false)" aria-label="St√§ng">‚úï</button>
  </div>
  <div class="menu-body">
    <details class="group" open>
      <summary>M√•nad</summary>
      <div class="content">
        <select id="menuMonth" class="select"></select>
        <button class="btn ghost menu-btn" onclick="changeMonth()">Byt m√•nad</button>
      </div>
    </details>
    <details class="group">
      <summary>Inst√§llningar</summary>
      <div class="content">
        <label>F√∂retag<input id="cfgCompany"></label>
        <label>Namn<input id="cfgName"></label>
        <label>Anst-Nr<input id="cfgEmp"></label>
        <label>√Ñgar-ID<input id="cfgOwner"></label>
        <label>√Ör<input id="cfgYear" inputmode="numeric"></label>
        <label>Extra notering<textarea id="cfgNote"></textarea></label>
        <label><input type="checkbox" id="cfgAutoBackup" checked> Automatisk backup</label>
        <div class="actions">
          <button class="btn ghost" onclick="saveSettings()">Spara</button>
          <button class="btn danger" onclick="resetSettings()">Rensa inst√§llningar</button>
          <button class="btn danger" onclick="resetAll()">Rensa all data</button>
        </div>
      </div>
    </details>
    <details class="group">
      <summary>Exportera</summary>
      <div class="content">
        <button class="btn ghost menu-btn" onclick="exportMonthReport()">Export M√•nadsrapport (CSV)</button>
        <button class="btn ghost menu-btn" onclick="exportYearReportCombined()">Export √Örsrapport (CSV)</button>
      </div>
    </details>
    <details class="group">
      <summary>Dela</summary>
      <div class="content">
        <button class="btn ghost menu-btn" onclick="shareMonthReport()">Dela m√•nad (CSV)</button>
        <button class="btn ghost menu-btn" onclick="shareYearReport()">Dela √•r (CSV)</button>
      </div>
    </details>
    <div class="small" style="text-align:center">
      <hr class="sep">
      üî® I samarbete med <strong>ChatGPT & Martin Mattsson</strong>
    </div>
  </div>
</aside>
<style>
:root{
  --brand:#0e6677;
  --bg:#f6f7f9;
  --card:#fff;
  --text:#1f2937;
  --muted:#6b7280;
  --danger:#b91c1c;
  --line:#e5e7eb;
  --accent:#0a515f;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

header{
  position:sticky;top:0;z-index:30;
  background:var(--brand);color:#fff;
  display:flex;align-items:center;gap:.75rem;
  padding:.85rem 1rem;
}
.hamb{
  width:40px;height:40px;border-radius:.6rem;
  background:var(--accent);border:none;color:#fff;
  font-size:1.25rem;display:grid;place-items:center;
}
h1{margin:0;font-size:1.25rem;letter-spacing:.2px}

main{max-width:1100px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
.card{
  background:var(--card);border:1px solid var(--line);
  border-radius:.9rem;box-shadow:0 1px 2px rgba(0,0,0,.03);padding:1rem
}
.grid{display:grid;gap:.75rem}
@media(min-width:760px){.grid{grid-template-columns:repeat(6,1fr)}}
label{font-size:.85rem;color:var(--muted);display:block;margin-bottom:.2rem}
input,select,textarea,button{font-size:1rem}
input,select,textarea{
  width:100%;padding:.6rem .7rem;border:1px solid #cbd5e1;
  border-radius:.6rem;background:#fff
}
textarea{min-height:42px;resize:vertical}

.actions{display:flex;gap:.5rem;flex-wrap:wrap}
.btn{
  border:0;border-radius:.6rem;padding:.55rem .8rem;font-weight:600;cursor:pointer
}
.btn.primary{background:var(--brand);color:#fff}
.btn.ghost{background:#eef2f7}
.btn.danger{background:var(--danger);color:#fff}

table{width:100%;border-collapse:collapse;font-size:.95rem}
th,td{
  padding:.55rem;border-bottom:1px solid var(--line);
  text-align:left;vertical-align:top
}
th{
  font-size:.78rem;color:var(--muted);
  text-transform:uppercase;letter-spacing:.4px
}
tfoot td{background:#f0f9ff;font-weight:700}
tr.warn td{background:#fff7ed}
tr.weekend td{background:#f3f4f6}
tr.holiday td{background:#ffeef0}

.small{font-size:.85rem;color:var(--muted)}

/* Meny till v√§nster */
#menuOverlay{
  position:fixed;inset:0;display:none;
  background:rgba(0,0,0,0.4);z-index:40;
}
#menu{
  position:fixed;top:0;left:0;bottom:0;
  width:min(420px,90%);background:var(--card);
  border-right:1px solid var(--line);
  transform:translateX(-100%);
  transition:.25s ease;z-index:50;
  display:flex;flex-direction:column;
}
#menu.open{transform:translateX(0)}
.menu-head{
  padding:1rem;border-bottom:1px solid var(--line);
  display:flex;justify-content:space-between;align-items:center
}
.menu-body{padding:1rem;overflow:auto;display:grid;gap:1rem}
.group{border:1px solid var(--line);border-radius:.8rem}
.group summary{
  list-style:none;cursor:pointer;padding:.8rem 1rem;
  font-weight:700;background:#f8fafc;border-radius:.8rem .8rem 0 0
}
.group summary::-webkit-details-marker{display:none}
.group .content{padding:.75rem 1rem 1rem;display:grid;gap:.65rem}
.select{
  padding:.6rem .7rem;border:1px solid #cbd5e1;
  border-radius:.6rem;background:#fff;width:100%
}
.menu-btn{width:100%;text-align:left}
hr.sep{border:0;border-top:1px dashed var(--line);margin:.4rem 0}

/* Eng√•ngsbanner */
.banner {
  background:#fff3cd;color:#856404;border:1px solid #ffeeba;
  border-radius:.5rem;padding:.75rem 1rem;margin:1rem;
  font-size:.95rem;display:none;justify-content:space-between;align-items:center;
}
.banner button {
  background:transparent;border:none;font-size:1rem;cursor:pointer;color:#856404;
}

/* Larm-taggar */
.pills{display:grid;gap:.25rem}
.pill{display:inline-flex;align-items:center;gap:.4rem;font-size:.85rem;
  border-radius:.5rem;padding:.15rem .5rem;font-weight:600;width:max-content}
.pill .dot{width:.55rem;height:.55rem;border-radius:999px;display:inline-block}
.pill.red   {background:#fee2e2;color:#7f1d1d}
.pill.orange{background:#ffedd5;color:#7c2d12}
.pill.green {background:#dcfce7;color:#065f46}
.pill.blue  {background:#dbeafe;color:#1e3a8a}
.pill.rose  {background:#ffe4e6;color:#9f1239}

@media print{header,aside,#startupBanner{display:none!important}}
</style>
<script>
(()=>{
// ===== Utils & konstanter =====
const monthsSv=["januari","februari","mars","april","maj","juni","juli","augusti","september","oktober","november","december"];
const csvCols=["Datum","Ordinarie tid","K√∂rtid","Projekt nr","Semester-tim","ATF-tim","Sjuk-tim","F√∂r√§ldraledig","VAB","Flextid","√ñvertid <2","√ñvertid 2>","√ñvertid-Helg","Traktamente","Beskrivning"];
const STORAGE="tidrapport_data_v10";
const SETTINGS="tidrapport_settings_v10";
const $=id=>document.getElementById(id);
const cap=s=>s.charAt(0).toUpperCase()+s.slice(1);

// Format-tal: visa minus, g√∂m 0, avrunda till 2 decimaler
const fmtBlankZero = n => {
  const v = Number(n);
  if (!v) return "";
  return (Math.round(v*100)/100).toLocaleString("sv-SE", {
    minimumFractionDigits: 0,
    maximumFractionDigits: 2
  });
};
const fmt = n => fmtBlankZero(n) || "0";

// ===== Eng√•ngsbanner =====
window.dismissBanner=()=>{
  $("startupBanner").style.display="none";
  localStorage.setItem("bannerDismissed","1");
};
window.addEventListener("DOMContentLoaded",()=>{
  if(!localStorage.getItem("bannerDismissed")){
    $("startupBanner").style.display="flex";
  }
});

// ===== State =====
let state={month:(new Date().getMonth()+1), data:load(STORAGE,{}), settings:load(SETTINGS,defSettings())};
function defSettings(){return{company:"",name:"",emp:"",owner:"",year:new Date().getFullYear(),note:"",autoBackup:true,holidays:true}}
function load(k,def){try{const v=JSON.parse(localStorage.getItem(k));return v??def}catch(_){return def}}
function save(){ localStorage.setItem(STORAGE,JSON.stringify(state.data)); if($("cfgAutoBackup")?.checked) autoLocalBackup?.(); }
function saveCfg(){ localStorage.setItem(SETTINGS,JSON.stringify(state.settings)); }
function ensureMonth(m){if(!state.data[m]) state.data[m]=[]}
const escapeHtml=s=>(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

// ===== Meny =====
window.toggleMenu=(open)=>{
  const el=$("menu");
  const ov=$("menuOverlay");
  if(!el||!ov) return;
  el.classList.toggle("open",open);
  ov.style.display=open?"block":"none";
  if(open) initMenu();
};
function initMenu(){  
  const sel=$("menuMonth");
  if(sel){ 
    sel.innerHTML="";
    monthsSv.forEach((n,i)=>{
      const o=document.createElement("option");
      o.value=i+1;
      o.textContent=cap(n);
      if(i+1===state.month) o.selected=true;
      sel.appendChild(o);
    });
  }
  $("cfgCompany").value=state.settings.company||"";  
  $("cfgName").value=state.settings.name||"";  
  $("cfgEmp").value=state.settings.emp||"";  
  $("cfgOwner").value=state.settings.owner||"";  
  $("cfgYear").value=state.settings.year||"";  
  $("cfgNote").value=state.settings.note||"";  
  $("cfgAutoBackup").checked=state.settings.autoBackup!==false;  
}
window.changeMonth=()=>{state.month=Number($("menuMonth").value); renderAll(); toggleMenu(false)}

// ===== Settings =====
window.saveSettings=()=>{
  state.settings.company=$("cfgCompany").value;
  state.settings.name=$("cfgName").value;
  state.settings.emp=$("cfgEmp").value;
  state.settings.owner=$("cfgOwner").value.trim();
  state.settings.year=Number($("cfgYear").value)||new Date().getFullYear();
  state.settings.note=$("cfgNote").value;
  state.settings.autoBackup=$("cfgAutoBackup").checked;
  saveCfg(); renderAll();
};
window.resetSettings=()=>{
  if (!confirm("Rensa inst√§llningar?")) return;
  state.settings = defSettings();
  saveCfg(); initMenu(); renderAll();
  alert("Inst√§llningarna √§r rensade.");
};
window.resetAll=()=>{
  if(prompt("‚ö†Ô∏è Skriv: RADERA ALLT")!=="RADERA ALLT") return;
  state.data={}; for(let m=1;m<=12;m++) ensureMonth(m);
  save(); renderAll();
  alert("All data rensad.");
};

// ===== Input helpers =====
function normMinus(s){return (s||"").replace(/[‚Äì‚Äî‚àí]/g,"-")}
function toNumRaw(s){
  if(s==null) return NaN;
  s=normMinus((""+s).replace(/\s+/g,"")).replace(",",".");
  if(!/^[-]?\d*(\.\d+)?$/.test(s)) return NaN;
  return s===""?NaN:parseFloat(s);
}
function roundQuarter(n){return Math.round(n*4)/4}
function parseHourInput(v,allowEmpty=false){
  if(allowEmpty&&(v===""||v==null)) return 0;
  const n=toNumRaw(v);
  if(isNaN(n)) return NaN;
  return roundQuarter(n);
}
function sanitizeProject(s){
  s=(s||"").normalize("NFC").replace(/\s+/g,"");
  s=s.replace(/[^0-9A-Za-z√Ö√Ñ√ñ√•√§√∂]/g,"");
  return s;
}

// ===== Add/Edit/Delete =====
const btnAdd=$("btnAdd");
const btnCancel=$("btnCancel");
const btnBackup=$("btnBackup");

btnAdd.addEventListener("click",()=>{
  const d=$("datum").value; if(!d){alert("V√§lj datum.");return;}
  const k=$("kategori").value;
  const t=parseHourInput($("tid").value); if(isNaN(t)){alert("Ogiltig Tid.");return;}
  const p=sanitizeProject($("projekt").value);
  const kt=parseHourInput($("kortid").value,true); if(isNaN(kt)){alert("Ogiltig K√∂rtid.");return;}
  const b=$("beskrivning").value||"";
  const m=(new Date(d)).getMonth()+1; ensureMonth(m);

  if(editing){
    const list=state.data[editing.month]||[];
    const idx=list.findIndex(r=>r._id===editing.id);
    if(idx!==-1){
      list[idx]={...list[idx],datum:d,kategori:k,tid:t,projekt:p,kortid:kt,beskrivning:b};
      if(editing.month!==m){
        const row=list.splice(idx,1)[0];
        ensureMonth(m); state.data[m].push(row); state.month=m;
      }
      save();
    }
    exitEditMode(); renderAll();
  }else{
    state.data[m].push({_id:uid(),datum:d,kategori:k,tid:t,projekt:p,kortid:kt,beskrivning:b});
    save(); clearInputs(); state.month=m; renderAll();
  }
});
btnCancel.addEventListener("click",()=>{exitEditMode();clearInputs();});
btnBackup.addEventListener("click",()=>{quickBackup?.();});

function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8);}
let editing=null;
function enterEditMode(row,month){editing={id:row._id,month};btnAdd.textContent="Spara";btnCancel.style.display="";}
function exitEditMode(){editing=null;btnAdd.textContent="L√§gg till";btnCancel.style.display="none";}
function clearInputs(){["datum","tid","projekt","kortid","beskrivning"].forEach(id=>$(id).value="");$("kategori").selectedIndex=0;}
<script>
// ===== Render =====
function yearFilter(r){return(new Date(r.datum)).getFullYear()===(Number(state.settings.year)||new Date().getFullYear());}
function calcMonthTotals(m){
  ensureMonth(m);const res={_kortid:0,"Traktamente":0};
  (state.data[m]||[]).filter(yearFilter).forEach(r=>{
    res[r.kategori]=(res[r.kategori]||0)+Number(r.tid||0);
    res._kortid+=Number(r.kortid||0);
  });
  return res;
}
function renderTable(){
  const m=state.month;ensureMonth(m);const y=state.settings.year;
  $("monthTitle").textContent=`Tidrapport f√∂r ${cap(monthsSv[m-1])} ${y}`;
  const tb=$("rows");tb.innerHTML="";
  const rows=[...(state.data[m]||[]).filter(yearFilter)].sort((a,b)=>a.datum.localeCompare(b.datum));
  const daySum={};rows.forEach(r=>{daySum[r.datum]=(daySum[r.datum]||0)+Number(r.tid||0)});
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.datum}</td><td>${escapeHtml(r.projekt||"")}</td><td>${r.kategori}</td>
      <td>${fmtBlankZero(r.tid)}</td><td>${fmtBlankZero(r.kortid)}</td><td>${escapeHtml(r.beskrivning||"")}</td>
      <td class="actions">
        <button class="btn ghost" onclick="APP.editRow('${r._id}',${m})">√Ñndra</button>
        <button class="btn danger" onclick="APP.delRow('${r._id}',${m})">Ta bort</button>
      </td>`;
    tb.appendChild(tr);
  });
  const t=calcMonthTotals(m);
  $("totalsCell").textContent=
    `Summering ‚Äî Ordinarie: ${fmtBlankZero(t["Ordinarie tid"]||0)} | Semester: ${fmtBlankZero(t["Semester-tim"]||0)} | ATF: ${fmtBlankZero(t["ATF-tim"]||0)} | `+
    `Sjuk: ${fmtBlankZero(t["Sjuk-tim"]||0)} | F√∂r√§ldraledig: ${fmtBlankZero(t["F√∂r√§ldraledig"]||0)} | VAB: ${fmtBlankZero(t["VAB"]||0)} | Flextid: ${fmtBlankZero(t["Flextid"]||0)} | `+
    `√ñT<2: ${fmtBlankZero(t["√ñvertid <2"]||0)} | √ñT2>: ${fmtBlankZero(t["√ñvertid 2>"]||0)} | √ñT-Helg: ${fmtBlankZero(t["√ñvertid-Helg"]||0)} | Traktamente: ${fmtBlankZero(t["Traktamente"]||0)} | `+
    `K√∂rtid: ${fmtBlankZero(t._kortid||0)}`;
  renderYear();renderAlarms();initMenu();
}
function renderYear(){
  const tb=$("yearBody");tb.innerHTML="";
  for(let m=1;m<=12;m++){
    const t=calcMonthTotals(m);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${cap(monthsSv[m-1])}</td>
      <td>${fmtBlankZero(t["Ordinarie tid"]||0)}</td><td>${fmtBlankZero(t["Semester-tim"]||0)}</td><td>${fmtBlankZero(t["ATF-tim"]||0)}</td>
      <td>${fmtBlankZero(t["Sjuk-tim"]||0)}</td><td>${fmtBlankZero(t["F√∂r√§ldraledig"]||0)}</td><td>${fmtBlankZero(t["VAB"]||0)}</td><td>${fmtBlankZero(t["Flextid"]||0)}</td>
      <td>${fmtBlankZero(t["√ñvertid <2"]||0)}</td><td>${fmtBlankZero(t["√ñvertid 2>"]||0)}</td><td>${fmtBlankZero(t["√ñvertid-Helg"]||0)}</td>
      <td>${fmtBlankZero(t["Traktamente"]||0)}</td><td>${fmtBlankZero(t._kortid||0)}</td>`;
    tb.appendChild(tr);
  }
}
function renderAlarms(){
  const m=state.month;ensureMonth(m);
  const y=state.settings.year||new Date().getFullYear();
  const map={};
  (state.data[m]||[]).filter(yearFilter).forEach(r=>{map[r.datum]=(map[r.datum]||0)+Number(r.tid||0)});
  const last=new Date(y,m,0).getDate();const lines=[];
  for(let d=1;d<=last;d++){
    const iso=`${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const sum=map[iso]||0;
    let cls="",label="";
    if(map[iso]==null){cls="red";label="Saknas";}
    else if(sum<8){cls="orange";label=`Under 8h (${fmtBlankZero(sum)}h)`;}
    else{cls="green";label="OK";}
    lines.push(`<div class="pill ${cls}"><span class="dot"></span><span>${iso} ‚Äî ${label}</span></div>`);
  }
  $("alarms").innerHTML=lines.length?`<div class="pills">${lines.join("")}</div>`:"Inga varningar.";
}
function renderAll(){renderTable()}

// ===== CSV helpers =====
const FILL_ZERO=false;
const csvEscape=s=>{s=s==null?"":String(s).replace(/\r?\n/g," ");if(/[";]/.test(s))s='"'+s.replace(/"/g,'""')+'"';return s;}
function csvHeaderRow(){return csvCols.join(";")}
function sortedRows(months){
  const out=[];months.forEach(m=>{ensureMonth(m);(state.data[m]||[]).filter(yearFilter).forEach(r=>out.push({...r,_m:m}))});
  out.sort((a,b)=>a.datum.localeCompare(b.datum));return out;
}
function headerInfo(scope){
  const y=state.settings.year,m=state.month;
  const parts=["sep=;","Tidrapport;;;;",`F√∂retag;${state.settings.company||""};;;;`,`Namn;${state.settings.name||""};;;;`,`Anst-Nr;${state.settings.emp||""};;;;`];
  parts.push(`√Ör;${y};;;;`);if(scope==="month")parts.push(`M√•nad;${cap(monthsSv[m-1])};;;;`);parts.push("");return parts.join("\r\n");
}
function buildRowsSection(scope){
  const months=scope==="year"?Array.from({length:12},(_,i)=>i+1):[state.month];
  const lines=[`### RADER (${scope==="year"?"√•r":"m√•nad"})`,csvHeaderRow()];
  sortedRows(months).forEach(r=>{
    const cat=r.kategori||"";
    const val=want=>(cat===want?fmtBlankZero(r.tid):(FILL_ZERO?"0":""));
    const row=[r.datum,val("Ordinarie tid"),fmtBlankZero(r.kortid||0),csvEscape(r.projekt||""),val("Semester-tim"),val("ATF-tim"),val("Sjuk-tim"),val("F√∂r√§ldraledig"),val("VAB"),val("Flextid"),val("√ñvertid <2"),val("√ñvertid 2>"),val("√ñvertid-Helg"),val("Traktamente"),csvEscape(r.beskrivning||"")];
    lines.push(row.join(";"));
  });
  lines.push("");return lines.join("\r\n");
}
function buildCombinedCsv(scope){return headerInfo(scope)+buildRowsSection(scope);}

// Blob helper
function makeBlobCSV(text){
  const s=(text||"").normalize("NFC");
  const bom=new Uint8Array([0xFF,0xFE]);
  const buf=new Uint8Array(bom.length+s.length*2);
  bom.forEach((b,i)=>buf[i]=b);
  for(let i=0;i<s.length;i++){const code=s.charCodeAt(i);buf[bom.length+i*2]=code&0xFF;buf[bom.length+i*2+1]=(code>>8)&0xFF;}
  return new Blob([buf],{type:"text/csv;charset=utf-16le"});
}
function dl(name,blob){const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=name;a.click();setTimeout(()=>URL.revokeObjectURL(a.href),1500)}

// ===== Export =====
window.exportMonthReport=()=>{const text=buildCombinedCsv("month");const y=state.settings.year,m=String(state.month).padStart(2,"0");dl(`tidrapport_${y}_${m}_manadsrapport.csv`,makeBlobCSV(text));};
window.exportYearReportCombined=()=>{const text=buildCombinedCsv("year");const y=state.settings.year;dl(`tidrapport_${y}_arsrapport.csv`,makeBlobCSV(text));};
window.shareMonthReport=async()=>{const text=buildCombinedCsv("month");const y=state.settings.year,m=String(state.month).padStart(2,"0");dl(`Tidrapport_${y}_${m}_manadsrapport.csv`,makeBlobCSV(text));};
window.shareYearReport=async()=>{const text=buildCombinedCsv("year");const y=state.settings.year;dl(`Tidrapport_${y}_arsrapport.csv`,makeBlobCSV(text));};

// ===== PDF (enkel) =====
function makePdfReport(scope){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({unit:"pt",format:"a4",orientation:"landscape"});
  const ySel=state.settings.year;
  const mIdx=state.month-1;
  const title=scope==="year"?`√Örsrapport ${ySel}`:`M√•nadsrapport ${cap(monthsSv[mIdx])} ${ySel}`;
  doc.setFont("helvetica","bold");doc.setFontSize(14);doc.text(`Tidrapport ‚Äî ${title}`,40,40);
  doc.save(`${title}.pdf`);
}
})();
</script>
</script>
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("sw.js")
      .then(reg => console.log("Service worker registrerad:", reg.scope))
      .catch(err => console.error("SW-fel:", err));
  });
}
</script>
</body>
</html>