<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tidrapport</title>

<!-- PWA / App-ikon -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0e6677">
<link rel="icon" href="icon-512.png">

<!-- jsPDF f√∂r PDF (delning till mail / nedladdning) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" referrerpolicy="no-referrer"></script>

<style>
:root{
  --brand:#0e6677;--bg:#f6f7f9;--card:#fff;--text:#1f2937;--muted:#6b7280;
  --danger:#b91c1c;--line:#e5e7eb;--accent:#0a515f;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{position:sticky;top:0;z-index:30;background:var(--brand);
  color:#fff;display:flex;align-items:center;gap:.75rem;padding:.85rem 1rem}
.hamb{width:40px;height:40px;border-radius:.6rem;background:var(--accent);
  border:none;color:#fff;font-size:1.25rem;display:grid;place-items:center}
h1{margin:0;font-size:1.25rem;letter-spacing:.2px}
main{max-width:1100px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
.card{background:var(--card);border:1px solid var(--line);border-radius:.9rem;
  box-shadow:0 1px 2px rgba(0,0,0,.03);padding:1rem}
.grid{display:grid;gap:.75rem}
@media(min-width:760px){.grid{grid-template-columns:repeat(6,1fr)}}
label{font-size:.85rem;color:var(--muted);display:block;margin-bottom:.2rem}
input,select,textarea,button{font-size:1rem}
input,select,textarea{width:100%;padding:.6rem .7rem;border:1px solid #cbd5e1;
  border-radius:.6rem;background:#fff}
textarea{min-height:42px;resize:vertical}
.actions{display:flex;gap:.5rem;flex-wrap:wrap}
.btn{border:0;border-radius:.6rem;padding:.55rem .8rem;font-weight:600;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.ghost{background:#eef2f7}
.btn.danger{background:var(--danger);color:#fff}
table{width:100%;border-collapse:collapse;font-size:.95rem}
th,td{padding:.55rem;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
th{font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
tr.warn td{background:#fff7ed}
tr.weekend td{background:#f3f4f6}
tr.holiday td{background:#ffeef0}
tfoot td{background:#f0f9ff;font-weight:700}
.small{font-size:.85rem;color:var(--muted)}

/* Eng√•ngsbanner */
.banner {
  background: #fff3cd; color: #856404; border: 1px solid #ffeeba;
  border-radius: .5rem; padding: .75rem 1rem; margin: 1rem;
  font-size: .95rem; display: none; justify-content: space-between; align-items: center;
}
.banner button {
  background: transparent; border: none; font-size: 1rem; cursor: pointer; color: #856404;
}
</style>
</head>
<body>
<header>
  <button class="hamb" aria-label="Meny" onclick="toggleMenu(true)">‚ò∞</button>
  <h1>Tidrapport</h1>
</header>

<!-- Eng√•ngsbanner -->
<div id="startupBanner" class="banner">
  <span>üí° Tips: Kom ih√•g att l√§sa in din senaste backup om du har jobbat p√• en annan enhet ‚Äì och skapa g√§rna en ny backup innan du byter plattform.</span>
  <button onclick="dismissBanner()">‚úï</button>
</div>
<main>
  <div class="card"><strong id="monthTitle">Tidrapport</strong></div>

  <!-- Inmatning -->
  <div class="card">
    <div class="grid">
      <div><label for="datum">Datum</label><input type="date" id="datum"></div>
      <div><label for="kategori">Kategori</label>
        <select id="kategori">
          <option>Ordinarie tid</option><option>Semester-tim</option><option>ATF-tim</option>
          <option>Sjuk-tim</option><option>F√∂r√§ldraledig</option><option>VAB</option>
          <option>Flextid</option><option>√ñvertid &lt;2</option><option>√ñvertid 2&gt;</option>
          <option>√ñvertid-Helg</option><option>Traktamente</option>
        </select>
      </div>
      <div>
        <label for="tid">Tid</label>
        <input id="tid" type="text" inputmode="numeric" placeholder="0,25-steg ‚Äì minus till√•tet">
        <div class="small">1=1h, 0,5=30min, 0,25=15min, -1=-1h.</div>
      </div>
      <div><label for="projekt">Projekt nr</label><input id="projekt" placeholder="Bara bokst√§ver/siffror (inga mellanslag)"></div>
      <div><label for="kortid">K√∂rtid</label><input id="kortid" type="text" inputmode="numeric" placeholder="0,25-steg ‚Äì minus till√•tet"></div>
      <div><label for="beskrivning">Beskrivning</label><input id="beskrivning" placeholder="Fritext (allt till√•tet)"></div>
    </div>
    <div class="actions" style="margin-top:.6rem">
      <button class="btn primary" id="btnAdd">L√§gg till</button>
      <button class="btn ghost" id="btnCancel" style="display:none">Avbryt</button>
    </div>
  </div>

  <!-- Tabell -->
  <div class="card">
    <table>
      <thead>
        <tr><th>Datum</th><th>Projekt</th><th>Kategori</th><th>Tid</th>
            <th>K√∂rtid</th><th>Beskrivning</th><th>√Ötg√§rd</th></tr>
      </thead>
      <tbody id="rows"></tbody>
      <tfoot><tr><td colspan="7" id="totalsCell">Summering visas h√§r‚Ä¶</td></tr></tfoot>
    </table>
    <div class="small" id="legend" style="margin-top:.5rem">
      <span class="pill blue"><span class="dot"></span>Helg</span>
      <span class="pill rose"><span class="dot"></span>R√∂d dag</span>
      <span class="pill orange"><span class="dot"></span>Vardag &lt; 8h</span>
    </div>
  </div>

  <!-- Larm -->
  <div class="card">
    <strong>Larm & kontroller</strong>
    <div id="alarms" class="small">Inga varningar.</div>
    <div id="alarmsLegend" class="small">
      <div class="legend">
        <span class="pill red"><span class="dot"></span>Saknas</span>
        <span class="pill orange"><span class="dot"></span>Under 8h</span>
        <span class="pill green"><span class="dot"></span>OK</span>
        <span class="pill blue"><span class="dot"></span>Helg</span>
        <span class="pill rose"><span class="dot"></span>R√∂d dag</span>
      </div>
    </div>
  </div>

  <!-- √Örs√∂versikt -->
  <div class="card">
    <strong>√Örs√∂versikt</strong>
    <div id="yearLinks" style="margin:.5rem 0;"></div>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>M√•nad</th><th>Ordinarie</th><th>Semester</th><th>ATF</th><th>Sjuk</th>
            <th>F√∂r√§ldraledig</th><th>VAB</th><th>Flextid</th><th>√ñT&lt;2</th><th>√ñT2&gt;</th>
            <th>√ñT-Helg</th><th>Trakt (st)</th><th>K√∂rtid</th><th>Totalt</th>
          </tr>
        </thead>
        <tbody id="yearBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Hj√§lp / Manual -->
  <div class="card" id="helpSection" style="display:none">
    <div class="section-title">
      <span class="badge">üìò</span>
      <strong>S√• funkar Tidrapport</strong>
    </div>

    <div class="list">
      <div class="row"><div class="ico">üìÖ</div><div><strong>V√§lj datum</strong><br><span class="small">B√∂rja med att v√§lja r√§tt dag.</span></div></div>
      <div class="row"><div class="ico">üè∑Ô∏è</div><div><strong>V√§lj kategori</strong><br><span class="small">Ex: Ordinarie, Flextid, √ñvertid &lt;2, Traktamente.</span></div></div>
      <div class="row"><div class="ico">‚è±Ô∏è</div><div><strong>Fyll i tid</strong><br><span class="small">0,25-steg (0,5=30min). Minus till√•tet.</span></div></div>
      <div class="row"><div class="ico">üöó</div><div><strong>K√∂rtid</strong><br><span class="small">Valfritt. Ocks√• i 0,25-steg.</span></div></div>
      <div class="row"><div class="ico">üì¶</div><div><strong>Projekt</strong><br><span class="small">Endast bokst√§ver/siffror, inga mellanslag.</span></div></div>
      <div class="row"><div class="ico">üìù</div><div><strong>Beskrivning</strong><br><span class="small">Fri text.</span></div></div>
      <div class="row"><div class="ico">‚ûï</div><div><strong>L√§gg till</strong><br><span class="small">Raden hamnar i tabellen. Du kan √§ndra/ta bort.</span></div></div>
      <div class="row"><div class="ico">üìä</div><div><strong>Summering & √•rs√∂versikt</strong><br><span class="small">Totalsummor per m√•nad + √•rs√∂versikt.</span></div></div>
      <div class="row"><div class="ico">‚ö†Ô∏è</div><div><strong>Larm & kontroller</strong><br><span class="small">Varnar om vardagar saknas eller &lt;8h.</span></div></div>
      <div class="row"><div class="ico">üì§</div><div><strong>Export & Dela</strong><br><span class="small">Exportera CSV eller PDF. Skapa .eml-utkast.</span></div></div>
      <div class="row"><div class="ico">‚òÅÔ∏è</div><div><strong>Backup</strong><br><span class="small">Exportera/dela JSON-backup, spara i moln.</span></div></div>
    </div>

    <hr class="sep">
    <div class="callout warn">
      <div class="ico">üí°</div>
      <div><strong>Tips:</strong> Jobbar du p√• flera enheter? L√§s in senaste backup vid byte.</div>
    </div>
    <hr class="sep">
    <div class="callout danger">
      <div class="ico">‚ùó</div>
      <div><strong>Ansvarsfriskrivning:</strong> Du ansvarar sj√§lv f√∂r backuper. Utvecklaren tar inget ansvar vid felhantering.</div>
    </div>
    <div style="margin-top:1rem;text-align:center">
      <button class="btn ghost" onclick="hideHelp()">‚¨ÖÔ∏è Tillbaka</button>
    </div>
  </div>
</main>
<!-- Meny -->
<aside id="menu" aria-hidden="true">
  <div class="menu-head">
    <strong>Meny</strong>
    <button class="hamb" onclick="toggleMenu(false)" aria-label="St√§ng">‚úï</button>
  </div>
  <div class="menu-body">
    <details class="group" open>
      <summary>M√•nad</summary>
      <div class="content">
        <select id="menuMonth" class="select"></select>
        <button class="btn ghost menu-btn" onclick="changeMonth()">Byt m√•nad</button>
      </div>
    </details>

    <details class="group">
      <summary>Inst√§llningar</summary>
      <div class="content">
        <label>F√∂retag<input id="cfgCompany"></label>
        <label>Namn<input id="cfgName" placeholder="F√∂r- och efternamn"></label>
        <label>Anst-Nr<input id="cfgEmp"></label>
        <label>√Ñgar-ID<input id="cfgOwner" placeholder="t.ex. martin, mm, anna-l"></label>
        <label>√Ör<input id="cfgYear" inputmode="numeric" placeholder="t.ex. 2025"></label>
        <label>Extra notering<textarea id="cfgNote"></textarea></label>

        <label style="display:flex;gap:.5rem;align-items:center">
          <input type="checkbox" id="cfgAutoBackup" checked> Automatisk lokal backup
        </label>

        <div class="actions">
          <button class="btn ghost" onclick="quickBackup()">Snabbbackup via Dela</button>
          <button class="btn ghost" onclick="saveSettings()">Spara</button>
          <button class="btn danger" onclick="resetSettings()">Rensa inst√§llningar</button>
          <button class="btn danger" onclick="resetAll()">Rensa all data</button>
        </div>

        <div class="actions">
          <button class="btn ghost" onclick="createYear()">Skapa nytt √•r</button>
          <button class="btn danger" onclick="deleteYear()">Ta bort √•r</button>
        </div>

        <div class="small status info" id="backupStatus">
          <span class="dot"></span>
          <span class="text">Backup: ej konfigurerad</span>
        </div>
      </div>
    </details>

    <details class="group" open>
      <summary>Exportera</summary>
      <div class="content">
        <button class="btn ghost menu-btn" onclick="exportMonthReport()">Export M√•nadsrapport (CSV)</button>
        <button class="btn ghost menu-btn" onclick="exportExcelStyleMonth()">Export Excel-stil ‚Äì m√•nad</button>
        <button class="btn ghost menu-btn" onclick="exportYearReportCombined()">Export √Örsrapport (CSV)</button>
      </div>
    </details>

    <details class="group">
      <summary>Dela</summary>
      <div class="content">
        <button class="btn ghost menu-btn" onclick="shareMonthReport()">Dela ‚Äì M√•nadsrapport (CSV)</button>
        <button class="btn ghost menu-btn" onclick="shareYearReport()">Dela ‚Äì √Örsrapport (CSV)</button>
        <hr class="sep">
        <button class="btn ghost menu-btn" onclick="shareMonthPdfEmail()">Dela som PDF ‚Äì M√•nadsrapport</button>
        <button class="btn ghost menu-btn" onclick="shareYearPdfEmail()">Dela som PDF ‚Äì √Örsrapport</button>
        <hr class="sep">
        <button class="btn ghost menu-btn" onclick="createEmlDraft()">Skapa e-postutkast (.eml)</button>
      </div>
    </details>

    <details class="group">
      <summary>Import / Backup</summary>
      <div class="content">
        <div class="small">CSV: f√∂rsta rad <code>sep=;</code> + rubriker.</div>
        <input type="file" id="fileImport" accept=".csv" onchange="importCSV(event)">
        <div class="small" style="margin-top:.5rem">Backup JSON:</div>
        <button class="btn ghost menu-btn" onclick="exportJSON()">Exportera backup (JSON)</button>
        <input type="file" id="fileJson" accept="application/json" onchange="importJSON(event)">
        <button class="btn ghost menu-btn" onclick="shareJSON()">Dela (mobil) ‚Äì JSON</button>
      </div>
    </details>

    <details class="group">
      <summary>Manual / Hj√§lp</summary>
      <div class="content">
        <button class="btn ghost menu-btn" onclick="showHelp()">Visa manual</button>
      </div>
    </details>

    <div class="small" style="text-align:center">
      <hr class="sep">
      üî® Tillverkad i samarbete med <strong>ChatGPT & Martin Mattsson</strong>
    </div>
  </div>
</aside>
<script>
(()=>{
// ===== Utils & konstanter =====
const monthsSv=["januari","februari","mars","april","maj","juni","juli","augusti","september","oktober","november","december"];
const catKeys=["Ordinarie tid","Semester-tim","ATF-tim","Sjuk-tim","F√∂r√§ldraledig","VAB","Flextid","√ñvertid <2","√ñvertid 2>","√ñvertid-Helg","Traktamente"];
const csvCols=["Datum","Ordinarie tid","K√∂rtid","Projekt nr","Semester-tim","ATF-tim","Sjuk-tim","F√∂r√§ldraledig","VAB","Flextid","√ñvertid <2","√ñvertid 2>","√ñvertid-Helg","Traktamente","Beskrivning"];
const STORAGE="tidrapport_data_v10";
const SETTINGS="tidrapport_settings_v10";
const $=id=>document.getElementById(id);
const cap=s=>s.charAt(0).toUpperCase()+s.slice(1);
const fmt=n=>(Math.round((Number(n)||0)*100)/100).toString().replace(".",",");
const escapeHtml=s=>(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
function ownerPrefix(){ const o=(state.settings.owner||"").trim(); return o? (o.replace(/\s+/g,"_")+"_"):""; }

// ===== State =====
let state={month:(new Date().getMonth()+1), data:load(STORAGE,{}), settings:load(SETTINGS,defSettings())};
function defSettings(){return{company:"",name:"",emp:"",owner:"",year:new Date().getFullYear(),note:"",autoBackup:true,holidays:true}}
function load(k,def){try{const v=JSON.parse(localStorage.getItem(k));return v??def}catch(_){return def}}
function save(){ localStorage.setItem(STORAGE,JSON.stringify(state.data)); touchLocalUpdated(); if($("cfgAutoBackup")?.checked) autoLocalBackup(); updateBackupStatus("aktiv"); }
function saveCfg(){ localStorage.setItem(SETTINGS,JSON.stringify(state.settings)); touchLocalUpdated(); updateBackupStatus("aktiv"); }
function ensureMonth(m){if(!state.data[m]) state.data[m]=[]}

// ===== Manual ‚Äì visa/d√∂lj (definiera TIDIGT) =====
window.showHelp = () => {
  document.querySelectorAll("main > .card").forEach(c => c.style.display="none");
  const help = document.getElementById("helpSection");
  if (help) help.style.display = "block";
  toggleMenu(false);
  scrollTo({ top: 0, behavior: "smooth" });
};
window.hideHelp = () => {
  const help = document.getElementById("helpSection");
  if (help) help.style.display = "none";
  document.querySelectorAll("main > .card").forEach(c => {
    if (c.id !== "helpSection") c.style.display = "block";
  });
  scrollTo({ top: 0, behavior: "smooth" });
};

// ===== Eng√•ngsbanner & f√∂rsta-g√•ngen-hj√§lp =====
window.dismissBanner=()=>{ $("startupBanner")?.style?.setProperty("display","none"); localStorage.setItem("bannerDismissed","1"); };
window.addEventListener("DOMContentLoaded",()=>{
  if(!localStorage.getItem("bannerDismissed")) $("startupBanner")?.style?.setProperty("display","flex");
  // Visa hj√§lpen EN g√•ng: f√∂rsta bes√∂ket => visa, d√§refter aldrig automatiskt
  if(!localStorage.getItem("helpSeenOnce")){
    try{ window.showHelp(); localStorage.setItem("helpSeenOnce","1"); }catch(_){}
  }
});

// ===== Meny =====
window.toggleMenu=(open)=>{const el=$("menu"); if(!el) return; el.classList.toggle("open",open); if(open) initMenu();}
function initMenu(){
  const sel=$("menuMonth"); if(sel){ sel.innerHTML=""; monthsSv.forEach((n,i)=>{const o=document.createElement("option");o.value=i+1;o.textContent=cap(n); if(i+1===state.month) o.selected=true; sel.appendChild(o);});}
  $("cfgCompany").value=state.settings.company||"";
  $("cfgName").value=state.settings.name||"";
  $("cfgEmp").value=state.settings.emp||"";
  $("cfgOwner").value=state.settings.owner||"";
  $("cfgYear").value=state.settings.year||"";
  $("cfgNote").value=state.settings.note||"";
  if($("cfgAutoBackup")) $("cfgAutoBackup").checked = state.settings.autoBackup!==false;
  updateBackupStatus();
}
window.changeMonth=()=>{state.month=Number($("menuMonth").value); renderAll(); toggleMenu(false)}

// ===== Settings =====
window.saveSettings=()=>{
  state.settings.company=$("cfgCompany").value;
  state.settings.name=$("cfgName").value;
  state.settings.emp=$("cfgEmp").value;
  state.settings.owner=$("cfgOwner").value.trim();
  state.settings.year=Number($("cfgYear").value)||new Date().getFullYear();
  state.settings.note=$("cfgNote").value;
  state.settings.autoBackup=$("cfgAutoBackup")?.checked!==false;
  saveCfg(); renderAll();
};
window.resetSettings=()=>{
  if (!confirm("Rensa inst√§llningar?\n\nDetta tar bort F√∂retag, Namn, Anst-Nr, √Ñgar-ID, √Ör och Notering.\nDina inmatade rader p√•verkas inte.")) return;
  state.settings = defSettings();
  saveCfg(); initMenu(); renderAll();
  alert("Inst√§llningarna √§r rensade.");
};
window.resetAll = async ()=>{
  const input = prompt("‚ö†Ô∏è DU √ÑR P√Ö V√ÑG ATT RADERA ALL DATA.\n\nDetta g√•r inte att √•ngra.\n\nSkriv: RADERA ALLT");
  if (input !== "RADERA ALLT") return;
  try{
    const ts = new Date();
    const stamp = ts.getFullYear().toString()+String(ts.getMonth()+1).padStart(2,"0")+String(ts.getDate()).padStart(2,"0")+"_"+String(ts.getHours()).padStart(2,"0")+String(ts.getMinutes()).padStart(2,"0")+String(ts.getSeconds()).padStart(2,"0");
    const preBlob = new Blob([JSON.stringify({version:"v10",updatedAt:Date.now(),settings:state.settings,data:state.data},null,2)], {type:"application/json"});
    dl(`${ownerPrefix()}tidrapport_pre_reset_${stamp}.json`, preBlob);
  }catch(_){}
  state.data = {}; for (let m=1; m<=12; m++) ensureMonth(m);
  save(); renderAll();
  alert("All data rensad. V√§lj g√§rna 'Snabbbackup via Dela' f√∂r att b√∂rja med en ny backup.");
};

// ===== Input helpers =====
function normMinus(s){return (s||"").replace(/[‚Äì‚Äî‚àí]/g,"-")}
function toNumRaw(s){ if(s==null) return NaN; s=normMinus((""+s).replace(/\s+/g,"")).replace(",","."); if(!/^[-]?\d*(\.\d+)?$/.test(s)) return NaN; return s===""?NaN:parseFloat(s); }
function roundQuarter(n){return Math.round(n*4)/4}
function parseHourInput(v,allowEmpty=false){ if(allowEmpty && (v===""||v==null)) return 0; const n=toNumRaw(v); if(isNaN(n)) return NaN; return roundQuarter(n); }
function sanitizeProject(s){ s=(s||"").normalize("NFC").replace(/\s+/g,""); s=s.replace(/[^0-9A-Za-z√Ö√Ñ√ñ√•√§√∂]/g,""); return s; }
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }

// ===== Add/Edit/Delete =====
const btnAdd=$("btnAdd"); const btnCancel=$("btnCancel");
btnAdd?.addEventListener("click", () => {
  const d=$("datum").value; if(!d){ alert("V√§lj datum."); return; }
  const k=$("kategori").value;
  const t=parseHourInput($("tid").value); if(isNaN(t)){ alert("Ogiltig Tid."); return; }
  const p=sanitizeProject($("projekt").value);
  const kt=parseHourInput($("kortid").value,true); if(isNaN(kt)){ alert("Ogiltig K√∂rtid."); return; }
  const b=$("beskrivning").value||"";
  const m=(new Date(d)).getMonth()+1; ensureMonth(m);

  if (editing){
    const list=state.data[editing.month]||[]; const idx=list.findIndex(r=>r._id===editing.id);
    if(idx!==-1){
      list[idx]={...list[idx], datum:d,kategori:k,tid:t,projekt:p,kortid:kt,beskrivning:b};
      if (editing.month!==m){ const row=list.splice(idx,1)[0]; ensureMonth(m); state.data[m].push(row); state.month=m; }
      save();
    }else{ state.data[m].push({_id:uid(), datum:d,kategori:k,tid:t,projekt:p,kortid:kt,beskrivning:b}); save(); }
    exitEditMode(); renderAll();
  } else {
    state.data[m].push({_id:uid(), datum:d,kategori:k,tid:t,projekt:p,kortid:kt,beskrivning:b});
    save(); clearInputs(); state.month=m; renderAll();
  }
});
btnCancel?.addEventListener("click", ()=>{ exitEditMode(); clearInputs(); });
let editing=null;
function enterEditMode(row, month){ editing={id:row._id, month}; btnAdd.textContent="Spara"; btnCancel.style.display=""; }
function exitEditMode(){ editing=null; btnAdd.textContent="L√§gg till"; btnCancel.style.display="none"; }
function clearInputs(){["datum","tid","projekt","kortid","beskrivning"].forEach(id=>$(id).value=""); $("kategori").selectedIndex=0;}

// ===== Helg & r√∂da dagar (Sverige) =====
function easterSunday(y){const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),n=h+l-7*m+114;return new Date(y,Math.floor(n/31)-1,(n%31)+1)}
function addDays(date,days){const d=new Date(date); d.setDate(d.getDate()+days); return d}
function swedishHolidays(y){
  const H=new Map(); const add=(d, name)=>H.set(d.toISOString().slice(0,10),name);
  add(new Date(y,0,1),"Ny√•rsdagen"); add(new Date(y,0,6),"Trettondedag jul"); add(new Date(y,4,1),"F√∂rsta maj");
  add(new Date(y,5,6),"Sveriges nationaldag"); add(new Date(y,11,25),"Juldagen"); add(new Date(y,11,26),"Annandag jul");
  const eas=easterSunday(y); add(addDays(eas,-2),"L√•ngfredagen"); add(addDays(eas,1),"Annandag p√•sk"); add(addDays(eas,39),"Kristi himmelsf√§rdsdag");
  let mid=new Date(y,5,20); while(mid.getDay()!=6) mid=addDays(mid,1); add(mid,"Midsommardagen");
  let saints=new Date(y,9,31); while(saints.getDay()!=6) saints=addDays(saints,1); add(saints,"Alla helgons dag");
  return H;
}

// ===== Render =====
function yearFilter(r){
  const ySel = Number(state.settings.year) || new Date().getFullYear();
  return (new Date(r.datum)).getFullYear() === ySel;
}
function calcMonthTotals(m){
  ensureMonth(m); const res={_kortid:0,"Traktamente":0};
  (state.data[m]||[]).filter(yearFilter).forEach(r=>{
    res[r.kategori]=(res[r.kategori]||0)+Number(r.tid||0);
    res._kortid+=Number(r.kortid||0);
  });
  return res;
}
function renderTable(){
  const m=state.month; ensureMonth(m); const y=state.settings.year;
  $("monthTitle").textContent=`Tidrapport f√∂r ${cap(monthsSv[m-1])} ${y}`;
  const tb=$("rows"); tb.innerHTML="";
  const rows=[...(state.data[m]||[]).filter(yearFilter)].sort((a,b)=>a.datum.localeCompare(b.datum));
  const daySum={}; rows.forEach(r=>{daySum[r.datum]=(daySum[r.datum]||0)+Number(r.tid||0)});
  const H= state.settings.holidays!==false ? swedishHolidays(y) : new Map();

  rows.forEach((r,i)=>{
    const tr=document.createElement("tr");
    const d=new Date(r.datum); const dow=d.getDay(); const iso=r.datum;
    const isWeekend=(dow===0||dow===6); const isHoliday= H.has(iso);
    if(isWeekend) tr.classList.add("weekend");
    if(isHoliday) tr.classList.add("holiday");
    if(!isWeekend && !isHoliday && (daySum[r.datum]||0)<8) tr.classList.add("warn");
    const hname=isHoliday?` <span class="pill rose"><span class="dot"></span>${H.get(iso)}</span>`:"";
    tr.innerHTML=`<td>${r.datum}${hname}</td><td>${escapeHtml(r.projekt||"")}</td><td>${r.kategori}</td>
      <td>${fmt(r.tid)}</td><td>${fmt(r.kortid)}</td><td>${escapeHtml(r.beskrivning||"")}</td>
      <td class="actions"><button class="btn ghost" onclick="APP.edit(${m},${i})">√Ñndra</button>
      <button class="btn danger" onclick="APP.del(${m},${i})">Ta bort</button></td>`;
    tb.appendChild(tr);
  });

  const t=calcMonthTotals(m);
  $("totalsCell").textContent=
    `Summering ‚Äî Ordinarie: ${fmt(t["Ordinarie tid"]||0)} | Semester: ${fmt(t["Semester-tim"]||0)} | ATF: ${fmt(t["ATF-tim"]||0)} | `+
    `Sjuk: ${fmt(t["Sjuk-tim"]||0)} | F√∂r√§ldraledig: ${fmt(t["F√∂r√§ldraledig"]||0)} | VAB: ${fmt(t["VAB"]||0)} | Flextid: ${fmt(t["Flextid"]||0)} | `+
    `√ñT<2: ${fmt(t["√ñvertid <2"]||0)} | √ñT2>: ${fmt(t["√ñvertid 2>"]||0)} | √ñT-Helg: ${fmt(t["√ñvertid-Helg"]||0)} | Traktamente (st): ${fmt(t["Traktamente"]||0)} | `+
    `K√∂rtid: ${fmt(t._kortid||0)}`;

  renderYear(); renderAlarms(); initMenu();
}
function renderYear(){
  const tb=$("yearBody"); tb.innerHTML="";
  for(let m=1;m<=12;m++){
    const t=calcMonthTotals(m);
    const tot=catKeys.reduce((a,k)=>a+(t[k]||0),0);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${cap(monthsSv[m-1])}</td>
      <td>${fmt(t["Ordinarie tid"]||0)}</td><td>${fmt(t["Semester-tim"]||0)}</td><td>${fmt(t["ATF-tim"]||0)}</td>
      <td>${fmt(t["Sjuk-tim"]||0)}</td><td>${fmt(t["F√∂r√§ldraledig"]||0)}</td><td>${fmt(t["VAB"]||0)}</td><td>${fmt(t["Flextid"]||0)}</td>
      <td>${fmt(t["√ñvertid <2"]||0)}</td><td>${fmt(t["√ñvertid 2>"]||0)}</td><td>${fmt(t["√ñvertid-Helg"]||0)}</td>
      <td>${fmt(t["Traktamente"]||0)}</td><td>${fmt(t._kortid||0)}</td><td>${fmt(tot)}</td>`;
    tb.appendChild(tr);
  }
  const yl=$("yearLinks"); yl.innerHTML="";
  monthsSv.forEach((n,i)=>{const b=document.createElement("button"); b.className="btn ghost"; b.style.marginRight=".4rem";
    b.textContent=cap(n); b.onclick=()=>{state.month=i+1; renderAll(); scrollTo({top:0,behavior:"smooth"});}; yl.appendChild(b);});
}
function renderAlarms(){
  const m=state.month; ensureMonth(m);
  const y=state.settings.year||new Date().getFullYear();
  const H = state.settings.holidays!==false ? swedishHolidays(y) : new Map();

  const map={};
  (state.data[m]||[]).filter(yearFilter).forEach(r=>{ const d=r.datum; map[d]=(map[d]||0)+Number(r.tid||0); });

  const last=new Date(y,m,0).getDate();
  const lines=[];
  for(let d=1; d<=last; d++){
    const iso=`${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const dow=new Date(iso).getDay();
    const isWeekend=(dow===0||dow===6);
    const isHoliday=H.has(iso);
    const sum=map[iso]||0;

    let cls="", label="";
    if(isHoliday){ cls="rose"; label=`R√∂d dag (${H.get(iso)})`; }
    else if(isWeekend){ cls="blue"; label="Helg"; }
    else if(map[iso]==null){ cls="red"; label="Saknas"; }
    else if(sum<8){ cls="orange"; label=`Under 8h (${fmt(sum)}h)`; }
    else { cls="green"; label=`OK (${fmt(sum)}h)`; }

    const extra = (isWeekend||isHoliday) ? (sum>0 ? ` ‚Äî ${fmt(sum)}h registrerat` : "") : "";
    lines.push(`<div class="pill ${cls}"><span class="dot"></span><span>${iso} ‚Äî ${label}${extra}</span></div>`);
  }

  $("alarms").innerHTML = lines.length ? `<div class="pills">${lines.join("")}</div>` : "Inga varningar f√∂r denna m√•nad.";
}
function renderAll(){renderTable()}

// ===== CSV helpers (kombinerad export) =====
const FILL_ZERO=false;
const csvEscape=s=>{s=s==null?"":String(s).replace(/\r?\n/g," "); if(/[";]/.test(s)) s='"'+s.replace(/"/g,'""')+'"'; return s;}
function csvHeaderRow(){return csvCols.join(";")}
function sortedRows(months){
  const out=[]; months.forEach(m=>{ensureMonth(m); (state.data[m]||[]).filter(yearFilter).forEach(r=>out.push({...r,_m:m}))});
  out.sort((a,b)=>{const c=a.datum.localeCompare(b.datum); if(c) return c; const p=(a.projekt||"").localeCompare(b.projekt||""); if(p) return p; return (a.kategori||"").localeCompare(b.kategori||"");});
  return out;
}
function headerInfo(scope){
  const y=state.settings.year, m=state.month;
  const parts=["sep=;","Tidrapport;;;;",`F√∂retag;${state.settings.company||""};;;;`,`Namn;${state.settings.name||""};;;;`,`Anst-Nr;${state.settings.emp||""};;;;`];
  if(state.settings.owner) parts.push(`√Ñgar-ID;${state.settings.owner};;;;`);
  parts.push(`√Ör;${y};;;;`);
  if(scope==="month") parts.push(`M√•nad;${cap(monthsSv[m-1])};;;;`);
  if(state.settings.note && state.settings.note.trim()) parts.push(`Notering;${state.settings.note.replace(/\r?\n/g," ")}`);
  parts.push(""); return parts.join("\r\n");
}
function buildRowsSection(scope){
  const months = scope==="year" ? Array.from({length:12},(_,i)=>i+1) : [state.month];
  const lines=[`### RADER (${scope==="year"?"√•r":"m√•nad"})`, csvHeaderRow()];
  sortedRows(months).forEach(r=>{
    const cat=r.kategori||"";
    const val=want=> (cat===want ? fmt(r.tid) : (FILL_ZERO ? "0" : ""));
    const row=[r.datum,val("Ordinarie tid"),fmt(r.kortid||0),csvEscape(r.projekt||""),val("Semester-tim"),val("ATF-tim"),val("Sjuk-tim"),val("F√∂r√§ldraledig"),val("VAB"),val("Flextid"),val("√ñvertid <2"),val("√ñvertid 2>"),val("√ñvertid-Helg"),val("Traktamente"),csvEscape(r.beskrivning||"")];
    lines.push(row.join(";"));
  });
  lines.push(""); return lines.join("\r\n");
}
function groupByProject(months){
  const map={};
  months.forEach(m=>{ensureMonth(m); (state.data[m]||[]).filter(yearFilter).forEach(r=>{const key=r.projekt||"(tomt)"; const cat=r.kategori||""; map[key]??={_kortid:0}; map[key]._kortid+=Number(r.kortid||0); map[key][cat]=(map[key][cat]||0)+Number(r.tid||0);});});
  return map;
}
function buildProjectSection(scope){
  const months = scope==="year" ? Array.from({length:12},(_,i)=>i+1) : [state.month];
  const y=state.settings.year, m=String(state.month).padStart(2,"0");
  const lines=[`### SUMMERING PER PROJEKT (${scope==="year"?"√•r":"m√•nad"})`, csvHeaderRow()];
  const g=groupByProject(months);
  Object.keys(g).sort().forEach(p=>{
    const o=g[p]; const datum=scope==="year" ? `${y}-01-01` : `${y}-${m}-01`;
    const row=[datum, fmt(o["Ordinarie tid"]||0), fmt(o._kortid||0), csvEscape(p), fmt(o["Semester-tim"]||0),fmt(o["ATF-tim"]||0),fmt(o["Sjuk-tim"]||0),fmt(o["F√∂r√§ldraledig"]||0),fmt(o["VAB"]||0),fmt(o["Flextid"]||0),fmt(o["√ñvertid <2"]||0),fmt(o["√ñvertid 2>"]||0),fmt(o["√ñvertid-Helg"]||0),fmt(o["Traktamente"]||0),"Summerat per projekt"];
    lines.push(row.join(";"));
  });
  return lines.join("\r\n");
}
function buildCombinedCsv(scope){ return headerInfo(scope) + buildRowsSection(scope) + buildProjectSection(scope); }

// ----- Blob helpers -----
function makeBlobCSV(text, encoding){
  if(encoding==='utf8'){ const BOM=new Uint8Array([0xEF,0xBB,0xBF]); return new Blob([BOM, text.normalize("NFC")], {type:"text/csv;charset=utf-8"}); }
  const s=(text||"").normalize("NFC"); const bom=new Uint8Array([0xFF,0xFE]); const buf=new Uint8Array(bom.length + s.length*2);
  bom.forEach((b,i)=>buf[i]=b); for(let i=0;i<s.length;i++){const code=s.charCodeAt(i); buf[bom.length+i*2]=code&0xFF; buf[bom.length+i*2+1]=(code>>8)&0xFF;}
  return new Blob([buf],{type:"text/csv;charset=utf-16le"});
}
function dl(name,blob){const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500)}

// ===== Export / Dela (CSV) =====
window.exportMonthReport=()=>{ const text=buildCombinedCsv("month"); const y=state.settings.year, m=String(state.month).padStart(2,"0"); dl(`${ownerPrefix()}tidrapport_${y}_${m}_manadsrapport.csv`, makeBlobCSV(text,'utf16')); };
window.exportYearReportCombined=()=>{ const text=buildCombinedCsv("year"); const y=state.settings.year; dl(`${ownerPrefix()}tidrapport_${y}_arsrapport.csv`, makeBlobCSV(text,'utf16')); };
async function tryShareOrDownload(filename, blob, title){
  if (navigator.canShare && navigator.canShare({files:[new File([blob], filename, {type: blob.type})]})) {
    try {
      const file = new File([blob], filename, {type: blob.type});
      await navigator.share({title, files:[file]});
      return true;
    } catch (e) {}
  }
  dl(filename, blob);
  alert("Delning st√∂ds inte h√§r ‚Äì filen laddades ner ist√§llet.");
  return false;
}
window.shareMonthReport=async()=>{ const text=buildCombinedCsv("month"); const y=state.settings.year, m=String(state.month).padStart(2,"0"); await tryShareOrDownload(`${ownerPrefix()}Tidrapport_${y}_${m}_manadsrapport.csv`, makeBlobCSV(text,'utf8'), "Tidrapport ‚Äì M√•nadsrapport"); };
window.shareYearReport=async()=>{ const text=buildCombinedCsv("year"); const y=state.settings.year; await tryShareOrDownload(`${ownerPrefix()}Tidrapport_${y}_arsrapport.csv`, makeBlobCSV(text,'utf8'), "Tidrapport ‚Äì √Örsrapport"); };

// ===== PDF (jsPDF) =====
function makePdfReport(scope){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"a4"});
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 40;
  const lineH = 14;
  const mono = "Courier";
  const yStart = margin + 8;
  let y = yStart;
  const yNewPage = () => { doc.addPage(); y = yStart; };
  const write = (txt) => {
    const lines = doc.splitTextToSize(txt, pageW - margin*2);
    lines.forEach(line=>{
      if (y > pageH - margin) yNewPage();
      doc.text(line, margin, y); y += lineH;
    });
  };
  const rule = () => { if (y > pageH - margin) yNewPage(); doc.setDrawColor(180); doc.line(margin, y, pageW-margin, y); y += 8; };
  const ySel = state.settings.year;
  const mIdx = state.month-1;
  const title = scope==="year" ? `√Örsrapport ${ySel}` : `M√•nadsrapport ${cap(monthsSv[mIdx])} ${ySel}`;
  const meta = [
    `F√∂retag: ${state.settings.company||"-"}`,
    `Namn: ${state.settings.name||"-"}   Anst-Nr: ${state.settings.emp||"-"}`,
    state.settings.owner ? `√Ñgar-ID: ${state.settings.owner}` : null,
    `Notering: ${state.settings.note ? state.settings.note.replace(/\r?\n/g," ") : "-"}`
  ].filter(Boolean);
  doc.setFont(mono, "bold"); doc.setFontSize(14);
  write(`Tidrapport ‚Äì ${title}`);
  doc.setFont(mono, "normal"); doc.setFontSize(10);
  meta.forEach(m=>write(m));
  rule();
  doc.setFont(mono,"bold"); write(`RADER (${scope==="year"?"√•r":"m√•nad"})`);
  doc.setFont(mono,"normal");
  const cols = [
    { k:"Datum", w:90 },{ k:"Ord", w:50 },{ k:"K√∂rt", w:50 },{ k:"Projekt", w:110 },
    { k:"Sem", w:40 },{ k:"ATF", w:40 },{ k:"Sjuk", w:45 },{ k:"F√∂r√§ld", w:55 },
    { k:"VAB", w:40 },{ k:"Flex", w:45 },{ k:"√ñT<2", w:45 },{ k:"√ñT2>", w:45 },
    { k:"Helg", w:45 },{ k:"Trakt", w:45 },
  ];
  const months = scope==="year" ? Array.from({length:12},(_,i)=>i+1) : [state.month];
  const rows = sortedRows(months).map(r=>{
    const cat = r.kategori||"";
    const val = want => (cat===want ? fmt(r.tid) : "");
    return [r.datum, val("Ordinarie tid"), fmt(r.kortid||0), (r.projekt||""), val("Semester-tim"), val("ATF-tim"), val("Sjuk-tim"), val("F√∂r√§ldraledig"), val("VAB"), val("Flextid"), val("√ñvertid <2"), val("√ñvertid 2>"), val("√ñvertid-Helg"), val("Traktamente")];
  });
  const headerLine = cols.map(c=>c.k.padEnd(Math.floor(c.w/7))).join("");
  doc.setFont(mono,"bold"); write(headerLine); doc.setFont(mono,"normal");
  rule();
  rows.forEach(r=>{
    const wrappedColumns = r.map((cell, i)=>{
      const widthPx = cols[i].w;
      const chars = Math.max(1, Math.floor(widthPx/7));
      const chunks=[];
      const s=String(cell||"");
      for(let idx=0; idx<s.length; idx+=chars) chunks.push(s.slice(idx, idx+chars));
      return chunks.length?chunks:[""];
    });
    const maxLines = wrappedColumns.reduce((m,arr)=>Math.max(m,arr.length), 1);
    for(let li=0; li<maxLines; li++){
      if (y > pageH - margin) yNewPage();
      let x = margin;
      wrappedColumns.forEach((arr,i)=>{
        const text = (arr[li]||"").padEnd(Math.floor(cols[i].w/7));
        doc.text(text, x, y);
        x += cols[i].w;
      });
      y += lineH;
    }
  });
  rule();
  doc.setFont(mono,"bold"); write(`SUMMERING PER PROJEKT (${scope==="year"?"√•r":"m√•nad"})`);
  doc.setFont(mono,"normal");
  const g = groupByProject(months);
  const projRows = Object.keys(g).sort().map(p=>{
    const o=g[p];
    return [p, fmt(o["Ordinarie tid"]||0), fmt(o._kortid||0), fmt(o["Semester-tim"]||0),fmt(o["ATF-tim"]||0),fmt(o["Sjuk-tim"]||0),fmt(o["F√∂r√§ldraledig"]||0), fmt(o["VAB"]||0),fmt(o["Flextid"]||0),fmt(o["√ñvertid <2"]||0),fmt(o["√ñvertid 2>"]||0), fmt(o["√ñvertid-Helg"]||0),fmt(o["Traktamente"]||0)];
  });
  const pCols = [
    {k:"Projekt", w:160},{k:"Ord",w:50},{k:"K√∂rt",w:50},{k:"Sem",w:40},{k:"ATF",w:40},
    {k:"Sjuk",w:45},{k:"F√∂r√§ld",w:55},{k:"VAB",w:40},{k:"Flex",w:45},{k:"√ñT<2",w:45},
    {k:"√ñT2>",w:45},{k:"Helg",w:45},{k:"Trakt",w:45}
  ];
  const pHeader = pCols.map(c=>c.k.padEnd(Math.floor(c.w/7))).join("");
  doc.setFont(mono,"bold"); write(pHeader); doc.setFont(mono,"normal"); rule();
  projRows.forEach(r=>{
    const proj = String(r[0]||"");
    const widthPx = pCols[0].w, chars = Math.max(1, Math.floor(widthPx/7));
    const projLines=[]; for(let i=0;i<proj.length;i+=chars) projLines.push(proj.slice(i,i+chars));
    const maxLines = Math.max(1, projLines.length);
    for(let li=0; li<maxLines; li++){
      if (y > pageH - margin) yNewPage();
      let x = margin;
      doc.text((projLines[li]||"").padEnd(Math.floor(pCols[0].w/7)), x, y);
      x += pCols[0].w;
      for(let ci=1; ci<r.length; ci++){
        const text = String(r[ci]||"").padEnd(Math.floor(pCols[ci].w/7));
        doc.text(text, x, y);
        x += pCols[ci].w;
      }
      y += lineH;
    }
  });
  if (y > pageH - margin) yNewPage();
  doc.setFontSize(8); doc.setTextColor(110);
  const stamp = new Date().toLocaleString();
  doc.text(`Genererad: ${stamp}`, margin, pageH - margin);
  return doc.output("blob");
}
async function sharePdfCommon(scope){
  const y = state.settings.year, m = String(state.month).padStart(2,"0");
  const prefix = ownerPrefix();
  const name = scope==="year" ? `${prefix}Tidrapport_${y}_arsrapport.pdf` : `${prefix}Tidrapport_${y}_${m}_manadsrapport.pdf`;
  const blob = makePdfReport(scope);
  if (navigator.canShare && navigator.canShare({files:[new File([blob], name, {type:"application/pdf"})]})) {
    try {
      await navigator.share({ title: scope==="year" ? "Tidrapport ‚Äì √Örsrapport (PDF)" : "Tidrapport ‚Äì M√•nadsrapport (PDF)", files: [new File([blob], name, {type:"application/pdf"})] });
      return;
    } catch(e) {}
  }
  dl(name, blob);
  alert("Delning till mail st√∂ds inte h√§r ‚Äì PDF:en laddades ner ist√§llet.");
}
window.shareMonthPdfEmail = ()=> sharePdfCommon("month");
window.shareYearPdfEmail  = ()=> sharePdfCommon("year");

// ===== Excel-stil (m√•nad) =====
window.exportExcelStyleMonth=()=>{
  const m=state.month, y=state.settings.year, T=calcMonthTotals(m);
  const head=[headerInfo("month"), `Totalt:;Ordinarie ${fmt(T["Ordinarie tid"]||0)} h;K√∂rtid ${fmt(T._kortid||0)} h;Semester ${fmt(T["Semester-tim"]||0)} h;Flextid ${fmt(T["Flextid"]||0)} h`, ""].join("\r\n");
  const body=buildRowsSection("month").replace(/^###.*\r?\n/,'');
  dl(`${ownerPrefix()}tidrapport_${y}_${String(m).padStart(2,"0")}_excelstil.csv`, makeBlobCSV(head+body,'utf16'));
};

// ===== Backup: Automatisk lokal backup + snabb delning =====
function touchLocalUpdated(){ localStorage.setItem("tidrapport_local_updated", String(Date.now())); }
function jsonPayload(){ return {version:"v10", updatedAt: Date.now(), settings: state.settings, data: state.data}; }
function jsonBlob(){ return new Blob([JSON.stringify(jsonPayload(),null,2)],{type:"application/json"}); }
function autoLocalBackup(){
  try{
    const y=state.settings.year, m=String(state.month).padStart(2,"0");
    const name = `${ownerPrefix()}tidrapport_backup_${y}_${m}.json`;
    dl(name, jsonBlob());
    updateBackupStatus("aktiv ‚Äì lokal backup skapad");
  }catch(_){
    updateBackupStatus("ej sparad");
  }
}
function updateBackupStatus(msg){
  const wrap=$("backupStatus"); if(!wrap) return;
  const owner=(state.settings.owner||"").trim();
  const text="Backup: " + (msg || "aktiv");
  const txt = wrap.querySelector(".text"); if (txt) txt.textContent = owner? (text+` ‚Äî √§gare: ${owner}`):text;
  wrap.classList.remove("ok","warn","info");
  if (text.includes("aktiv")||text.includes("skapad")) wrap.classList.add("ok");
  else if (text.includes("ej")) wrap.classList.add("warn");
  else wrap.classList.add("info");
}
window.quickBackup=async ()=>{
  const y=state.settings.year, m=String(state.month).padStart(2,"0");
  const name = `${ownerPrefix()}tidrapport_backup_${y}_${m}.json`;
  const blob = jsonBlob();
  if(navigator.canShare && navigator.canShare({files:[new File([blob],name,{type:"application/json"})]})){
    try{ await navigator.share({title:"Tidrapport-backup", files:[new File([blob],name,{type:"application/json"})]}); updateBackupStatus("aktiv ‚Äì delad"); return; }catch(_){}
  }
  dl(name, blob); updateBackupStatus("aktiv ‚Äì nedladdad");
};

// ===== Import/Backup JSON =====
window.exportJSON=()=>{ const y=state.settings.year, m=String(state.month).padStart(2,"0"); dl(`${ownerPrefix()}tidrapport_backup_${y}_${m}.json`, jsonBlob()); }
window.importJSON=async(ev)=>{
  const f=ev.target.files?.[0]; if(!f) return;
  try{
    const text=await f.text(); const obj=JSON.parse(text);
    if(!obj || typeof obj!=='object' || !obj.data){alert("Ogiltig backupfil."); return;}
    state.data=obj.data; if(obj.settings) state.settings=obj.settings;
    save(); saveCfg(); renderAll(); alert("Backup √•terst√§lld.");
  }catch(e){ alert("Kunde inte l√§sa backup: "+e.message); }
  ev.target.value="";
}
window.shareJSON=async()=>{
  const y=state.settings.year, m=String(state.month).padStart(2,"0");
  const name=`${ownerPrefix()}tidrapport_backup_${y}_${m}.json`;
  const blob=jsonBlob();
  if(navigator.canShare && navigator.canShare({files:[new File([blob],name,{type:blob.type})]})){
    try{await navigator.share({title:"Tidrapport-backup",files:[new File([blob],name,{type:blob.type})]});}catch(_){}
  }else{ dl(name, blob); alert("Delning st√∂ds inte ‚Äì filen laddades ner ist√§llet."); }
}

// ===== CSV-import (st√∂djer kombinerad export) =====
window.importCSV = async (ev) => {
  const f = ev.target.files?.[0]; if (!f) return;
  const text = await f.text();
  let lines = text.replace(/^\uFEFF/, "").split(/\r?\n/).map(s => s.trimEnd());
  if (!lines.length) { alert("Filen √§r tom."); ev.target.value=""; return; }
  const wantedHeader = ["Datum","Ordinarie tid","K√∂rtid","Projekt nr","Semester-tim","ATF-tim","Sjuk-tim","F√∂r√§ldraledig","VAB","Flextid","√ñvertid <2","√ñvertid 2>","√ñvertid-Helg","Traktamente","Beskrivning"];
  let headerIdx = -1;
  for (let i = 0; i < lines.length; i++) {
    const raw = lines[i].trim();
    if (!raw || /^sep=;$/i.test(raw) || raw.startsWith("###")) continue;
    const parts = raw.split(";");
    if (parts.length >= wantedHeader.length) {
      const normalized = parts.slice(0, wantedHeader.length).map(s => s.replace(/(^"|"$)/g,"").trim());
      const match = wantedHeader.every((h, idx) => (normalized[idx]||"").toLowerCase() === h.toLowerCase());
      if (match) { headerIdx = i; break; }
    }
  }
  if (headerIdx === -1) { alert("Hittade ingen tabell med f√∂rv√§ntade kolumner."); ev.target.value=""; return; }
  const dataLines = [];
  for (let i = headerIdx + 1; i < lines.length; i++) {
    const L = lines[i];
    if (!L || L.startsWith("###")) break;
    dataLines.push(L);
  }
  const parseCSVLine = (line) => {
    const cols = []; let cur = "", q = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (q && line[i+1] === '"') { cur += '"'; i++; }
        else { q = !q; }
      } else if (ch === ';' && !q) {
        cols.push(cur); cur = "";
      } else {
        cur += ch;
      }
    }
    cols.push(cur);
    return cols;
  };
  const header = parseCSVLine(lines[headerIdx]).map(s => s.replace(/(^"|"$)/g,""));
  const idxName = n => header.findIndex(h => h.trim().toLowerCase() === n.trim().toLowerCase());
  const miss = wantedHeader.filter(c => idxName(c) === -1);
  if (miss.length) { alert("Importfel: saknar kolumner: " + miss.join(", ")); ev.target.value=""; return; }
  let count = 0;
  dataLines.forEach(line => {
    const cols = parseCSVLine(line);
    const d = (cols[idxName("Datum")]||"").trim();
    if (!d) return;
    const m = (new Date(d)).getMonth() + 1;
    if (!state.data[m]) state.data[m] = [];
    const proj = (cols[idxName("Projekt nr")]||"").replace(/(^"|"$)/g,"");
    const toNumRawLocal = (s) => {
      if (s == null) return NaN;
      s = String(s).replace(/\s+/g,"").replace(",",".").replace(/[‚Äì‚Äî‚àí]/g,"-");
      if (!/^[-]?\d*(\.\d+)?$/.test(s)) return NaN;
      return s === "" ? NaN : parseFloat(s);
    };
    const kort = toNumRawLocal(cols[idxName("K√∂rtid")]);
    const desc = (cols[idxName("Beskrivning")]||"").replace(/(^"|"$)/g,"").replace(/""/g,'"');
    const categories = ["Ordinarie tid","Semester-tim","ATF-tim","Sjuk-tim","F√∂r√§ldraledig","VAB","Flextid","√ñvertid <2","√ñvertid 2>","√ñvertid-Helg","Traktamente"];
    categories.forEach(cat => {
      const v = toNumRawLocal(cols[idxName(cat)]);
      if (!isNaN(v) && v !== 0) {
        state.data[m].push({
          _id: uid(),
          datum: d,
          kategori: cat,
          tid: v,
          projekt: sanitizeProject(proj),
          kortid: isNaN(kort) ? 0 : kort,
          beskrivning: desc
        });
        count++;
      }
    });
  });
  save(); renderAll();
  alert("Importerade rader: " + count);
  ev.target.value = "";
};

// ===== Publika app-actions =====
window.APP={
  edit:(m, idx)=>{
    const r=state.data[m][idx];
    $("datum").value=r.datum; $("kategori").value=r.kategori;
    $("tid").value=(r.tid??0).toString().replace(".",",");
    $("projekt").value=r.projekt||""; $("kortid").value=(r.kortid??0).toString().replace(".",",");
    $("beskrivning").value=r.beskrivning||"";
    enterEditMode(r, m);
    scrollTo({top:0,behavior:"smooth"});
  },
  del:(m, idx)=>{
    const r=state.data[m][idx];
    const msg=`Vill du verkligen radera raden?\n\nDatum: ${r.datum}\nProjekt: ${r.projekt||"-"}\nKategori: ${r.kategori}\nTid: ${fmt(r.tid)} h\nK√∂rtid: ${fmt(r.kortid)} h`;
    if(!confirm(msg)) return;
    state.data[m].splice(idx,1); save();
    if(editing && editing.id===r._id) exitEditMode();
    renderAll();
  }
};

// ===== √Örshantering =====
window.createYear = () => {
  const current = Number(state.settings.year) || new Date().getFullYear();
  const suggested = current + 1;
  const val = prompt("Skapa nytt √•r. Ange √•rtal:", String(suggested));
  const y = Number(val);
  if (!y || y < 2000 || y > 2100) return;
  state.settings.year = y;
  saveCfg();
  for (let m=1; m<=12; m++) ensureMonth(m);
  renderAll();
  alert(`√Öret ${y} √§r aktiverat. Du kan nu b√∂rja registrera p√• ${y}.`);
};
window.deleteYear = async () => {
  const y = Number(state.settings.year) || new Date().getFullYear();
  const okExport = confirm("Vill du f√∂rst exportera en √Örsrapport (CSV) f√∂r det h√§r √•ret innan radering?");
  if (okExport && typeof exportYearReportCombined === "function") exportYearReportCombined();
  const confirmText = prompt(`‚ö†Ô∏è Du √§r p√• v√§g att ta bort ALLA rader f√∂r √•r ${y}.\nDetta g√•r inte att √•ngra.\n\nSkriv exakt: ${y}`);
  if (String(confirmText) !== String(y)) return;
  let removed = 0;
  for (let m=1; m<=12; m++) {
    ensureMonth(m);
    const before = state.data[m].length;
    state.data[m] = state.data[m].filter(r => (new Date(r.datum)).getFullYear() !== y);
    removed += (before - state.data[m].length);
  }
  save(); renderAll();
  alert(`Borttagning klar. Rader raderade f√∂r ${y}: ${removed}.`);
};

// ===== Boot =====
for(let m=1;m<=12;m++) ensureMonth(m);
renderAll();
})();
</script>
</body>
</html>